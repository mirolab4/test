<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>شجرة العائلة - لوحة التحكم</title>
<style>
  /* تضمين كل أكواد CSS هنا */
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f2f5;
    margin: 0; padding: 15px;
    direction: rtl;
    line-height: 1.6;
  }
  h1 {
    text-align: center; color: #333;
    font-size: 24px;
    margin-bottom: 20px;
  }
  .section-container {
    background-color: #fff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .search, .owner-filter, .add-form, .import-vcf, .date-filter, .export-section, .tags-filter {
    text-align: center;
  }
  input[type="text"], input[type="file"], select, input[type="date"] {
    width: calc(100% - 20px);
    max-width: 350px;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc; border-radius: 5px;
    font-size: 15px;
    box-sizing: border-box;
  }
  input[type="date"] {
    width: calc(50% - 15px);
    max-width: 170px;
  }
  button, .call-btn, .wa-btn, .view-details-btn {
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
    margin: 5px;
    border: none; border-radius: 5px;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.2s;
    width: auto;
    display: inline-block;
  }
  button:hover, .call-btn:hover, .wa-btn:hover, .view-details-btn:hover {
    background-color: #0056b3;
  }
  .add-form button { background-color: #28a745; }
  .add-form button:hover { background-color: #218838; }

  .edit-btn { background-color: #ffc107; color: white; }
  .edit-btn:hover { background-color: #e0a800; }
  .delete-btn { background-color: #dc3545; color: white; }
  .delete-btn:hover { background-color: #c82333; }
  .copy-btn { background-color: #6c757d; color: white; }
  .copy-btn:hover { background-color: #5a6268; }
  .call-btn { background-color: #17a2b8; }
  .call-btn:hover { background-color: #138496; }
  .wa-btn { background-color: #25D366; }
  .wa-btn:hover { background-color: #1eaf53; }
  .export-section button { background-color: #1abc9c; }
  .export-section button:hover { background-color: #148f77; }
  .view-details-btn { background-color: #6f42c1; }
  .view-details-btn:hover { background-color: #5d34a4; }

  .stats-bar {
    text-align: center;
    margin-bottom: 15px;
    font-size: 16px;
    color: #555;
  }
  .delete-selected-container {
    text-align: center;
    margin-top: 10px;
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .hidden { display: none !important; } /* Added !important for stronger override */

  .table-scroll-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    margin-top: 0;
    box-shadow: none;
    border: none;
  }
  table th, table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
    font-size: 14px;
  }
  table th {
    background-color: #007bff;
    color: white;
    cursor: pointer;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  table th:first-child,
  table td:first-child {
    border-right: none;
  }
  table td input[type="text"] {
    width: calc(100% - 10px);
    padding: 5px;
    margin: 0;
    font-size: 14px;
    border: 1px solid #eee;
  }
  table td input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  /* Multi-select dropdown styles (for owner and tags) */
  .multi-select-dropdown {
    width: calc(100% - 20px);
    max-width: 350px;
    margin: 8px auto;
    position: relative;
    text-align: right; /* Adjusted for RTL */
  }
  .multi-select-dropdown .selected-items {
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 5px;
    background-color: #fff;
    cursor: pointer;
    min-height: 38px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: flex-end; /* Align items to right for RTL */
  }
  .multi-select-dropdown .selected-items.active {
    border-color: #007bff;
  }
  .multi-select-dropdown .selected-item {
    background-color: #e9e9e9;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .multi-select-dropdown .selected-item .remove-item {
    cursor: pointer;
    font-weight: bold;
    color: #888;
  }
  .multi-select-dropdown .options-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 5px 5px;
    background-color: #fff;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: right; /* Aligned to right for RTL */
  }
  .multi-select-dropdown .option {
    padding: 10px;
    cursor: pointer;
    font-size: 15px;
  }
  .multi-select-dropdown .option:hover {
    background-color: #f0f0f0;
  }
  .multi-select-dropdown .option.selected {
    background-color: #e0f0ff;
    font-weight: bold;
  }
  .multi-select-dropdown.active .options-container {
    display: block;
  }

  /* Loading Overlay Styles */
  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
    font-size: 20px;
  }
  .loading-overlay.hidden {
    display: none;
  }
  /* Simple spinner */
  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid #fff;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast Notifications Styles */
  #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }
  .toast {
    background-color: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    opacity: 0;
    animation: fadeInOut 4s forwards;
    min-width: 200px;
    text-align: center;
  }
  .toast.success { background-color: #28a745; }
  .toast.error { background-color: #dc3545; }
  .toast.info { background-color: #17a2b8; }

  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
  }

  /* Bulk Edit Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
  }
  .close-button {
    color: #aaa;
    float: left; /* Changed from right to left for RTL */
    font-size: 28px;
    font-weight: bold;
  }
  .close-button:hover,
  .close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  .modal-content label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
  }
  .modal-content select, .modal-content input[type="text"] {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .modal-content button {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .modal-content button:hover {
    background-color: #0056b3;
  }


  /* Responsive Design for smaller screens */
  @media (max-width: 768px) {
    body { padding: 10px; }
    h1 { font-size: 20px; }
    .section-container { padding: 10px; }
    input[type="text"], input[type="file"], select {
      width: calc(100% - 16px);
      font-size: 14px;
      margin: 6px 0;
    }
    input[type="date"] {
      width: calc(100% - 16px);
      margin: 6px 0;
    }
    button, .call-btn, .wa-btn, .view-details-btn {
      padding: 8px 12px;
      font-size: 14px;
      margin: 4px;
    }
    .table-scroll-container {
      max-height: 80vh;
      margin: 10px 0;
      box-shadow: none;
      border: none;
    }
    table, thead, tbody, th, td, tr {
      display: block;
      width: 100%;
    }
    thead tr {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    tbody tr {
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background: #fff;
      padding: 15px;
      border-radius: 8px;
    }
    tbody tr td {
      border: none;
      position: relative;
      padding-left: 50%;
      text-align: right;
      font-size: 15px;
    }
    tbody tr td::before {
      content: attr(data-label);
      position: absolute; right: 10px; top: 10px; font-weight: bold; color: #007bff; font-size: 13px; white-space: nowrap; /* Adjusted for RTL */
    }
    tbody tr td:last-child {
      padding-left: 10px;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    tbody tr td:last-child button, tbody tr td:last-child a {
      flex: 1 1 auto; min-width: 80px; font-size: 14px; padding: 8px 10px;
    }
    tbody tr td input[type="text"] {
      width: calc(100% - 5px); padding: 6px; font-size: 15px;
    }
    .stats-bar, .delete-selected-container {
        font-size: 15px; padding: 5px;
    }
    .multi-select-dropdown {
        width: calc(100% - 16px);
    }
    .modal-content {
      width: 95%;
    }
    #toast-container {
      top: 10px;
      right: 10px;
      left: 10px;
      align-items: center;
    }
  }
</style>
</head>
<body>

<h1>شجرة العائلة - لوحة التحكم</h1>

<nav style="text-align: center; margin-bottom: 20px;">
  <a href="index.html" style="margin: 0 10px;">الرئيسية</a> |
  <a href="events.html" style="margin: 0 10px;">الأحداث القادمة</a> |
  <a href="family_tree_graph.html" style="margin: 0 10px;">الشجرة الرسومية</a>
</nav>

<div class="section-container import-vcf">
  <h2>استيراد جهات اتصال من ملف VCF</h2>
  <input type="file" id="vcfFileInput" accept=".vcf" />
  <input type="text" id="ownerInput" placeholder="اسم المالك (للملف المرفوع - اختياري)" />
  <button onclick="importVCF()">رفع ملف VCF</button>
</div>

<div class="section-container export-section">
  <h2>تصدير البيانات</h2>
  <button onclick="exportPersons('csv')">تصدير إلى CSV</button>
  <button onclick="exportPersons('vcf')">تصدير إلى VCF</button>
</div>

<div class="section-container add-form">
  <h2>إضافة شخص جديد</h2>
  <input type="text" id="addFirstName" placeholder="الاسم الأول" required />
  <input type="text" id="addFamilyName" placeholder="اسم العائلة" required />
  
  <div class="multi-select-dropdown" id="addFatherSelect">
    <label for="addFatherInput" style="display: block; text-align: right; margin-bottom: 5px; font-size: 14px;">اسم الأب:</label>
    <input type="text" id="addFatherInput" placeholder="اكتب أو اختر اسم الأب" onkeyup="filterPersonsForSelect('addFatherSelect', this.value, 'father')" autocomplete="off" />
    <div class="options-container" id="addFatherOptionsContainer"></div>
  </div>
  <input type="text" id="addGrandfatherName" placeholder="اسم الجد (سيتم ملؤه تلقائيًا)" disabled />
  
  <div class="multi-select-dropdown" id="addMotherSelect">
    <label for="addMotherInput" style="display: block; text-align: right; margin-bottom: 5px; font-size: 14px;">اسم الأم:</label>
    <input type="text" id="addMotherInput" placeholder="اكتب أو اختر اسم الأم" onkeyup="filterPersonsForSelect('addMotherSelect', this.value, 'mother')" autocomplete="off" />
    <div class="options-container" id="addMotherOptionsContainer"></div>
  </div>

  <input type="date" id="addDob" placeholder="تاريخ الميلاد" required />
  <input type="text" id="addIdNumber" placeholder="رقم الهوية" />
  <input type="text" id="addPhoneNumber" placeholder="رقم الجوال (اختياري)" />

  <select id="addGender" required>
    <option value="">اختر الجنس</option>
    <option value="ذكر">ذكر</option>
    <option value="أنثى">أنثى</option>
  </select>

  <select id="addMaritalStatus">
    <option value="">الحالة الاجتماعية</option>
    <option value="أعزب">أعزب</option>
    <option value="متزوج">متزوج</option>
    <option value="مطلق">مطلق</option>
    <option value="أرمل">أرمل</option>
  </select>

  <div style="text-align: right; margin: 10px 0;">
    <input type="checkbox" id="addIsAlive" checked />
    <label for="addIsAlive">على قيد الحياة</label>
  </div>
  <input type="date" id="addDod" placeholder="تاريخ الوفاة" class="hidden" />

  <input type="text" id="addTags" placeholder="علامات إضافية (فاصلة بينها , )" />
  <button onclick="addNewPerson()">إضافة شخص</button>
</div>

<div class="section-container search">
  <h2>بحث</h2>
  <input type="text" id="searchInput" placeholder="ابحث بالاسم، الرقم، الهوية، الملاحظة، أو العلامة" onkeyup="applyFilters()" />
</div>

<div class="section-container filters">
  <h2>عوامل التصفية</h2>
  <label for="genderFilter">الجنس:</label>
  <select id="genderFilter" onchange="applyFilters()">
    <option value="">الكل</option>
    <option value="ذكر">ذكر</option>
    <option value="أنثى">أنثى</option>
  </select>

  <label for="ageGroupFilter">الفئة العمرية:</label>
  <select id="ageGroupFilter" onchange="applyFilters()">
    <option value="">الكل</option>
    <option value="فوق_16">فوق 16 سنة</option>
    <option value="أقل_من_16">أقل من 16 سنة</option>
  </select>
  
  <label for="maritalStatusFilter">الحالة الاجتماعية:</label>
  <select id="maritalStatusFilter" onchange="applyFilters()">
    <option value="">الكل</option>
    <option value="أعزب">أعزب</option>
    <option value="متزوج">متزوج</option>
    <option value="مطلق">مطلق</option>
    <option value="أرمل">أرمل</option>
  </select>

  <label for="lifeStatusFilter">حالة الحياة:</label>
  <select id="lifeStatusFilter" onchange="applyFilters()">
    <option value="">الكل</option>
    <option value="true">على قيد الحياة</option>
    <option value="false">متوفى</option>
  </select>

  <label for="birthYearFilter">سنة الميلاد:</label>
  <input type="number" id="birthYearFilter" placeholder="سنة الميلاد" onkeyup="applyFilters()" onchange="applyFilters()" />
  
  <label for="deathYearFilter">سنة الوفاة:</label>
  <input type="number" id="deathYearFilter" placeholder="سنة الوفاة" onkeyup="applyFilters()" onchange="applyFilters()" />

  <div class="section-container owner-filter">
    <label for="ownerMultiSelect">فلترة حسب المالك (في حال استخدام حقل المالك):</label>
    <div id="ownerMultiSelect" class="multi-select-dropdown">
      <div class="selected-items" onclick="toggleMultiSelect(this)">اختر المالكين...</div>
      <div class="options-container" id="ownerOptionsContainer"></div>
    </div>
  </div>

  <div class="section-container tags-filter">
    <label for="tagsMultiSelect">فلترة حسب العلامات الإضافية:</label>
    <div id="tagsMultiSelect" class="multi-select-dropdown">
      <div class="selected-items" onclick="toggleMultiSelect(this)">اختر العلامات...</div>
      <div class="options-container" id="tagsOptionsContainer"></div>
    </div>
  </div>

  <div class="section-container date-filter">
    <label for="startDate">تاريخ آخر تعديل من:</label>
    <input type="date" id="startDate" onchange="applyFilters()" />
    <label for="endDate">تاريخ آخر تعديل إلى:</label>
    <input type="date" id="endDate" onchange="applyFilters()" />
  </div>

</div>

<div class="stats-bar">
  <span id="totalVisiblePersons">إجمالي الأشخاص المعروضين: 0</span> |
  <span id="selectedVisiblePersons">المحدد من المعروض: 0</span>
</div>

<div class="delete-selected-container">
  <button id="deleteSelectedBtn" class="delete-btn hidden" onclick="confirmDeleteSelected()">حذف المحدد</button>
  <button id="bulkEditBtn" class="edit-btn hidden" onclick="openBulkEditModal()">تعديل جماعي</button>
  <button id="deleteByOwnerBtn" class="delete-btn hidden" onclick="confirmDeleteByOwner()">حذف جهات الاتصال للمالكين المحددين</button>
</div>

<div class="table-scroll-container">
    <table id="personsTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" /></th>
          <th onclick="sortTable(1)">الاسم الأول</th>
          <th onclick="sortTable(2)">اسم الأب</th>
          <th onclick="sortTable(3)">اسم الجد</th>
          <th onclick="sortTable(4)">اسم العائلة</th>
          <th onclick="sortTable(5)">الجنس</th>
          <th onclick="sortTable(6)">العمر</th>
          <th onclick="sortTable(7)">الحالة الاجتماعية</th>
          <th onclick="sortTable(8)">على قيد الحياة؟</th>
          <th onclick="sortTable(9)">رقم الهوية</th>
          <th onclick="sortTable(10)">رقم الجوال</th>
          <th onclick="sortTable(11)">تاريخ الميلاد</th>
          <th onclick="sortTable(12)">تاريخ الوفاة</th>
          <th onclick="sortTable(13)">العلامات</th>
          <th onclick="sortTable(14)">آخر تعديل</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
</div>

<div id="toast-container"></div>

<div id="bulkEditModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeBulkEditModal()">&times;</span>
    <h2>تعديل جماعي</h2>
    <label for="bulkEditField">اختر الحقل للتعديل:</label>
    <select id="bulkEditField">
      <option value="firstName">الاسم الأول</option>
      <option value="familyName">اسم العائلة</option>
      <option value="dob">تاريخ الميلاد</option>
      <option value="idNumber">رقم الهوية</option>
      <option value="phoneNumber">رقم الجوال</option>
      <option value="gender">الجنس</option>
      <option value="maritalStatus">الحالة الاجتماعية</option>
      <option value="isAlive">على قيد الحياة؟</option>
      <option value="dod">تاريخ الوفاة</option>
      <option value="tags">العلامات</option>
      </select>
    <label for="bulkEditValue">القيمة الجديدة:</label>
    <input type="text" id="bulkEditValue" placeholder="أدخل القيمة الجديدة"/>
    <button onclick="applyBulkEdit()">تطبيق التعديل</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ======== Firebase Configuration ========
  const firebaseConfig = {
    apiKey: "AIzaSyBOXGJek0FHS1VqXhkgORMq-VrPoN1db3w",
    authDomain: "family-9b0b8.firebaseapp.com",
    databaseURL: "https://family-9b0b8-default-rtdb.firebaseio.com",
    projectId: "family-9b0b8",
    storageBucket: "family-9b0b8.firebasestorage.app",
    messagingSenderId: "409089079475",
    appId: "1:409089079475:web:93f8be81e247ecfe2758c6",
    measurementId: "G-X5LDQB1WC9"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  // **تغيير اسم الريفرنس من contacts إلى persons**
  const personsRef = db.ref('persons');

  firebase.database.enablePersistence()
    .catch(err => {
      if (err.code === 'failed-precondition') {
        showToast('التخزين دون اتصال غير متاح.', 'info');
      } else if (err.code === 'unimplemented') {
        showToast('التخزين دون اتصال غير مدعوم في متصفحك.', 'error');
      } else {
        showToast('فشل تفعيل التخزين دون اتصال.', 'error');
        console.error("Persistence failed:", err);
      }
    });

  let allPersonsData = {}; 
  let selectedOwners = []; 
  let selectedTags = []; 

  // --- New Variables for Lazy Loading ---
  const rowsPerLoad = 50; 
  let currentLoadedRows = 0;
  let filteredPersonsCache = []; 

  // --- Search/Autofill related variables for add form ---
  let personsDataForSelect = {}; 
  let selectedFatherId = null; 
  let selectedMotherId = null; 

  // --- Loading Indicator Functions ---
  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  // --- Toast Notification Functions ---
  function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, duration);
  }

  // --- فك ترميز QUOTED-PRINTABLE مع دعم UTF-8 محسّن (مهم لاستيراد VCF) ---
  function decodeQuotedPrintable(str) {
    str = str.replace(/=\r?\n/g, ''); 
    str = str.replace(/=([0-9A-F]{2})/gi, '%$1'); 
    try {
      return decodeURIComponent(str); 
    } catch (e) {
      console.warn("Failed to decode URI component, falling back. Error:", e);
      return str.replace(/%([0-9A-F]{2})/gi, (match, hex) => String.fromCharCode(parseInt(hex, 16)));
    }
  }

  // --- تحليل ملف VCF (سيعمل بشكل أساسي على الاسم والرقم والملاحظة والعلامات) ---
  function parseVCF(data) {
    const persons = [];
    const entries = data.split(/END:VCARD\r?\n+/gi);
    
    entries.forEach(entry => {
      if (!entry.trim()) return;

      let firstName = '';
      let familyName = '';
      let phoneNumber = '';
      let note = ''; // VCF note will map to general notes or can be ignored
      let tags = ''; 
      let gender = ''; // VCF doesn't directly have gender in common fields, can be inferred or left empty
      let dob = ''; // VCF has BDAY, but format might vary
      
      const isQuotedPrintableUtf8 = entry.toUpperCase().includes('CHARSET=UTF-8') && entry.toUpperCase().includes('ENCODING=QUOTED-PRINTABLE');

      // Full Name (FN)
      const fnMatch = entry.match(/FN(?:;[^:]*)?:\s*(.*)/i);
      if (fnMatch && fnMatch[1]) {
        let name = fnMatch[1].trim();
        if (isQuotedPrintableUtf8) name = decodeQuotedPrintable(name);
        const nameParts = name.split(' ');
        firstName = nameParts[0] || '';
        familyName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
      }

      // N field for structured name (Family;Given;Middle;Prefix;Suffix)
      if (!firstName || !familyName) {
        const nMatch = entry.match(/N(?:;[^:]*)?:([^;]*);([^;]*);([^;]*);([^;]*);([^;]*)/i);
        if (nMatch) {
          let lastName = nMatch[1] || '';
          let givenName = nMatch[2] || '';
          if (isQuotedPrintableUtf8) {
              lastName = decodeQuotedPrintable(lastName);
              givenName = decodeQuotedPrintable(givenName);
          }
          firstName = givenName || firstName;
          familyName = lastName || familyName;
        }
      }
      
      // Org (ORG) as fallback for name if FN/N are missing
      if (!firstName && !familyName) {
          const orgMatch = entry.match(/ORG(?:;[^:]*)?:(.*)/i);
          if (orgMatch && orgMatch[1]) {
              let orgName = orgMatch[1].trim();
              if (isQuotedPrintableUtf8) orgName = decodeQuotedPrintable(orgName);
              firstName = orgName; // Use org as first name
          }
      }

      // Phone (TEL)
      const telMatches = entry.match(/TEL(?:;[^:]*)?:(.*)/gi);
      if (telMatches) {
        // Just take the first one or combine them
        phoneNumber = telMatches[0].split(':').pop().trim().replace(/[^\d+]/g, '');
        if (phoneNumber.startsWith('tel:')) phoneNumber = phoneNumber.substring(4);
      }

      // Note (NOTE)
      const noteMatch = entry.match(/NOTE(?:;[^:]*)?:(.*)/i);
      if (noteMatch && noteMatch[1]) {
        note = noteMatch[1].trim();
        if (isQuotedPrintableUtf8) note = decodeQuotedPrintable(note);
        note = note.replace(/=\r?\n/g, '').trim();
      }

      // Categories (CATEGORIES) for tags
      const categoriesMatch = entry.match(/CATEGORIES(?:;[^:]*)?:(.*)/i);
      if (categoriesMatch && categoriesMatch[1]) {
          let categoryStr = categoriesMatch[1].trim();
          if (isQuotedPrintableUtf8) categoryStr = decodeQuotedPrintable(categoryStr);
          tags = categoryStr.split(',').map(tag => tag.trim()).filter(Boolean).join(','); 
      }

      // Birthday (BDAY)
      const bdayMatch = entry.match(/BDAY(?:;[^:]*)?:(.*)/i);
      if (bdayMatch && bdayMatch[1]) {
          let bdayStr = bdayMatch[1].trim();
          // VCF BDAY can be YYYYMMDD, YYYY-MM-DD, or --MMDD for recurring
          if (bdayStr.match(/^\d{8}$/)) { // YYYYMMDD
              dob = `${bdayStr.substring(0,4)}-${bdayStr.substring(4,6)}-${bdayStr.substring(6,8)}`;
          } else if (bdayStr.match(/^\d{4}-\d{2}-\d{2}$/)) { // YYYY-MM-DD
              dob = bdayStr;
          }
          // Other formats like --MMDD for recurring birthdays might need specific handling
      }


      if (firstName || familyName || phoneNumber) {
        persons.push({ 
            firstName: firstName, 
            familyName: familyName,
            phoneNumber: phoneNumber, 
            note: note, // We can potentially store VCF notes in a 'notes' field
            tags: tags,
            gender: gender, // Will likely be empty from VCF unless specifically parsed
            dob: dob,
            maritalStatus: '', // Cannot be reliably inferred from VCF
            isAlive: true // Default to true on import
        });
      }
    });
    return persons;
  }

  function importVCF() {
    const fileInput = document.getElementById('vcfFileInput');
    const owner = document.getElementById('ownerInput').value.trim(); // Optional owner field for VCF

    const file = fileInput.files[0];

    if (!file) {
      showToast('يرجى اختيار ملف VCF أولاً.', 'error');
      return;
    }

    showLoading();
    const reader = new FileReader();

    reader.onload = function(e) {
      const vcfContent = e.target.result;
      const parsedPersons = parseVCF(vcfContent);
      
      if (parsedPersons.length === 0) {
        hideLoading();
        showToast('لم يتم العثور على أشخاص صالحين في ملف VCF المحدد.', 'error');
        return;
      }

      const updates = {};
      parsedPersons.forEach(person => {
        const newKey = personsRef.push().key; 
        const combinedTags = (person.tags ? person.tags.split(',') : []).map(t => t.trim()).filter(Boolean);
        if (owner && !combinedTags.includes(owner)) { // Add owner as a tag if provided and not already present
          combinedTags.push(owner);
        }

        updates[newKey] = {
          firstName: person.firstName || '',
          familyName: person.familyName || '',
          phoneNumber: person.phoneNumber || '',
          dob: person.dob || '',
          gender: person.gender || '',
          idNumber: '', // VCF usually doesn't have ID number
          maritalStatus: person.maritalStatus || '',
          isAlive: person.isAlive,
          dod: '',
          // Default related IDs as empty on import, relationships need manual setup later
          fatherId: '', 
          motherId: '',
          spouseId: '',
          fatherNameDisplay: '', 
          grandfatherNameDisplay: '', 
          motherNameDisplay: '', 
          tags: combinedTags.join(','), 
          lastModified: new Date().toISOString()
        };
      });

      personsRef.update(updates)
        .then(() => {
          hideLoading();
          showToast(`تم استيراد ${parsedPersons.length} شخص بنجاح.`, 'success');
          fileInput.value = '';
          document.getElementById('ownerInput').value = '';
        })
        .catch(error => {
          hideLoading();
          console.error("Error importing persons:", error);
          showToast("حدث خطأ أثناء استيراد الأشخاص.", 'error');
        });
    };

    reader.onerror = function(e) {
      hideLoading();
      console.error("Error reading VCF file:", e);
      showToast('حدث خطأ أثناء قراءة ملف VCF.', 'error');
    };

    reader.readAsText(file);
  }

  // تحميل الأشخاص من Firebase وتطبيق الفلاتر
  function loadPersons() {
    showLoading();
    personsRef.off(); // إزالة المستمعين القدامى لتجنب التكرار
    personsRef.on('value', snapshot => {
      allPersonsData = snapshot.val() || {};
      applyFilters();
      updateOwnerMultiSelect(allPersonsData); // تحديث فلتر المالكين (إن وجد)
      updateTagsMultiSelect(allPersonsData); // تحديث فلتر العلامات
      loadPersonsForSelect(); // تحديث قائمة الأشخاص للبحث التلقائي في نموذج الإضافة
      hideLoading(); 
    }, (error) => {
      hideLoading();
      console.error("Firebase data load error:", error);
      showToast("فشل في تحميل البيانات من Firebase. تحقق من إعداداتك وقواعد الأمان.", 'error'); 
    });
  }

  // تطبيق جميع الفلاتر (البحث، المالك، التاريخ، العلامات، الجنس، العمر، الحالة الاجتماعية، حالة الحياة، سنة الميلاد/الوفاة)
  function applyFilters() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const genderFilter = document.getElementById('genderFilter').value;
    const ageGroupFilter = document.getElementById('ageGroupFilter').value;
    const maritalStatusFilter = document.getElementById('maritalStatusFilter').value;
    const lifeStatusFilter = document.getElementById('lifeStatusFilter').value; // "true" or "false" string
    const birthYearFilter = document.getElementById('birthYearFilter').value;
    const deathYearFilter = document.getElementById('deathYearFilter').value;
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;


    const personsArray = Object.entries(allPersonsData).map(([key, val]) => {
      const personAge = val.dob ? calculateAgeDetails(val.dob) : null;
      return { key, ...val, _ageDetails: personAge }; // إضافة تفاصيل العمر للحسابات
    });

    const filtered = personsArray.filter(person => {
      const firstName = (person.firstName || '').toLowerCase();
      const familyName = (person.familyName || '').toLowerCase();
      const fatherNameDisplay = (person.fatherNameDisplay || '').toLowerCase();
      const grandfatherNameDisplay = (person.grandfatherNameDisplay || '').toLowerCase();
      const motherNameDisplay = (person.motherNameDisplay || '').toLowerCase();
      const phoneNumber = (person.phoneNumber || '').toLowerCase();
      const idNumber = (person.idNumber || '').toLowerCase();
      const tags = (person.tags || '').toLowerCase();
      const owner = (person.owner || '').toLowerCase(); // Owner from VCF import, if exists

      const lastModifiedDate = person.lastModified ? new Date(person.lastModified) : null;
      const startDate = startDateInput ? new Date(startDateInput) : null;
      const endDate = endDateInput ? new Date(endDateInput) : null;

      // Search Filter
      const matchesSearch = firstName.includes(searchInput) ||
                            familyName.includes(searchInput) ||
                            fatherNameDisplay.includes(searchInput) ||
                            grandfatherNameDisplay.includes(searchInput) ||
                            motherNameDisplay.includes(searchInput) ||
                            phoneNumber.includes(searchInput) ||
                            idNumber.includes(searchInput) ||
                            tags.includes(searchInput); 

      // Gender Filter
      const matchesGender = genderFilter === '' || (person.gender || '').toLowerCase() === genderFilter;

      // Age Group Filter (Over 16 / Under 16)
      let matchesAgeGroup = true;
      if (ageGroupFilter && person._ageDetails) {
          if (ageGroupFilter === 'فوق_16') {
              matchesAgeGroup = person._ageDetails.years >= 16;
          } else if (ageGroupFilter === 'أقل_من_16') {
              matchesAgeGroup = person._ageDetails.years < 16;
          }
      }

      // Marital Status Filter
      const matchesMaritalStatus = maritalStatusFilter === '' || (person.maritalStatus || '').toLowerCase() === maritalStatusFilter;

      // Life Status Filter
      let matchesLifeStatus = true;
      if (lifeStatusFilter === 'true') { // Filter for 'alive'
          matchesLifeStatus = person.isAlive === true;
      } else if (lifeStatusFilter === 'false') { // Filter for 'deceased'
          matchesLifeStatus = person.isAlive === false;
      }
      
      // Birth Year Filter
      let matchesBirthYear = true;
      if (birthYearFilter) {
          const personBirthYear = person.dob ? new Date(person.dob).getFullYear().toString() : '';
          matchesBirthYear = personBirthYear === birthYearFilter;
      }

      // Death Year Filter
      let matchesDeathYear = true;
      if (deathYearFilter) {
          const personDeathYear = person.dod ? new Date(person.dod).getFullYear().toString() : '';
          matchesDeathYear = personDeathYear === deathYearFilter;
      }

      // Owner Filter (Multi-select) - now checks against tags as well as dedicated owner field if exists
      const matchesOwner = selectedOwners.length === 0 || selectedOwners.includes(owner) || 
                           selectedOwners.some(selOwner => tags.includes(selOwner)); // Check tags too


      // Tags Filter (Multi-select)
      const personTagsArray = tags.split(',').map(tag => tag.trim()).filter(Boolean);
      const matchesTags = selectedTags.length === 0 || selectedTags.some(selectedTag => personTagsArray.includes(selectedTag));


      // Date Filter for lastModified
      let matchesDate = true;
      if (lastModifiedDate) {
        if (startDate && endDate) {
          matchesDate = (lastModifiedDate >= startDate && lastModifiedDate <= endDate);
        } else if (startDate) {
          matchesDate = (lastModifiedDate >= startDate);
        } else if (endDate) {
          matchesDate = (lastModifiedDate <= endDate);
        }
      } else if (startDate || endDate) {
          matchesDate = false;
      }

      return matchesSearch && matchesGender && matchesAgeGroup && matchesMaritalStatus && matchesLifeStatus &&
             matchesBirthYear && matchesDeathYear && matchesOwner && matchesTags && matchesDate;
    });

    filtered.sort((a, b) => (a.firstName || '').localeCompare((b.firstName || ''), 'ar', { sensitivity: 'base' }));

    filteredPersonsCache = filtered;
    currentLoadedRows = 0;
    document.getElementById('tableBody').innerHTML = '';
    loadMoreRows();
  }

  // دالة مساعدة لتشفير HTML
  function escapeHTML(str) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  // --- Functions for intelligent father/mother input ---
  function loadPersonsForSelect() {
    personsRef.on('value', snapshot => { 
        const data = snapshot.val() || {};
        personsDataForSelect = {};
        for (const key in data) {
            if (data.hasOwnProperty(key)) {
                personsDataForSelect[key] = {
                    firstName: data[key].firstName || '',
                    id: key 
                };
            }
        }
    });
  }

  function filterPersonsForSelect(dropdownId, inputValue, type) {
      const inputElement = document.querySelector(`#${dropdownId} input[type="text"]`);
      const optionsContainer = document.querySelector(`#${dropdownId} .options-container`);
      optionsContainer.innerHTML = '';
      
      const searchTerm = inputValue.toLowerCase().trim();

      if (searchTerm.length < 2) { 
          optionsContainer.style.display = 'none';
          return;
      }

      const filtered = Object.values(personsDataForSelect).filter(person => 
          person.firstName.toLowerCase().includes(searchTerm)
      ).slice(0, 10); 

      if (filtered.length > 0) {
          filtered.forEach(person => {
              const option = document.createElement('div');
              option.className = 'option';
              option.textContent = person.firstName;
              option.setAttribute('data-id', person.id);
              option.onclick = () => selectPersonForInput(dropdownId, person.id, person.firstName, type);
              optionsContainer.appendChild(option);
          });
          optionsContainer.style.display = 'block';
      } else {
          optionsContainer.style.display = 'none';
      }
  }

  async function selectPersonForInput(dropdownId, personId, personName, type) {
      const inputElement = document.querySelector(`#${dropdownId} input[type="text"]`);
      inputElement.value = personName;
      document.querySelector(`#${dropdownId} .options-container`).style.display = 'none';

      if (type === 'father') {
          selectedFatherId = personId;
          await autoFillGrandfatherAndMother(personId);
      } else if (type === 'mother') {
          selectedMotherId = personId;
      }
  }

  async function autoFillGrandfatherAndMother(fatherId) {
      showLoading();
      try {
          const fatherSnapshot = await personsRef.child(fatherId).once('value');
          const fatherData = fatherSnapshot.val();

          if (fatherData) {
              const addGrandfatherNameInput = document.getElementById('addGrandfatherName');
              if (fatherData.fatherId) {
                  const grandfatherSnapshot = await personsRef.child(fatherData.fatherId).once('value');
                  const grandfatherData = grandfatherSnapshot.val();
                  if (grandfatherData) {
                      addGrandfatherNameInput.value = grandfatherData.firstName || '';
                  } else {
                      addGrandfatherNameInput.value = '';
                  }
              } else {
                  addGrandfatherNameInput.value = '';
              }

              const addMotherInput = document.getElementById('addMotherInput');
              if (fatherData.spouseId) {
                  const motherSnapshot = await personsRef.child(fatherData.spouseId).once('value');
                  const motherData = motherSnapshot.val();
                  if (motherData) {
                      addMotherInput.value = motherData.firstName || '';
                      selectedMotherId = fatherData.spouseId; 
                  } else {
                      addMotherInput.value = '';
                      selectedMotherId = null;
                  }
              } else {
                  addMotherInput.value = '';
                  selectedMotherId = null;
              }
          }
      } catch (error) {
          console.error("Error auto-filling grandfather and mother:", error);
          showToast("حدث خطأ أثناء ملء بيانات الأب والأم تلقائياً.", 'error');
      } finally {
          hideLoading();
      }
  }

  // دالة لإضافة شخص جديد
  async function addNewPerson() {
    const firstName = document.getElementById('addFirstName').value.trim();
    const familyName = document.getElementById('addFamilyName').value.trim();
    const fatherNameDisplay = document.getElementById('addFatherInput').value.trim();
    const grandfatherNameDisplay = document.getElementById('addGrandfatherName').value.trim();
    const motherNameDisplay = document.getElementById('addMotherInput').value.trim();
    const dob = document.getElementById('addDob').value;
    const idNumber = document.getElementById('addIdNumber').value.trim();
    const phoneNumber = document.getElementById('addPhoneNumber').value.trim();
    const gender = document.getElementById('addGender').value;
    const maritalStatus = document.getElementById('addMaritalStatus').value;
    const isAlive = document.getElementById('addIsAlive').checked;
    const dod = isAlive ? '' : document.getElementById('addDod').value; 
    const tagsInput = document.getElementById('addTags').value.trim();
    let tags = tagsInput.split(',').map(tag => tag.trim()).filter(Boolean);

    if (!firstName || !familyName || !dob || !gender) {
        showToast('يرجى ملء الحقول الأساسية: الاسم الأول، اسم العائلة، تاريخ الميلاد، والجنس.', 'error');
        return;
    }
    
    const ageInYears = calculateAgeInYears(dob);
    if (ageInYears >= 16 && !tags.includes("فوق_16")) {
        tags.push("فوق_16");
    } else if (ageInYears < 16 && !tags.includes("أقل_من_16")) {
        tags.push("أقل_من_16");
    }

    if (gender === "ذكر" && !tags.includes("ذكر")) tags.push("ذكر");
    if (gender === "أنثى" && !tags.includes("أنثى")) tags.push("أنثى");
    if (maritalStatus === "متزوج" && !tags.includes("متزوج")) tags.push("متزوج");
    if (!isAlive && !tags.includes("متوفى")) tags.push("متوفى");

    showLoading();
    try {
        const newPersonRef = personsRef.push();
        await newPersonRef.set({
            firstName,
            familyName,
            fatherNameDisplay,
            grandfatherNameDisplay,
            motherNameDisplay,
            fatherId: selectedFatherId || '', 
            motherId: selectedMotherId || '', 
            dob,
            idNumber,
            phoneNumber,
            gender,
            maritalStatus,
            isAlive,
            dod,
            tags: tags.join(','), 
            lastModified: new Date().toISOString()
        });
        showToast('تم إضافة الشخص بنجاح.', 'success');
        clearAddPersonForm();
    } catch (error) {
        console.error("Error adding new person:", error);
        showToast("حدث خطأ أثناء إضافة الشخص.", 'error');
    } finally {
        hideLoading();
    }
  }

  // دالة لمسح حقول نموذج إضافة شخص جديد
  function clearAddPersonForm() {
    document.getElementById('addFirstName').value = '';
    document.getElementById('addFamilyName').value = '';
    document.getElementById('addFatherInput').value = '';
    document.getElementById('addGrandfatherName').value = '';
    document.getElementById('addMotherInput').value = '';
    document.getElementById('addDob').value = '';
    document.getElementById('addIdNumber').value = '';
    document.getElementById('addPhoneNumber').value = '';
    document.getElementById('addGender').value = '';
    document.getElementById('addMaritalStatus').value = '';
    document.getElementById('addIsAlive').checked = true;
    document.getElementById('addDod').value = '';
    document.getElementById('addDod').classList.add('hidden');
    document.getElementById('addTags').value = '';
    selectedFatherId = null; 
    selectedMotherId = null; 
  }

  // دالة لحساب العمر بالسنوات
  function calculateAgeInYears(dobString) {
    if (!dobString) return 0;
    const birthDate = new Date(dobString);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
  }

  // دالة لحساب العمر بالتفصيل (سنوات، شهور، أيام)
  function calculateAgeDetails(dobString) {
    if (!dobString) return { years: 0, months: 0, days: 0 };
    const birthDate = new Date(dobString);
    const today = new Date();

    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    let days = today.getDate() - birthDate.getDate();

    if (days < 0) {
        months--;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); // Days in previous month
    }
    if (months < 0) {
        years--;
        months += 12;
    }
    return { years, months, days };
  }

  // تبديل ظهور حقل تاريخ الوفاة بناءً على حالة "على قيد الحياة"
  document.getElementById('addIsAlive').addEventListener('change', function() {
    const dodInput = document.getElementById('addDod');
    if (this.checked) {
        dodInput.classList.add('hidden');
        dodInput.value = '';
    } else {
        dodInput.classList.remove('hidden');
    }
  });

  // --- Multi-select for Owners (from imported VCF, now also from tags) ---
  function updateOwnerMultiSelect(data) {
    const ownerOptionsContainer = document.getElementById('ownerOptionsContainer');
    ownerOptionsContainer.innerHTML = '';
    // Collect owners from 'owner' field (VCF import) and also from 'tags' if used for owners
    const owners = new Set();
    Object.values(data).forEach(c => {
        if (c.owner) owners.add(c.owner); // If there's a dedicated owner field from VCF
        if (c.tags) {
            c.tags.split(',').forEach(tag => {
                // You might need a way to distinguish 'owner' tags from other tags
                // For now, let's assume any tag can be selected as an owner filter
                owners.add(tag.trim());
            });
        }
    });
    const sortedOwners = Array.from(owners).filter(o => o).sort((a, b) => a.localeCompare(b, 'ar', { sensitivity: 'base' }));

    sortedOwners.forEach(owner => {
      const option = document.createElement('div');
      option.className = 'option';
      option.textContent = owner;
      option.setAttribute('data-value', owner.toLowerCase());
      if (selectedOwners.includes(owner.toLowerCase())) {
        option.classList.add('selected');
      }
      option.onclick = (event) => toggleMultiSelectSelection(event, owner.toLowerCase(), owner, selectedOwners, updateOwnerMultiSelectDisplay, updateDeleteByOwnerButtonVisibility);
      ownerOptionsContainer.appendChild(option);
    });
    updateOwnerMultiSelectDisplay();
  }

  // --- Multi-select for Tags ---
  function updateTagsMultiSelect(data) {
    const tagsOptionsContainer = document.getElementById('tagsOptionsContainer');
    tagsOptionsContainer.innerHTML = '';
    const allTags = new Set();
    Object.values(data).forEach(c => {
      if (c.tags) {
        c.tags.split(',').forEach(tag => {
          const trimmedTag = tag.trim();
          if (trimmedTag) allTags.add(trimmedTag);
        });
      }
    });
    // Add implicit tags like gender, age group, marital status, life status
    allTags.add('ذكر'); allTags.add('أنثى');
    allTags.add('فوق_16'); allTags.add('أقل_من_16');
    allTags.add('أعزب'); allTags.add('متزوج'); allTags.add('مطلق'); allTags.add('أرمل');
    allTags.add('على_قيد_الحياة'); allTags.add('متوفى');


    const sortedTags = Array.from(allTags).filter(t => t).sort((a, b) => a.localeCompare(b, 'ar', { sensitivity: 'base' }));

    sortedTags.forEach(tag => {
      const option = document.createElement('div');
      option.className = 'option';
      option.textContent = tag;
      option.setAttribute('data-value', tag.toLowerCase());
      if (selectedTags.includes(tag.toLowerCase())) {
        option.classList.add('selected');
      }
      option.onclick = (event) => toggleMultiSelectSelection(event, tag.toLowerCase(), tag, selectedTags, updateTagsMultiSelectDisplay);
      tagsOptionsContainer.appendChild(option);
    });
    updateTagsMultiSelectDisplay();
  }

  // Generic toggle for multi-select options
  function toggleMultiSelectSelection(event, value, text, selectedArray, updateDisplayFn, extraFn = null) {
    event.stopPropagation();
    const index = selectedArray.indexOf(value);
    const optionElement = event.target;

    if (index > -1) {
      selectedArray.splice(index, 1);
      optionElement.classList.remove('selected');
    } else {
      selectedArray.push(value);
      optionElement.classList.add('selected');
    }
    updateDisplayFn();
    applyFilters();
    if (extraFn) extraFn(); 
  }

  // تبديل حالة فتح/إغلاق قائمة التحديد المتعدد
  function toggleMultiSelect(element) {
    element.closest('.multi-select-dropdown').classList.toggle('active');
  }

  // تحديث عرض العناصر المختارة في التحديد المتعدد للمالكين
  function updateOwnerMultiSelectDisplay() {
    const selectedItemsDiv = document.querySelector('#ownerMultiSelect .selected-items');
    updateMultiSelectDisplayGeneric(selectedItemsDiv, selectedOwners, '#ownerOptionsContainer .option', 'اختر المالكين...');
  }

  // تحديث عرض العناصر المختارة في التحديد المتعدد للعلامات
  function updateTagsMultiSelectDisplay() {
    const selectedItemsDiv = document.querySelector('#tagsMultiSelect .selected-items');
    updateMultiSelectDisplayGeneric(selectedItemsDiv, selectedTags, '#tagsOptionsContainer .option', 'اختر العلامات...');
  }

  // Generic update display for multi-selects
  function updateMultiSelectDisplayGeneric(selectedItemsDiv, selectedArray, optionsSelector, defaultText) {
    selectedItemsDiv.innerHTML = '';

    if (selectedArray.length === 0) {
      selectedItemsDiv.textContent = defaultText;
      selectedItemsDiv.classList.remove('active');
    } else {
      selectedArray.forEach(selectedValue => {
        const itemText = Array.from(document.querySelectorAll(optionsSelector))
                          .find(opt => opt.getAttribute('data-value') === selectedValue)
                          ?.textContent || selectedValue;
        const item = document.createElement('span');
        item.className = 'selected-item';
        item.textContent = itemText;
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-item';
        removeBtn.textContent = 'x';
        removeBtn.onclick = (event) => {
          event.stopPropagation();
          if (selectedItemsDiv.closest('#ownerMultiSelect')) {
            toggleMultiSelectSelection(event, selectedValue, itemText, selectedOwners, updateOwnerMultiSelectDisplay, updateDeleteByOwnerButtonVisibility);
          } else if (selectedItemsDiv.closest('#tagsMultiSelect')) {
            toggleMultiSelectSelection(event, selectedValue, itemText, selectedTags, updateTagsMultiSelectDisplay);
          }
        };
        item.appendChild(removeBtn);
        selectedItemsDiv.appendChild(item);
      });
      selectedItemsDiv.classList.add('active');
    }
  }


  // إغلاق قائمة التحديد المتعدد عند النقر خارجها
  document.addEventListener('click', function(event) {
    const multiSelectDropdowns = document.querySelectorAll('.multi-select-dropdown');
    multiSelectDropdowns.forEach(dropdown => {
      if (!dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });
  });

  // --- التحميل الكسول للجدول (Lazy Loading) ---
  function loadMoreRows() {
    const tbody = document.getElementById('tableBody');
    const totalFiltered = filteredPersonsCache.length;
    const startIndex = currentLoadedRows;
    const endIndex = Math.min(startIndex + rowsPerLoad, totalFiltered);

    for (let i = startIndex; i < endIndex; i++) {
      const person = filteredPersonsCache[i];
      const tr = document.createElement('tr');
      tr.id = person.key;
      const ageDetails = calculateAgeDetails(person.dob);
      const ageString = ageDetails.years > 0 ? `${ageDetails.years} سنة ${ageDetails.months} شهر ${ageDetails.days} يوم` : '';


      tr.innerHTML = `
        <td data-label="تحديد"><input type="checkbox" class="select-person" data-key="${person.key}" onchange="updateSelected()" /></td>
        <td data-label="الاسم الأول"><input type="text" value="${escapeHTML(person.firstName || '')}" disabled /></td>
        <td data-label="اسم الأب"><input type="text" value="${escapeHTML(person.fatherNameDisplay || '')}" disabled /></td>
        <td data-label="اسم الجد"><input type="text" value="${escapeHTML(person.grandfatherNameDisplay || '')}" disabled /></td>
        <td data-label="اسم العائلة"><input type="text" value="${escapeHTML(person.familyName || '')}" disabled /></td>
        <td data-label="الجنس"><input type="text" value="${escapeHTML(person.gender || '')}" disabled /></td>
        <td data-label="العمر"><input type="text" value="${escapeHTML(ageString)}" disabled /></td>
        <td data-label="الحالة الاجتماعية"><input type="text" value="${escapeHTML(person.maritalStatus || '')}" disabled /></td>
        <td data-label="على قيد الحياة؟"><input type="text" value="${person.isAlive ? 'نعم' : 'لا'}" disabled /></td>
        <td data-label="رقم الهوية"><input type="text" value="${escapeHTML(person.idNumber || '')}" disabled /></td>
        <td data-label="رقم الجوال"><input type="text" value="${escapeHTML(person.phoneNumber || '')}" disabled /></td>
        <td data-label="تاريخ الميلاد"><input type="text" value="${escapeHTML(person.dob || '')}" disabled /></td>
        <td data-label="تاريخ الوفاة"><input type="text" value="${escapeHTML(person.dod || '')}" disabled /></td>
        <td data-label="العلامات"><input type="text" value="${escapeHTML(person.tags || '')}" disabled /></td>
        <td data-label="آخر تعديل"><input type="text" value="${escapeHTML(person.lastModified ? new Date(person.lastModified).toLocaleString() : '')}" disabled /></td>
        <td data-label="الإجراءات">
          <button class="edit-btn" onclick="enableEdit('${person.key}')">تعديل</button>
          <button class="delete-btn" onclick="confirmDeletePerson('${person.key}')">حذف</button>
          <button class="copy-btn" onclick="copyPhone('${escapeHTML(person.phoneNumber || '')}')">نسخ الجوال</button>
          <a class="call-btn" href="tel:${escapeHTML(person.phoneNumber || '')}">اتصال</a>
          <a class="wa-btn" href="https://wa.me/970${escapeHTML(person.phoneNumber || '')}" target="_blank">واتساب 970+</a>
          <a class="wa-btn" href="https://wa.me/972${escapeHTML(person.phoneNumber || '')}" target="_blank">واتساب 972+</a>
          <button class="view-details-btn" onclick="viewPersonDetails('${person.key}')">عرض التفاصيل</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
    currentLoadedRows = endIndex;
    updateStats();
  }

  // الانتقال إلى صفحة تفاصيل الشخص
  function viewPersonDetails(personId) {
      window.location.href = `person_details.html?id=${personId}`;
  }

  // إضافة معالج حدث التمرير إلى حاوية الجدول لتطبيق التحميل الكسول
  document.addEventListener('DOMContentLoaded', () => {
      const tableScrollContainer = document.querySelector('.table-scroll-container');
      if (tableScrollContainer) {
          tableScrollContainer.addEventListener('scroll', () => {
              if (tableScrollContainer.scrollTop + tableScrollContainer.clientHeight >= tableScrollContainer.scrollHeight - 50) {
                  if (currentLoadedRows < filteredPersonsCache.length) {
                      loadMoreRows();
                  }
              }
          });
      }
  });

  // --- تحديد الكل الذكي ---
  function toggleSelectAll(checkbox) {
    const allRenderedCheckboxes = document.querySelectorAll('#personsTable tbody tr .select-person');
    allRenderedCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelected();
  }

  // تحديث ظهور أزرار الحذف والتعديل الجماعي وعداد المحدد
  function updateSelected() {
    const allRenderedCheckboxes = document.querySelectorAll('#tableBody .select-person');
    const selectedRendered = Array.from(allRenderedCheckboxes).filter(cb => cb.checked);
    
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const bulkEditBtn = document.getElementById('bulkEditBtn');
    
    document.getElementById('selectedVisiblePersons').textContent = `المحدد من المعروض: ${selectedRendered.length}`;

    if (selectedRendered.length > 0) {
      deleteBtn.classList.remove('hidden');
      bulkEditBtn.classList.remove('hidden'); 
    } else {
      deleteBtn.classList.add('hidden');
      bulkEditBtn.classList.add('hidden'); 
      if (document.getElementById('selectAll').checked) {
          document.getElementById('selectAll').checked = false;
      }
    }
    if (selectedRendered.length > 0 && selectedRendered.length === allRenderedCheckboxes.length && allRenderedCheckboxes.length > 0) {
        document.getElementById('selectAll').checked = true;
    } else if (allRenderedCheckboxes.length === 0 && document.getElementById('selectAll').checked) {
        document.getElementById('selectAll').checked = false;
    }
  }

  // تحديث إحصائيات الصفوف المرئية
  function updateStats() {
    const renderedRows = document.querySelectorAll('#tableBody tr').length;
    document.getElementById('totalVisiblePersons').textContent = `إجمالي الأشخاص المعروضين: ${renderedRows} من ${filteredPersonsCache.length}`;
    updateSelected();
  }

  // تأكيد وحذف جهات الأشخاص المحددة (باستخدام Multi-path Delete)
  function confirmDeleteSelected() {
    const selectedCheckboxes = document.querySelectorAll('#tableBody .select-person:checked');
    const personsToDeleteCount = selectedCheckboxes.length;

    if (personsToDeleteCount === 0) {
        showToast('يرجى تحديد شخص واحد على الأقل للحذف.', 'error');
        return;
    }

    if (confirm(`هل أنت متأكد من حذف ${personsToDeleteCount} شخص محدد؟`)) {
      showLoading();
      const updates = {};
      selectedCheckboxes.forEach(cb => {
        const key = cb.getAttribute('data-key');
        updates[`/${key}`] = null;
      });

      db.ref('persons').update(updates)
        .then(() => {
            hideLoading();
            showToast(`تم حذف ${personsToDeleteCount} شخص بنجاح.`, 'success');
            document.getElementById('selectAll').checked = false;
        })
        .catch(error => {
            hideLoading();
            showToast("حدث خطأ أثناء حذف بعض الأشخاص.", 'error');
            console.error("Error in batch deletion:", error);
        });
    }
  }

  // Update visibility of the "Delete by Owner" button (if owner field is still used)
  function updateDeleteByOwnerButtonVisibility() {
      const deleteByOwnerBtn = document.getElementById('deleteByOwnerBtn');
      if (selectedOwners.length > 0) {
          deleteByOwnerBtn.classList.remove('hidden');
      } else {
          deleteByOwnerBtn.classList.add('hidden');
      }
  }

  // Confirm and delete persons by selected owners (if owner field is still used)
  function confirmDeleteByOwner() {
      if (selectedOwners.length === 0) {
          showToast('يرجى تحديد مالك واحد على الأقل للحذف.', 'error');
          return;
      }

      const personsToDelete = {};
      let countToDelete = 0;

      for (const key in allPersonsData) {
          if (allPersonsData.hasOwnProperty(key)) {
              const person = allPersonsData[key];
              // Check if person's owner field matches, or if any of their tags match selected owners
              const personTagsArray = (person.tags || '').toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
              const isOwnedBySelected = (person.owner && selectedOwners.includes(person.owner.toLowerCase())) ||
                                        selectedOwners.some(selOwner => personTagsArray.includes(selOwner));

              if (isOwnedBySelected) {
                  personsToDelete[`/${key}`] = null;
                  countToDelete++;
              }
          }
      }

      if (countToDelete === 0) {
          showToast('لم يتم العثور على أشخاص للمالكين المحددين.', 'info');
          return;
      }

      const ownerNamesForConfirmation = selectedOwners.map(ownerVal => {
        const optionElement = Array.from(document.querySelectorAll('#ownerOptionsContainer .option'))
                                .find(opt => opt.getAttribute('data-value') === ownerVal);
        return optionElement ? optionElement.textContent : ownerVal;
      }).join(', ');


      if (confirm(`هل أنت متأكد من حذف ${countToDelete} شخص لـ: ${ownerNamesForConfirmation}؟\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
          showLoading();
          db.ref('persons').update(personsToDelete)
              .then(() => {
                  hideLoading();
                  showToast(`تم حذف ${countToDelete} شخص بنجاح للمالكين المحددين.`, 'success');
                  selectedOwners = [];
                  updateOwnerMultiSelectDisplay();
                  updateDeleteByOwnerButtonVisibility();
              })
              .catch(error => {
                  hideLoading();
                  console.error("Error deleting persons by owner:", error);
                  showToast("حدث خطأ أثناء حذف الأشخاص للمالكين المحددين.", 'error');
              });
      }
  }

  // --- Bulk Edit Functions ---
  function openBulkEditModal() {
    const selectedCount = document.querySelectorAll('#tableBody .select-person:checked').length;
    if (selectedCount === 0) {
        showToast('يرجى تحديد شخص واحد على الأقل للتعديل الجماعي.', 'error');
        return;
    }
    document.getElementById('bulkEditModal').style.display = 'flex'; 
  }

  function closeBulkEditModal() {
    document.getElementById('bulkEditModal').style.display = 'none';
    document.getElementById('bulkEditField').value = 'firstName'; 
    document.getElementById('bulkEditValue').value = ''; 
  }

  function applyBulkEdit() {
    const selectedCheckboxes = document.querySelectorAll('#tableBody .select-person:checked');
    const personsToEditCount = selectedCheckboxes.length;
    const fieldToEdit = document.getElementById('bulkEditField').value;
    let newValue = document.getElementById('bulkEditValue').value.trim();

    if (personsToEditCount === 0) {
        showToast('لا توجد أشخاص محددون للتعديل.', 'error');
        return;
    }
    if (!fieldToEdit) {
        showToast('يرجى اختيار حقل للتعديل.', 'error');
        return;
    }

    // Special handling for boolean fields
    if (fieldToEdit === 'isAlive') {
        newValue = (newValue.toLowerCase() === 'true' || newValue.toLowerCase() === 'نعم');
    }

    if (confirm(`هل أنت متأكد من تعديل ${personsToEditCount} شخص للحقل "${fieldToEdit}" بالقيمة "${newValue}"؟`)) {
        showLoading();
        const updates = {};
        selectedCheckboxes.forEach(cb => {
            const key = cb.getAttribute('data-key');
            updates[`/${key}/${fieldToEdit}`] = newValue;
            updates[`/${key}/lastModified`] = new Date().toISOString(); 
        });

        db.ref('persons').update(updates)
            .then(() => {
                hideLoading();
                showToast(`تم تعديل ${personsToEditCount} شخص بنجاح.`, 'success');
                closeBulkEditModal();
                document.getElementById('selectAll').checked = false; 
            })
            .catch(error => {
                hideLoading();
                console.error("Error in bulk edit:", error);
                showToast("حدث خطأ أثناء التعديل الجماعي.", 'error');
            });
    }
  }

  // --- Export Functions ---
  function exportPersons(format) {
    if (filteredPersonsCache.length === 0) {
      showToast('لا يوجد أشخاص لتصديرهم.', 'info');
      return;
    }

    let fileContent;
    let fileName;

    if (format === 'csv') {
      fileContent = generatePersonsCSV(filteredPersonsCache);
      fileName = 'family_tree_persons.csv';
    } else if (format === 'vcf') {
      fileContent = generatePersonsVCF(filteredPersonsCache);
      fileName = 'family_tree_persons.vcf';
    } else {
      showToast('صيغة تصدير غير مدعومة.', 'error');
      return;
    }

    const blob = new Blob([fileContent], { type: `text/${format};charset=utf-8;` });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
    showToast(`تم تصدير ${filteredPersonsCache.length} شخص إلى ${format.toUpperCase()}.`, 'success');
  }

  function generatePersonsCSV(persons) {
    const headers = [
        'الاسم الأول', 'اسم الأب', 'اسم الجد', 'اسم العائلة', 'اسم الأم', 
        'الجنس', 'تاريخ الميلاد', 'رقم الهوية', 'رقم الجوال', 'الحالة الاجتماعية', 
        'على قيد الحياة؟', 'تاريخ الوفاة', 'العلامات', 'آخر تعديل', 'ID الشخص', 
        'ID الأب', 'ID الأم', 'ID الزوج/الزوجة'
    ];
    const csvRows = [];
    csvRows.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',')); 

    persons.forEach(person => {
      const row = [
        `"${(person.firstName || '').replace(/"/g, '""')}"`,
        `"${(person.fatherNameDisplay || '').replace(/"/g, '""')}"`,
        `"${(person.grandfatherNameDisplay || '').replace(/"/g, '""')}"`,
        `"${(person.familyName || '').replace(/"/g, '""')}"`,
        `"${(person.motherNameDisplay || '').replace(/"/g, '""')}"`,
        `"${(person.gender || '').replace(/"/g, '""')}"`,
        `"${(person.dob || '').replace(/"/g, '""')}"`,
        `"${(person.idNumber || '').replace(/"/g, '""')}"`,
        `"${(person.phoneNumber || '').replace(/"/g, '""')}"`,
        `"${(person.maritalStatus || '').replace(/"/g, '""')}"`,
        `"${(person.isAlive ? 'نعم' : 'لا')}"`,
        `"${(person.dod || '').replace(/"/g, '""')}"`,
        `"${(person.tags || '').replace(/"/g, '""')}"`,
        `"${(person.lastModified ? new Date(person.lastModified).toLocaleString() : '').replace(/"/g, '""')}"`,
        `"${(person.key || '').replace(/"/g, '""')}"`,
        `"${(person.fatherId || '').replace(/"/g, '""')}"`,
        `"${(person.motherId || '').replace(/"/g, '""')}"`,
        `"${(person.spouseId || '').replace(/"/g, '""')}"`
      ];
      csvRows.push(row.join(','));
    });
    return csvRows.join('\n');
  }

  function generatePersonsVCF(persons) {
    let vcfContent = '';
    persons.forEach(person => {
      vcfContent += 'BEGIN:VCARD\n';
      vcfContent += 'VERSION:3.0\n';
      // FN: Full Name
      const fullName = [person.firstName, person.fatherNameDisplay, person.grandfatherNameDisplay, person.familyName].filter(Boolean).join(' ');
      if (fullName) vcfContent += `FN:${fullName}\n`;
      // N: Structured Name (Family;Given;Middle;Prefix;Suffix)
      vcfContent += `N:${person.familyName || ''};${person.firstName || ''};${person.fatherNameDisplay || ''};;\n`; // Middle is father's name for simplification
      // TEL: Phone
      if (person.phoneNumber) vcfContent += `TEL:${person.phoneNumber}\n`;
      // BDAY: Birthday
      if (person.dob) vcfContent += `BDAY:${person.dob.replace(/-/g, '')}\n`; // VCF typically uses YYYYMMDD
      // NOTE: Other details like ID, marital status, life status, mother's name
      let noteParts = [];
      if (person.idNumber) noteParts.push(`ID: ${person.idNumber}`);
      if (person.gender) noteParts.push(`الجنس: ${person.gender}`);
      if (person.maritalStatus) noteParts.push(`الحالة الاجتماعية: ${person.maritalStatus}`);
      noteParts.push(`الحالة: ${person.isAlive ? 'على قيد الحياة' : 'متوفى'}`);
      if (!person.isAlive && person.dod) noteParts.push(`تاريخ الوفاة: ${person.dod}`);
      if (person.motherNameDisplay) noteParts.push(`اسم الأم: ${person.motherNameDisplay}`);
      if (noteParts.length > 0) vcfContent += `NOTE:${noteParts.join('; ')}\n`;
      // CATEGORIES: Tags
      if (person.tags) vcfContent += `CATEGORIES:${person.tags}\n`;

      vcfContent += 'END:VCARD\n';
    });
    return vcfContent;
  }

  let sortDirection = {};
  function sortTable(colIndex) {
    filteredPersonsCache.sort((a, b) => {
      let valA, valB;

      // Map column index to actual data field
      switch(colIndex) {
          case 1: valA = (a.firstName || '').toLowerCase(); valB = (b.firstName || '').toLowerCase(); break;
          case 2: valA = (a.fatherNameDisplay || '').toLowerCase(); valB = (b.fatherNameDisplay || '').toLowerCase(); break;
          case 3: valA = (a.grandfatherNameDisplay || '').toLowerCase(); valB = (b.grandfatherNameDisplay || '').toLowerCase(); break;
          case 4: valA = (a.familyName || '').toLowerCase(); valB = (b.familyName || '').toLowerCase(); break;
          case 5: valA = (a.gender || '').toLowerCase(); valB = (b.gender || '').toLowerCase(); break;
          case 6: valA = (a._ageDetails ? a._ageDetails.years : -1); valB = (b._ageDetails ? b._ageDetails.years : -1); break; // Sort by age in years
          case 7: valA = (a.maritalStatus || '').toLowerCase(); valB = (b.maritalStatus || '').toLowerCase(); break;
          case 8: valA = a.isAlive; valB = b.isAlive; break; // Boolean sort
          case 9: valA = (a.idNumber || '').toLowerCase(); valB = (b.idNumber || '').toLowerCase(); break;
          case 10: valA = (a.phoneNumber || '').toLowerCase(); valB = (b.phoneNumber || '').toLowerCase(); break;
          case 11: valA = a.dob ? new Date(a.dob) : new Date(0); valB = b.dob ? new Date(b.dob) : new Date(0); break;
          case 12: valA = a.dod ? new Date(a.dod) : new Date(0); valB = b.dod ? new Date(b.dod) : new Date(0); break;
          case 13: valA = (a.tags || '').toLowerCase(); valB = (b.tags || '').toLowerCase(); break;
          case 14: valA = a.lastModified ? new Date(a.lastModified) : new Date(0); valB = b.lastModified ? new Date(b.lastModified) : new Date(0); break;
          default: return 0;
      }
      
      const direction = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
      sortDirection[colIndex] = direction;

      // Text/Date/Number comparison
      if (typeof valA === 'string' && typeof valB === 'string') {
        if (direction === 'asc') {
          return valA.localeCompare(valB, 'ar', { sensitivity: 'base' });
        } else {
          return valB.localeCompare(valA, 'ar', { sensitivity: 'base' });
        }
      } else if (valA instanceof Date && valB instanceof Date) {
        if (direction === 'asc') {
          return valA.getTime() - valB.getTime();
        } else {
          return valB.getTime() - valA.getTime();
        }
      } else { // For numbers and booleans
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      }
    });

    currentLoadedRows = 0;
    document.getElementById('tableBody').innerHTML = '';
    loadMoreRows();
  }

  // عند تحميل نافذة المتصفح، ابدأ بتحميل الأشخاص
  window.onload = function () {
    loadPersons(); // هذه الدالة ستجلب البيانات وتملأ الجدول
    // لا حاجة لاستدعاء loadPersonsForSelect هنا لأن loadPersons ستستدعيها
  };
</script>

</body>
</html>
