<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة التحكم - جهات الاتصال مع Firebase</title>
<style>
  body { font-family: 'Arial'; background: #f0f2f5; direction: rtl; padding: 20px; margin:0; }
  h1 { text-align:center; color:#333; }
  .import-vcf, .search, .owner-filter, .add-form { text-align:center; margin:20px auto; max-width:600px; }
  input[type=text], select, button { font-size:16px; }
  input[type=text], select { padding:8px; margin:5px; width:90%; max-width:300px; border:1px solid #ccc; border-radius:5px; }
  button { padding:8px 16px; margin:5px; border:none; border-radius:5px; background:#28a745; color:#fff; cursor:pointer; }
  table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-top:20px; }
  th, td { padding:12px; border:1px solid #ddd; text-align:center; vertical-align:middle; }
  th { background:#007bff; color:#fff; cursor:pointer; }
  .delete-btn { background:#dc3545 !important; }
  @media(max-width:768px) {
    table, thead, tbody, th, td, tr { display:block; }
    thead tr { display:none; }
    tbody tr { background:#fff; margin-bottom:15px; padding:15px; box-shadow:0 0 10px rgba(0,0,0,0.1); border-radius:8px; }
    tbody td { border:none; padding:8px 10px; position:relative; text-align:right; font-size:16px; padding-left:50%; }
    tbody td::before { content:attr(data-label); position:absolute; left:10px; top:8px; font-weight:bold; color:#007bff; }
  }
</style>
</head>
<body>
<h1>لوحة التحكم - جهات الاتصال</h1>
<div class="import-vcf">
  <input type="file" id="vcfFileInput" accept=".vcf" />
  <input type="text" id="ownerInput" placeholder="اسم المالك" />
  <button onclick="importVCF()">رفع ملف VCF</button>
</div>
<div class="search">
  <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الرقم أو الملاحظة" oninput="applyFilters()" />
</div>
<div class="owner-filter">
  <select id="ownerFilter" onchange="applyFilters()">
    <option value="">كل المالكين</option>
  </select>
</div>
<div class="add-form">
  <input type="text" id="nameInput" placeholder="الاسم" />
  <input type="text" id="phoneInput" placeholder="رقم الهاتف" />
  <input type="text" id="noteInput" placeholder="ملاحظة" />
  <input type="text" id="ownerSingleInput" placeholder="اسم المالك" />
  <button onclick="addContact()">إضافة</button>
  <button id="deleteSelectedBtn" class="delete-btn hidden" onclick="deleteSelected()">حذف المحدد</button>
</div>
<table id="contactsTable">
  <thead>
    <tr>
      <th onclick="sortTable('name')">الاسم</th>
      <th onclick="sortTable('phone')">رقم الهاتف</th>
      <th onclick="sortTable('note')">ملاحظة</th>
      <th onclick="sortTable('owner')">اسم المالك</th>
      <th onclick="sortTable('lastModified')">آخر تعديل</th>
      <th class="no-sort">الإجراءات</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase config
defaultConfig = {
  apiKey: "AIzaSyBVZPuoh_jryc6K46mjL61e57wnRrQVlSE",
  authDomain: "past-c2c4d.firebaseapp.com",
  databaseURL: "https://past-c2c4d-default-rtdb.firebaseio.com/",
  projectId: "past-c2c4d",
  storageBucket: "past-c2c4d.appspot.com",
  messagingSenderId: "513264432934",
  appId: "1:513264432934:web:aef1b4a3adf30a67c373e7"
};
firebase.initializeApp(defaultConfig);
const db = firebase.database().ref('contacts');

let contacts = [];

function decodeQP(str) {
  return str.replace(/=([A-F0-9]{2})/gi, (_,h)=>String.fromCharCode(parseInt(h,16))).replace(/=\r?\n/g,'');
}
function parseVCF(data) {
  const arr=[]; data.split(/END:VCARD/gi).forEach(e=>{
    const fn = e.match(/FN(;[^:]*)?:(.*)/i);
    const tel= e.match(/TEL[^:]*:(.*)/i);
    let name=fn?fn[2].trim():'بدون اسم';
    if(name.includes('=')&&e.toUpperCase().includes('ENCODING=QUOTED-PRINTABLE')) name=decodeQP(name);
    name = name.replace(/=\r?\n/g,'').replace(/=\s/g,'');
    if(tel){ const phone=tel[1].trim(); arr.push({name,phone}); }
  }); return arr;
}

function loadContacts(){
  db.on('value',snap=>{
    contacts=[]; snap.forEach(c=>contacts.push({key:c.key,...c.val()}));
    render(); updateOwnerFilter();
  });
}
function render(){
  const t=document.getElementById('tableBody'); t.innerHTML='';
  contacts.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td data-label="الاسم">${c.name||'بدون اسم'}</td>
      <td data-label="رقم الهاتف">${c.phone}</td>
      <td data-label="ملاحظة">${c.note||''}</td>
      <td data-label="اسم المالك">${c.owner||''}</td>
      <td data-label="آخر تعديل">${c.lastModified||''}</td>
      <td data-label="الإجراءات">
        <button onclick="deleteContact('${c.key}')" class="delete-btn">حذف</button>
      </td>
    `; t.appendChild(tr);
  });
}
function addContact(){
  const n=document.getElementById('nameInput').value.trim();
  const p=document.getElementById('phoneInput').value.trim();
  const no=document.getElementById('noteInput').value.trim();
  const o=document.getElementById('ownerSingleInput').value.trim();
  if(!p) return; db.push({name:n||'بدون اسم',phone:p,note:no,owner:o,lastModified:new Date().toLocaleString()});
}
function deleteContact(k){ db.child(k).remove(); }

function importVCF(){
  const f=document.getElementById('vcfFileInput').files[0];
  const owner=document.getElementById('ownerInput').value.trim();
  if(!f) return; const r=new FileReader();
  r.onload=e=>{
    const arr=parseVCF(e.target.result);
    arr.forEach(x=>db.push({name:x.name||'بدون اسم',phone:x.phone,owner, lastModified:new Date().toLocaleString()}));
  };
  r.readAsText(f);
}

function updateOwnerFilter(){
  const sel=document.getElementById('ownerFilter'); sel.innerHTML='<option value="">كل المالكين</option>';
  [...new Set(contacts.map(c=>c.owner).filter(x=>x))].forEach(o=>sel.innerHTML+=`<option>${o}</option>`);
}

function applyFilters(){
  const kv=document.getElementById('searchInput').value.toLowerCase();
  const own=document.getElementById('ownerFilter').value;
  contacts.forEach(c=>c._show=(
    (c.name||'').toLowerCase().includes(kv)||
    c.phone.includes(kv)||
    (c.note||'').toLowerCase().includes(kv)
  )&&(!own||c.owner===own));
  const t=document.getElementById('tableBody'); t.innerHTML='';
  contacts.filter(c=>c._show).forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.name}</td><td>${c.phone}</td><td>${c.note||''}</td><td>${c.owner||''}</td><td>${c.lastModified||''}</td><td><button onclick="deleteContact('${c.key}')" class="delete-btn">حذف</button></td>`;
    t.appendChild(tr);
  });
}
window.onload=loadContacts;
</script>
</body>
</html>
