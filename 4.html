<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة التحكم - جهات الاتصال مع Firebase</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f2f5;
    margin: 0; padding: 20px;
    direction: rtl;
  }
  h1 {
    text-align: center; color: #333;
  }
  .search, .owner-filter {
    margin-bottom: 20px; text-align: center;
  }
  .search input, .owner-filter select {
    width: 300px;
    padding: 10px;
    border: 1px solid #ccc; border-radius: 5px;
    font-size: 16px;
    margin: 5px;
  }
  .add-form, .import-vcf {
    margin: 20px 0; text-align: center;
  }
  .add-form input {
    padding: 8px; margin: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .add-form button, .import-vcf button {
    background-color: #28a745;
    color: white;
    padding: 8px 16px;
    border: none; border-radius: 5px;
    cursor: pointer;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  table th, table td {
    padding: 12px;
    text-align: center;
    border: 1px solid #ddd;
    cursor: pointer;
  }
  table th {
    background-color: #007bff;
    color: white;
  }
  button {
    padding: 6px 10px;
    margin: 2px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .edit-btn { background-color: #ffc107; color: white; }
  .delete-btn { background-color: #dc3545; color: white; }
  .call-btn {
    background-color: #17a2b8;
    color: white;
    text-decoration: none;
    padding: 6px 10px;
    border-radius: 5px;
  }
  .copy-btn { background-color: #6c757d; color: white; }
  .wa-btn {
    background-color: #25D366;
    color: white;
    text-decoration: none;
    padding: 6px 10px;
    border-radius: 5px;
  }
  .fav-btn {
    background-color: transparent;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: gold;
    margin-left: 5px;
  }
  .fav-btn.inactive { color: #ccc; }

  .hidden { display: none; }

  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr { display: none; }
    tbody tr {
      margin-bottom: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background: #fff;
      padding: 15px;
      border-radius: 8px;
    }
    tbody tr td {
      border: none;
      padding: 8px 10px;
      position: relative;
      padding-left: 50%;
      text-align: right;
      font-size: 16px;
    }
    tbody tr td::before {
      content: attr(data-label);
      position: absolute;
      left: 10px;
      top: 8px;
      font-weight: bold;
      color: #007bff;
      font-size: 14px;
    }
    tbody tr td:last-child {
      padding-left: 10px;
      text-align: center;
    }
    tbody tr td:last-child button,
    tbody tr td:last-child a,
    tbody tr td:last-child .fav-btn {
      display: block;
      width: 100%;
      margin: 6px 0;
      font-size: 16px;
    }
    tbody tr td input {
      font-size: 16px;
    }
  }
</style>
</head>
<body>

<h1>لوحة التحكم - جهات الاتصال مع Firebase</h1>

<div class="import-vcf">
  <input type="file" id="vcfFileInput" accept=".vcf" />
  <input type="text" id="ownerInput" placeholder="اسم المالك" />
  <button onclick="importVCF()">رفع ملف VCF</button>
</div>

<div class="search">
  <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الرقم أو الملاحظة" onkeyup="searchTable()" />
</div>

<div class="owner-filter">
  <select id="ownerFilter" onchange="filterByOwner()">
    <option value="">كل المالكين</option>
  </select>
</div>

<div class="add-form">
  <input type="text" id="nameInput" placeholder="الاسم" />
  <input type="text" id="phoneInput" placeholder="رقم الهاتف" />
  <input type="text" id="noteInput" placeholder="ملاحظة" />
  <input type="text" id="ownerSingleInput" placeholder="اسم المالك" />
  <button onclick="addContact()">إضافة</button>
</div>

<div style="text-align: center; margin-bottom: 10px;">
  <button id="deleteSelectedBtn" class="delete-btn hidden" onclick="deleteSelected()">حذف المحدد</button>
</div>

<table id="contactsTable">
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" /></th>
      <th onclick="sortTable(1)">الاسم</th>
      <th onclick="sortTable(2)">رقم الهاتف</th>
      <th onclick="sortTable(3)">ملاحظة</th>
      <th onclick="sortTable(4)">اسم المالك</th>
      <th onclick="sortTable(5)">آخر تعديل</th>
      <th>الإجراءات</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ======== Firebase Configuration ========
  const firebaseConfig = {
    apiKey: "AIzaSyBVZPuoh_jryc6K46mjL61e57wnRrQVlSE",
    authDomain: "past-c2c4d.firebaseapp.com",
    databaseURL: "https://past-c2c4d-default-rtdb.firebaseio.com/",
    projectId: "past-c2c4d",
    storageBucket: "past-c2c4d.appspot.com",
    messagingSenderId: "513264432934",
    appId: "1:513264432934:web:aef1b4a3adf30a67c373e7",
    measurementId: "G-GBHGM21BP0"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const contactsRef = db.ref('contacts');

  // --- فك ترميز QUOTED-PRINTABLE مع دعم UTF-8 ---
  function decodeQuotedPrintable(str) {
    // Remove soft line breaks (like "= \n" or "=\r\n")
    str = str.replace(/=\r?\n/g, '');

    // Replace encoded characters and try to decode as UTF-8
    try {
      // Decode hex sequences to their raw byte values
      const decodedBytes = str.replace(/=([0-9A-F]{2})/gi, (match, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
      });
      // Use decodeURIComponent to interpret these byte values as UTF-8
      // escape() is crucial for handling multi-byte UTF-8 characters correctly before decodeURIComponent.
      return decodeURIComponent(escape(decodedBytes));
    } catch (e) {
      // Fallback if UTF-8 decoding fails (e.g., malformed sequence)
      console.warn("Failed to decode as UTF-8, falling back. Error:", e);
      return str.replace(/=([A-F0-9]{2})/gi, (match, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
      });
    }
  }

  // --- تحليل ملف VCF ---
  function parseVCF(data) {
    const contacts = [];
    // Split by END:VCARD followed by one or more newlines (robust for various VCF endings)
    const entries = data.split(/END:VCARD\r?\n+/gi);
    
    entries.forEach(entry => {
      if (!entry.trim()) return; // Skip empty entries

      let name = '';
      const phones = []; // Array to hold multiple phone numbers
      let note = ''; // Changed from notes to note for consistency with single field

      // Determine if charset and encoding are specified for the current vCard entry
      const isQuotedPrintableUtf8 = entry.toUpperCase().includes('CHARSET=UTF-8') && entry.toUpperCase().includes('ENCODING=QUOTED-PRINTABLE');

      // 1. Try to find FN (Full Name) field first (more robust regex for properties)
      // Example: FN;CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE:=D9=88=D8=B3=D9=8A=D9=85=20=D9=85=D8=AD=D9=8A=D8=B3=D9=86=20=32
      // Captures anything after the colon until a newline or end of string
      const fnMatch = entry.match(/FN(?:;[^:]*)?:\s*(.*)/i);
      if (fnMatch && fnMatch[1]) {
        name = fnMatch[1].trim();
        if (isQuotedPrintableUtf8) {
          name = decodeQuotedPrintable(name);
        }
        name = name.replace(/;;;/g, '').trim(); // Clean up common VCF artifacts (e.g., empty components)
      }

      // 2. If FN is empty or not found, try to reconstruct from N (Name) field
      // N:family;given;middle;prefix;suffix
      if (!name) {
        const nMatch = entry.match(/N(?:;[^:]*)?:([^;]*);([^;]*);([^;]*);([^;]*);([^;]*)/i);
        if (nMatch) {
          let lastName = nMatch[1] || '';
          let firstName = nMatch[2] || '';
          let middleName = nMatch[3] || '';
          // You can also include prefix/suffix if desired: nMatch[4], nMatch[5]
          
          let combinedName = [firstName, middleName, lastName].filter(Boolean).join(' ').trim();

          if (isQuotedPrintableUtf8) {
            combinedName = decodeQuotedPrintable(combinedName);
          }
          if (combinedName) {
            name = combinedName;
          }
        }
      }
      
      // Fallback: If name is still empty, check for ORG (Organization)
      // Some VCFs might only have an organization name.
      if (!name) {
          const orgMatch = entry.match(/ORG(?:;[^:]*)?:(.*)/i);
          if (orgMatch && orgMatch[1]) {
              name = orgMatch[1].trim();
              if (isQuotedPrintableUtf8) {
                  name = decodeQuotedPrintable(name);
              }
              name = name.replace(/;;/g, '').trim(); // Clean up
          }
      }


      // 3. Find TEL (Telephone) fields - handle multiple numbers
      // This regex is robust for various TEL formats (e.g., TEL;CELL:, TEL;TYPE=WORK:, TEL:tel:...)
      // The `g` flag ensures all occurrences are matched.
      const telMatches = entry.match(/TEL(?:;[^:]*)?:(.*)/gi);
      if (telMatches) {
        telMatches.forEach(telLine => {
          // Extract the number part after the last colon, and clean it
          let phone = telLine.split(':').pop().trim();
          phone = phone.replace(/[^\d+]/g, ''); // Remove non-digits, keep leading '+'
          if (phone.startsWith('tel:')) { // Remove 'tel:' URI prefix if present
            phone = phone.substring(4);
          }
          if (phone) { // Only add if phone number is not empty
            phones.push(phone);
          }
        });
      }

      // 4. Find NOTE field
      const noteMatch = entry.match(/NOTE(?:;[^:]*)?:(.*)/i);
      if (noteMatch && noteMatch[1]) {
        note = noteMatch[1].trim();
        if (isQuotedPrintableUtf8) {
          note = decodeQuotedPrintable(note);
        }
        note = note.replace(/=\r?\n/g, '').trim(); // Remove soft line breaks within notes
      }


      // 5. Add contact entry for EACH phone number found
      // This ensures all numbers are captured, even if a contact has multiple.
      if (phones.length > 0) {
        phones.forEach(currentPhone => {
          let contactName = name;
          if (!contactName) {
              // If no name is found, assign a default name based on the phone number
              contactName = `رقم بدون اسم (${currentPhone})`;
          }
          contacts.push({ name: contactName, phone: currentPhone, note: note });
        });
      } else if (name) {
          // Case: Has a name but no phone number found in TEL field
          // This case is less common for "contacts" but could happen.
          // You might choose to skip these or add them with an empty phone.
          // For now, let's add them as they explicitly asked to capture ALL names.
           contacts.push({ name: name, phone: '', note: note });
      }
    });
    return contacts;
  }

  // تحميل جهات الاتصال من Firebase وعرضها
  function loadContacts() {
    contactsRef.off();
    contactsRef.on('value', snapshot => {
      const data = snapshot.val() || {};
      renderTable(data);
      updateOwnerFilter(data);
    });
  }

  // عرض البيانات في الجدول
  function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    const contactsArray = Object.entries(data).map(([key, val]) => {
      return { key, ...val };
    });

    contactsArray.sort((a, b) => a.name.localeCompare(b.name, 'ar', { sensitivity: 'base' })); // Added 'ar' locale for Arabic sorting

    contactsArray.forEach(contact => {
      const tr = document.createElement('tr');
      tr.id = contact.key;

      tr.innerHTML = `
        <td data-label="تحديد"><input type="checkbox" class="select-contact" data-key="${contact.key}" onchange="updateSelected()" /></td>
        <td data-label="الاسم"><input type="text" value="${escapeHTML(contact.name)}" disabled /></td>
        <td data-label="رقم الهاتف"><input type="text" value="${escapeHTML(contact.phone)}" disabled /></td>
        <td data-label="ملاحظة"><input type="text" value="${escapeHTML(contact.note || '')}" disabled /></td>
        <td data-label="اسم المالك"><input type="text" value="${escapeHTML(contact.owner || '')}" disabled /></td>
        <td data-label="آخر تعديل"><input type="text" value="${escapeHTML(contact.lastModified || '')}" disabled /></td>
        <td data-label="الإجراءات">
          <button class="edit-btn" onclick="enableEdit('${contact.key}')">تعديل</button>
          <button class="delete-btn" onclick="deleteContact('${contact.key}')">حذف</button>
          <button class="copy-btn" onclick="copyPhone('${escapeHTML(contact.phone)}')">نسخ</button>
          <a class="call-btn" href="tel:${escapeHTML(contact.phone)}">اتصال</a>
          <a class="wa-btn" href="https://wa.me/970${escapeHTML(contact.phone)}" target="_blank">واتساب 970+</a>
          <a class="wa-btn" href="https://wa.me/972${escapeHTML(contact.phone)}" target="_blank">واتساب 972+</a>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  // Utility function to escape HTML to prevent XSS and display issues
  function escapeHTML(str) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  // إضافة جهة اتصال جديدة إلى Firebase
  function addContact() {
    const name = document.getElementById('nameInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();
    const note = document.getElementById('noteInput').value.trim();
    const owner = document.getElementById('ownerSingleInput').value.trim();
    if (!name || !phone) {
      alert('يرجى إدخال الاسم ورقم الهاتف');
      return;
    }
    const newContactRef = contactsRef.push();
    newContactRef.set({
      name,
      phone,
      note,
      owner,
      lastModified: new Date().toLocaleString()
    });
    clearInputs();
  }

  // مسح حقول الإدخال
  function clearInputs() {
    document.getElementById('nameInput').value = '';
    document.getElementById('phoneInput').value = '';
    document.getElementById('noteInput').value = '';
    document.getElementById('ownerSingleInput').value = '';
  }

  // تفعيل وضع التعديل وحفظ التغييرات في Firebase
  function enableEdit(key) {
    const row = document.getElementById(key);
    const inputs = row.querySelectorAll('input[type=text]');
    const editBtn = row.querySelector('.edit-btn');

    if (editBtn.innerText === 'تعديل') {
      inputs.forEach(input => input.disabled = false);
      editBtn.innerText = 'حفظ';
    } else {
      // حفظ التعديلات في Firebase
      const updatedName = inputs[0].value.trim();
      const updatedPhone = inputs[1].value.trim();
      const updatedNote = inputs[2].value.trim();
      const updatedOwner = inputs[3].value.trim();

      if (!updatedName || !updatedPhone) {
        alert('الاسم ورقم الهاتف لا يمكن أن يكونا فارغين');
        return;
      }
      contactsRef.child(key).update({
        name: updatedName,
        phone: updatedPhone,
        note: updatedNote,
        owner: updatedOwner,
        lastModified: new Date().toLocaleString()
      });
      inputs.forEach(input => input.disabled = true);
      editBtn.innerText = 'تعديل';
    }
  }

  // حذف جهة اتصال من Firebase
  function deleteContact(key) {
    if (confirm('هل أنت متأكد من حذف جهة الاتصال؟')) {
      contactsRef.child(key).remove();
      updateSelected();
    }
  }

  // نسخ رقم الهاتف
  function copyPhone(phone) {
    navigator.clipboard.writeText(phone).then(() => {
      alert('تم نسخ الرقم: ' + phone);
    });
  }

  // البحث في الجدول
  function searchTable() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#contactsTable tbody tr');
    rows.forEach(row => {
      const name = row.cells[1].querySelector('input').value.toLowerCase();
      const phone = row.cells[2].querySelector('input').value.toLowerCase();
      const note = row.cells[3].querySelector('input').value.toLowerCase();
      const owner = row.cells[4].querySelector('input').value.toLowerCase();
      row.style.display = (name.includes(input) || phone.includes(input) || note.includes(input) || owner.includes(input)) ? '' : 'none';
    });
  }

  // فلترة حسب المالك
  function filterByOwner() {
    const ownerFilter = document.getElementById('ownerFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#contactsTable tbody tr');
    rows.forEach(row => {
      const owner = row.cells[4].querySelector('input').value.toLowerCase();
      row.style.display = (ownerFilter === '' || owner === ownerFilter) ? '' : 'none';
    });
  }

  // تحديث قائمة الفلاتر الخاصة بالمالكين
  function updateOwnerFilter(data) {
    const ownerFilter = document.getElementById('ownerFilter');
    const owners = new Set(Object.values(data).map(c => c.owner).filter(o => o));
    ownerFilter.innerHTML = '<option value="">كل المالكين</option>';
    Array.from(owners).sort((a, b) => a.localeCompare(b, 'ar', { sensitivity: 'base' })).forEach(owner => { // Added 'ar' locale for Arabic sorting
      const option = document.createElement('option');
      option.value = owner.toLowerCase();
      option.textContent = owner;
      ownerFilter.appendChild(option);
    });
  }

  // استيراد ملف VCF مع رفع البيانات إلى Firebase
  function importVCF() {
    const fileInput = document.getElementById('vcfFileInput');
    const file = fileInput.files[0];
    const ownerName = document.getElementById('ownerInput').value.trim();

    if (!file) {
      alert('يرجى اختيار ملف VCF أولاً');
      return;
    }
    if (!ownerName) {
      alert('يرجى إدخال اسم المالك');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const contacts = parseVCF(text);
      if (contacts.length === 0) {
        alert('لم يتم العثور على جهات اتصال في الملف');
        return;
      }
      let addedCount = 0;
      contacts.forEach(c => {
        // We now allow contacts with only a name (phone empty) or only a phone (name default)
        if (c.name || c.phone) { // Ensure at least name or phone is present
          const newContactRef = contactsRef.push();
          newContactRef.set({
            name: c.name || '', // Store empty string if name is not found, rather than null
            phone: c.phone || '', // Store empty string if phone is not found
            note: c.note || '',
            owner: ownerName,
            lastModified: new Date().toLocaleString()
          });
          addedCount++;
        }
      });
      alert(`تمت إضافة ${addedCount} جهة اتصال`);
      fileInput.value = '';
      document.getElementById('ownerInput').value = '';
    };
    reader.readAsText(file);
  }

  // تحديد / إلغاء تحديد الكل
  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.select-contact');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelected();
  }

  // تحديث ظهور زر الحذف عند تحديد جهات اتصال
  function updateSelected() {
    const selected = document.querySelectorAll('.select-contact:checked');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    if (selected.length > 0) {
      deleteBtn.classList.remove('hidden');
    } else {
      deleteBtn.classList.add('hidden');
    }
  }

  // حذف جهات الاتصال المحددة من Firebase
  function deleteSelected() {
    if (confirm('هل أنت متأكد من حذف جهات الاتصال المحددة؟')) {
      const selected = document.querySelectorAll('.select-contact:checked');
      selected.forEach(cb => {
        const key = cb.getAttribute('data-key');
        contactsRef.child(key).remove();
      });
    }
  }

  // تمكين الترتيب عند الضغط على رأس الجدول
  let sortDirection = {};
  function sortTable(colIndex) {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const direction = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
    sortDirection[colIndex] = direction;

    rows.sort((a, b) => {
      let valA = a.cells[colIndex].querySelector('input').value.toLowerCase();
      let valB = b.cells[colIndex].querySelector('input').value.toLowerCase();

      // Use localeCompare for correct Arabic sorting on Name and Owner columns
      if (colIndex === 1 || colIndex === 4) { // Name and Owner columns
        if (direction === 'asc') {
          return valA.localeCompare(valB, 'ar', { sensitivity: 'base' });
        } else {
          return valB.localeCompare(valA, 'ar', { sensitivity: 'base' });
        }
      } else {
        // For other columns (like phone, note, last modified), standard comparison
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      }
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  // تحميل البيانات عند فتح الصفحة
  window.onload = function () {
    loadContacts();
  };
</script>

</body>
</html>
