<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة التحكم - جهات الاتصال مع Firebase</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f2f5;
    margin: 0; padding: 15px; /* Reduced padding for smaller screens */
    direction: rtl;
    line-height: 1.6;
  }
  h1 {
    text-align: center; color: #333;
    font-size: 24px; /* Adjusted for mobile */
    margin-bottom: 20px;
  }
  .section-container {
    background-color: #fff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .search, .owner-filter, .add-form, .import-vcf {
    text-align: center;
  }
  input[type="text"], input[type="file"], select {
    width: calc(100% - 20px); /* Adjust width for padding */
    max-width: 350px; /* Max width for larger screens */
    padding: 10px;
    margin: 8px 0; /* More vertical space */
    border: 1px solid #ccc; border-radius: 5px;
    font-size: 15px; /* Slightly smaller for mobile */
    box-sizing: border-box; /* Include padding in width */
  }
  button, .call-btn, .wa-btn {
    background-color: #007bff;
    color: white;
    padding: 10px 15px; /* Larger touch targets */
    margin: 5px; /* Consistent margin */
    border: none; border-radius: 5px;
    cursor: pointer;
    font-size: 15px; /* Consistent font size */
    transition: background-color 0.2s;
    width: auto; /* Allow buttons to size naturally */
    display: inline-block; /* For proper spacing */
  }
  button:hover, .call-btn:hover, .wa-btn:hover {
    background-color: #0056b3;
  }
  .add-form button { background-color: #28a745; }
  .add-form button:hover { background-color: #218838; }

  .edit-btn { background-color: #ffc107; color: white; }
  .edit-btn:hover { background-color: #e0a800; }
  .delete-btn { background-color: #dc3545; color: white; }
  .delete-btn:hover { background-color: #c82333; }
  .copy-btn { background-color: #6c757d; color: white; }
  .copy-btn:hover { background-color: #5a6268; }
  .call-btn { background-color: #17a2b8; }
  .call-btn:hover { background-color: #138496; }
  .wa-btn { background-color: #25D366; }
  .wa-btn:hover { background-color: #1eaf53; }

  .stats-bar {
    text-align: center;
    margin-bottom: 15px;
    font-size: 16px;
    color: #555;
  }
  .delete-selected-container {
    text-align: center;
    margin-top: 10px;
    margin-bottom: 15px;
  }
  .hidden { display: none; }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-top: 20px;
  }
  table th, table td {
    padding: 10px; /* Adjusted padding */
    text-align: center;
    border: 1px solid #ddd;
    font-size: 14px; /* Adjusted font size for table cells */
  }
  table th {
    background-color: #007bff;
    color: white;
    cursor: pointer;
    white-space: nowrap; /* Prevent wrapping for headers */
  }
  table td input[type="text"] {
    width: calc(100% - 10px); /* Adjust input width in table cells */
    padding: 5px;
    margin: 0;
    font-size: 14px;
    border: 1px solid #eee; /* Lighter border for inputs */
  }
  table td input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  /* Responsive Design for smaller screens */
  @media (max-width: 768px) {
    body {
      padding: 10px; /* Even less padding on very small screens */
    }
    h1 {
      font-size: 20px;
    }
    .section-container {
        padding: 10px;
    }
    input[type="text"], input[type="file"], select {
      width: calc(100% - 16px); /* Account for padding in input */
      font-size: 14px;
      margin: 6px 0;
    }
    button, .call-btn, .wa-btn {
      padding: 8px 12px;
      font-size: 14px;
      margin: 4px;
    }
    /* Make table stack on small screens */
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    tbody tr {
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background: #fff;
      padding: 15px;
      border-radius: 8px;
    }
    tbody tr td {
      border: none;
      position: relative;
      padding-left: 50%; /* Space for data-label */
      text-align: right;
      font-size: 15px; /* Larger font for readability */
    }
    tbody tr td::before {
      content: attr(data-label);
      position: absolute;
      left: 10px;
      top: 10px; /* Adjusted top for padding */
      font-weight: bold;
      color: #007bff;
      font-size: 13px;
      white-space: nowrap; /* Prevent label wrapping */
    }
    tbody tr td:last-child { /* Actions column */
      padding-left: 10px;
      text-align: center;
      display: flex; /* Use flexbox for button alignment */
      flex-wrap: wrap; /* Allow buttons to wrap */
      justify-content: center; /* Center buttons */
      gap: 5px; /* Space between buttons */
    }
    tbody tr td:last-child button,
    tbody tr td:last-child a {
      flex: 1 1 auto; /* Allow buttons to grow/shrink */
      min-width: 80px; /* Minimum width for buttons */
      font-size: 14px;
      padding: 8px 10px;
    }
    tbody tr td input[type="text"] {
      width: calc(100% - 5px); /* Adjusted width for inputs in stacked table */
      padding: 6px;
      font-size: 15px;
    }
    .stats-bar, .delete-selected-container {
        font-size: 15px;
        padding: 5px;
    }
  }
</style>
</head>
<body>

<h1>لوحة التحكم - جهات الاتصال مع Firebase</h1>

<div class="section-container import-vcf">
  <input type="file" id="vcfFileInput" accept=".vcf" />
  <input type="text" id="ownerInput" placeholder="اسم المالك" />
  <button onclick="importVCF()">رفع ملف VCF</button>
</div>

<div class="section-container search">
  <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الرقم أو الملاحظة" onkeyup="searchTable()" />
</div>

<div class="section-container owner-filter">
  <select id="ownerFilter" onchange="filterByOwner()">
    <option value="">كل المالكين</option>
  </select>
</div>

<div class="section-container add-form">
  <input type="text" id="nameInput" placeholder="الاسم" />
  <input type="text" id="phoneInput" placeholder="رقم الهاتف" />
  <input type="text" id="noteInput" placeholder="ملاحظة" />
  <input type="text" id="ownerSingleInput" placeholder="اسم المالك" />
  <button onclick="addContact()">إضافة</button>
</div>

<div class="stats-bar">
  <span id="totalContacts">إجمالي جهات الاتصال: 0</span> |
  <span id="selectedContacts">المحدد: 0</span>
</div>

<div class="delete-selected-container">
  <button id="deleteSelectedBtn" class="delete-btn hidden" onclick="deleteSelected()">حذف المحدد</button>
</div>

<table id="contactsTable">
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" /></th>
      <th onclick="sortTable(1)">الاسم</th>
      <th onclick="sortTable(2)">رقم الهاتف</th>
      <th onclick="sortTable(3)">ملاحظة</th>
      <th onclick="sortTable(4)">اسم المالك</th>
      <th onclick="sortTable(5)">آخر تعديل</th>
      <th>الإجراءات</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ======== Firebase Configuration ========
  const firebaseConfig = {
    apiKey: "AIzaSyBVZPuoh_jryc6K46mjL61e57wnRrQVlSE",
    authDomain: "past-c2c4d.firebaseapp.com",
    databaseURL: "https://past-c2c4d-default-rtdb.firebaseio.com/",
    projectId: "past-c2c4d",
    storageBucket: "past-c2c4d.appspot.com",
    messagingSenderId: "513264432934",
    appId: "1:513264432934:web:aef1b4a3adf30a67c373e7",
    measurementId: "G-GBHGM21BP0"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const contactsRef = db.ref('contacts');

  // --- فك ترميز QUOTED-PRINTABLE مع دعم UTF-8 ---
  function decodeQuotedPrintable(str) {
    str = str.replace(/=\r?\n/g, ''); // Remove soft line breaks
    try {
      const decodedBytes = str.replace(/=([0-9A-F]{2})/gi, (match, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
      });
      return decodeURIComponent(escape(decodedBytes));
    } catch (e) {
      console.warn("Failed to decode as UTF-8, falling back. Error:", e);
      return str.replace(/=([A-F0-9]{2})/gi, (match, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
      });
    }
  }

  // --- تحليل ملف VCF ---
  function parseVCF(data) {
    const contacts = [];
    const entries = data.split(/END:VCARD\r?\n+/gi);
    
    entries.forEach(entry => {
      if (!entry.trim()) return;

      let name = '';
      const phones = [];
      let note = '';

      const isQuotedPrintableUtf8 = entry.toUpperCase().includes('CHARSET=UTF-8') && entry.toUpperCase().includes('ENCODING=QUOTED-PRINTABLE');

      // 1. Try to find FN (Full Name) field first
      const fnMatch = entry.match(/FN(?:;[^:]*)?:\s*(.*)/i);
      if (fnMatch && fnMatch[1]) {
        name = fnMatch[1].trim();
        if (isQuotedPrintableUtf8) {
          name = decodeQuotedPrintable(name);
        }
        name = name.replace(/;;;/g, '').trim();
      }

      // 2. If FN is empty or not found, try to reconstruct from N (Name) field
      if (!name) {
        const nMatch = entry.match(/N(?:;[^:]*)?:([^;]*);([^;]*);([^;]*);([^;]*);([^;]*)/i);
        if (nMatch) {
          let lastName = nMatch[1] || '';
          let firstName = nMatch[2] || '';
          let middleName = nMatch[3] || '';
          
          let combinedName = [firstName, middleName, lastName].filter(Boolean).join(' ').trim();

          if (isQuotedPrintableUtf8) {
            combinedName = decodeQuotedPrintable(combinedName);
          }
          if (combinedName) {
            name = combinedName;
          }
        }
      }
      
      // Fallback: If name is still empty, check for ORG (Organization)
      if (!name) {
          const orgMatch = entry.match(/ORG(?:;[^:]*)?:(.*)/i);
          if (orgMatch && orgMatch[1]) {
              name = orgMatch[1].trim();
              if (isQuotedPrintableUtf8) {
                  name = decodeQuotedPrintable(name);
              }
              name = name.replace(/;;/g, '').trim();
          }
      }

      // 3. Find TEL (Telephone) fields
      const telMatches = entry.match(/TEL(?:;[^:]*)?:(.*)/gi);
      if (telMatches) {
        telMatches.forEach(telLine => {
          let phone = telLine.split(':').pop().trim();
          phone = phone.replace(/[^\d+]/g, '');
          if (phone.startsWith('tel:')) {
            phone = phone.substring(4);
          }
          if (phone) {
            phones.push(phone);
          }
        });
      }

      // 4. Find NOTE field
      const noteMatch = entry.match(/NOTE(?:;[^:]*)?:(.*)/i);
      if (noteMatch && noteMatch[1]) {
        note = noteMatch[1].trim();
        if (isQuotedPrintableUtf8) {
          note = decodeQuotedPrintable(note);
        }
        note = note.replace(/=\r?\n/g, '').trim();
      }

      // 5. Add contact entry
      if (phones.length > 0) {
        phones.forEach(currentPhone => {
          let contactName = name;
          if (!contactName) {
              contactName = `رقم بدون اسم (${currentPhone})`;
          }
          contacts.push({ name: contactName, phone: currentPhone, note: note });
        });
      } else if (name) {
          // Add contacts with names but no phones
           contacts.push({ name: name, phone: '', note: note });
      }
    });
    return contacts;
  }

  // تحميل جهات الاتصال من Firebase وعرضها
  function loadContacts() {
    contactsRef.off();
    contactsRef.on('value', snapshot => {
      const data = snapshot.val() || {};
      renderTable(data);
      updateOwnerFilter(data);
      updateStats(); // Update stats after rendering
    });
  }

  // عرض البيانات في الجدول
  function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    const contactsArray = Object.entries(data).map(([key, val]) => {
      return { key, ...val };
    });

    contactsArray.sort((a, b) => a.name.localeCompare(b.name, 'ar', { sensitivity: 'base' }));

    contactsArray.forEach(contact => {
      const tr = document.createElement('tr');
      tr.id = contact.key;

      tr.innerHTML = `
        <td data-label="تحديد"><input type="checkbox" class="select-contact" data-key="${contact.key}" onchange="updateSelected()" /></td>
        <td data-label="الاسم"><input type="text" value="${escapeHTML(contact.name)}" disabled /></td>
        <td data-label="رقم الهاتف"><input type="text" value="${escapeHTML(contact.phone)}" disabled /></td>
        <td data-label="ملاحظة"><input type="text" value="${escapeHTML(contact.note || '')}" disabled /></td>
        <td data-label="اسم المالك"><input type="text" value="${escapeHTML(contact.owner || '')}" disabled /></td>
        <td data-label="آخر تعديل"><input type="text" value="${escapeHTML(contact.lastModified || '')}" disabled /></td>
        <td data-label="الإجراءات">
          <button class="edit-btn" onclick="enableEdit('${contact.key}')">تعديل</button>
          <button class="delete-btn" onclick="deleteContact('${contact.key}')">حذف</button>
          <button class="copy-btn" onclick="copyPhone('${escapeHTML(contact.phone)}')">نسخ</button>
          <a class="call-btn" href="tel:${escapeHTML(contact.phone)}">اتصال</a>
          <a class="wa-btn" href="https://wa.me/970${escapeHTML(contact.phone)}" target="_blank">واتساب 970+</a>
          <a class="wa-btn" href="https://wa.me/972${escapeHTML(contact.phone)}" target="_blank">واتساب 972+</a>
        </td>
      `;

      tbody.appendChild(tr);
    });
    updateStats(); // Update stats after rendering the table
  }

  function escapeHTML(str) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  function addContact() {
    const name = document.getElementById('nameInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();
    const note = document.getElementById('noteInput').value.trim();
    const owner = document.getElementById('ownerSingleInput').value.trim();
    if (!name && !phone) { // Allow adding if only name or only phone is present
      alert('يرجى إدخال الاسم أو رقم الهاتف على الأقل');
      return;
    }
    const newContactRef = contactsRef.push();
    newContactRef.set({
      name: name || '',
      phone: phone || '',
      note: note || '',
      owner: owner || '',
      lastModified: new Date().toLocaleString()
    });
    clearInputs();
  }

  function clearInputs() {
    document.getElementById('nameInput').value = '';
    document.getElementById('phoneInput').value = '';
    document.getElementById('noteInput').value = '';
    document.getElementById('ownerSingleInput').value = '';
  }

  function enableEdit(key) {
    const row = document.getElementById(key);
    const inputs = row.querySelectorAll('input[type=text]');
    const editBtn = row.querySelector('.edit-btn');

    if (editBtn.innerText === 'تعديل') {
      inputs.forEach(input => input.disabled = false);
      editBtn.innerText = 'حفظ';
    } else {
      const updatedName = inputs[0].value.trim();
      const updatedPhone = inputs[1].value.trim();
      const updatedNote = inputs[2].value.trim();
      const updatedOwner = inputs[3].value.trim();

      if (!updatedName && !updatedPhone) {
        alert('الاسم ورقم الهاتف لا يمكن أن يكونا فارغين في نفس الوقت');
        return;
      }
      contactsRef.child(key).update({
        name: updatedName || '',
        phone: updatedPhone || '',
        note: updatedNote || '',
        owner: updatedOwner || '',
        lastModified: new Date().toLocaleString()
      });
      inputs.forEach(input => input.disabled = true);
      editBtn.innerText = 'تعديل';
    }
  }

  function deleteContact(key) {
    if (confirm('هل أنت متأكد من حذف جهة الاتصال؟')) {
      contactsRef.child(key).remove();
      updateSelected();
    }
  }

  function copyPhone(phone) {
    navigator.clipboard.writeText(phone).then(() => {
      alert('تم نسخ الرقم: ' + phone);
    }).catch(err => {
      console.error('Failed to copy text: ', err);
      alert('فشل نسخ الرقم. يرجى النسخ يدويًا.');
    });
  }

  function searchTable() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#contactsTable tbody tr');
    let visibleRowCount = 0;
    rows.forEach(row => {
      const name = row.cells[1].querySelector('input').value.toLowerCase();
      const phone = row.cells[2].querySelector('input').value.toLowerCase();
      const note = row.cells[3].querySelector('input').value.toLowerCase();
      const owner = row.cells[4].querySelector('input').value.toLowerCase();
      const isVisible = (name.includes(input) || phone.includes(input) || note.includes(input) || owner.includes(input));
      row.style.display = isVisible ? '' : 'none';
      if (isVisible) {
        visibleRowCount++;
      }
    });
    updateStats(visibleRowCount); // Update stats based on visible rows
  }

  function filterByOwner() {
    const ownerFilter = document.getElementById('ownerFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#contactsTable tbody tr');
    let visibleRowCount = 0;
    rows.forEach(row => {
      const owner = row.cells[4].querySelector('input').value.toLowerCase();
      const isVisible = (ownerFilter === '' || owner === ownerFilter);
      row.style.display = isVisible ? '' : 'none';
      if (isVisible) {
        visibleRowCount++;
      }
    });
    updateStats(visibleRowCount); // Update stats based on visible rows
  }

  function updateOwnerFilter(data) {
    const ownerFilter = document.getElementById('ownerFilter');
    const owners = new Set(Object.values(data).map(c => c.owner).filter(o => o));
    ownerFilter.innerHTML = '<option value="">كل المالكين</option>';
    Array.from(owners).sort((a, b) => a.localeCompare(b, 'ar', { sensitivity: 'base' })).forEach(owner => {
      const option = document.createElement('option');
      option.value = owner.toLowerCase();
      option.textContent = owner;
      ownerFilter.appendChild(option);
    });
  }

  function importVCF() {
    const fileInput = document.getElementById('vcfFileInput');
    const file = fileInput.files[0];
    const ownerName = document.getElementById('ownerInput').value.trim();

    if (!file) {
      alert('يرجى اختيار ملف VCF أولاً');
      return;
    }
    if (!ownerName) {
      alert('يرجى إدخال اسم المالك');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const contacts = parseVCF(text);
      if (contacts.length === 0) {
        alert('لم يتم العثور على جهات اتصال في الملف');
        return;
      }
      let addedCount = 0;
      contacts.forEach(c => {
        if (c.name || c.phone) {
          const newContactRef = contactsRef.push();
          newContactRef.set({
            name: c.name || '',
            phone: c.phone || '',
            note: c.note || '',
            owner: ownerName,
            lastModified: new Date().toLocaleString()
          });
          addedCount++;
        }
      });
      alert(`تمت إضافة ${addedCount} جهة اتصال`);
      fileInput.value = '';
      document.getElementById('ownerInput').value = '';
    };
    reader.readAsText(file);
  }

  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.select-contact');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelected();
  }

  // تحديث ظهور زر الحذف وعداد المحدد
  function updateSelected() {
    const selected = document.querySelectorAll('.select-contact:checked');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    
    document.getElementById('selectedContacts').textContent = `المحدد: ${selected.length}`;

    if (selected.length > 0) {
      deleteBtn.classList.remove('hidden');
    } else {
      deleteBtn.classList.add('hidden');
      document.getElementById('selectAll').checked = false; // Uncheck select all if nothing is selected
    }
  }

  // تحديث إحصائيات الصفوف
  function updateStats(visibleCount = null) {
    const totalRows = document.querySelectorAll('#contactsTable tbody tr').length;
    const currentVisibleRows = visibleCount !== null ? visibleCount : totalRows;

    document.getElementById('totalContacts').textContent = `إجمالي جهات الاتصال: ${currentVisibleRows}`;
    updateSelected(); // Also update selected count here
  }

  function deleteSelected() {
    if (confirm('هل أنت متأكد من حذف جهات الاتصال المحددة؟')) {
      const selected = document.querySelectorAll('.select-contact:checked');
      selected.forEach(cb => {
        const key = cb.getAttribute('data-key');
        contactsRef.child(key).remove();
      });
      document.getElementById('selectAll').checked = false; // Uncheck select all after deletion
    }
  }

  let sortDirection = {};
  function sortTable(colIndex) {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const direction = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
    sortDirection[colIndex] = direction;

    rows.sort((a, b) => {
      let valA = a.cells[colIndex].querySelector('input').value.toLowerCase();
      let valB = b.cells[colIndex].querySelector('input').value.toLowerCase();

      if (colIndex === 1 || colIndex === 4) {
        if (direction === 'asc') {
          return valA.localeCompare(valB, 'ar', { sensitivity: 'base' });
        } else {
          return valB.localeCompare(valA, 'ar', { sensitivity: 'base' });
        }
      } else {
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      }
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  window.onload = function () {
    loadContacts();
  };
</script>

</body>
</html>
