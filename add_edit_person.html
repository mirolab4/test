<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة / تعديل شخص</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Auth Guard Script - MUST BE LOADED FIRST -->
    <script type="module" src="auth_guard.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right; /* Align text to the right */
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded corners */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Light gray */
            color: #374151; /* Dark gray text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Darker light gray */
        }
        .input-field {
            border: 1px solid #d1d5db; /* Light gray border */
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
        }
        .input-group {
            position: relative;
        }
        .suggestions-list {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .suggestions-list-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestions-list-item:hover {
            background-color: #f3f4f6;
        }
        .suggestions-list-item:last-child {
            border-bottom: none;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: left; /* Align to left for RTL */
            font-size: 28px;
            font-weight: bold;
            cursor: pointer; /* Add cursor pointer for better UX */
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        .relation-item { /* Unified style for child and spouse list items */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .relation-item:last-child {
            border-bottom: none;
        }
        .error-message {
            color: #ef4444; /* Red color for errors */
            font-size: 0.875rem; /* Small text */
            margin-top: 0.25rem;
            text-align: right;
        }
        .input-field.error {
            border-color: #ef4444; /* Red border for invalid fields */
        }
        /* Loading Modal Specific Styles */
        #loadingModal .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span id="closeMessageModalBtn" class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="confirmMessageModalBtn" class="btn-primary">حسناً</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="spinner"></div>
            <p class="text-lg font-semibold text-gray-800">جارٍ حفظ البيانات...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header and Navigation -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">إضافة شخص جديد</h1>
            <nav class="flex flex-wrap gap-3" id="mainNav">
                <a href="dashboard.html" class="btn-secondary nav-link" data-page="dashboard.html" style="display:none;">لوحة التحكم</a>
                <a href="index.html" class="btn-secondary nav-link" data-page="index.html" style="display:none;">قائمة العائلة</a>
                <a href="events.html" class="btn-secondary nav-link" data-page="events.html" style="display:none;">الأحداث</a>
                <a href="family_tree.html" class="btn-secondary nav-link" data-page="family_tree.html" style="display:none;">شجرة العائلة</a>
                <a href="add_edit_person.html" class="btn-primary">إضافة شخص جديد</a>
                <a href="export_data.html" class="btn-secondary nav-link" data-page="export_data.html" style="display:none;">تصدير البيانات</a>
                <a href="statistics.html" class="btn-secondary nav-link" data-page="statistics.html" style="display:none;">الإحصائيات</a>
                <a href="admin_panel.html" class="btn-secondary nav-link" data-page="admin_panel.html" style="display:none;">لوحة المدير</a>
                <button id="logoutBtn" class="btn-secondary"><i class="fas fa-sign-out-alt ml-2"></i>تسجيل الخروج</button>
            </nav>
        </div>

        <!-- Add/Edit Person Form -->
        <div class="card">
            <form id="personForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Personal Information -->
                    <div class="md:col-span-1">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">معلومات شخصية</h3>
                        <div class="mb-4">
                            <label for="firstNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-user-tag text-gray-500 ml-1"></i> الاسم الأول:
                            </label>
                            <input type="text" id="firstNameInput" class="input-field" required>
                            <p id="firstNameError" class="error-message hidden">الاسم الأول مطلوب.</p>
                        </div>
                        <div class="mb-4 input-group">
                            <label for="fatherNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-male text-gray-500 ml-1"></i> اسم الأب:
                            </label>
                            <input type="text" id="fatherNameInput" class="input-field" placeholder="ابحث أو أدخل اسم الأب">
                            <div id="fatherSuggestions" class="suggestions-list hidden"></div>
                            <input type="hidden" id="fatherIdInput">
                        </div>
                        <div class="mb-4 input-group">
                            <label for="grandFatherNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-user-tie text-gray-500 ml-1"></i> اسم الجد:
                            </label>
                            <input type="text" id="grandFatherNameInput" class="input-field" placeholder="ابحث أو أدخل اسم الجد">
                            <div id="grandFatherSuggestions" class="suggestions-list hidden"></div>
                            <input type="hidden" id="grandFatherIdInput">
                        </div>
                        <div class="mb-4">
                            <label for="familyNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-users text-gray-500 ml-1"></i> اسم العائلة:
                            </label>
                            <input type="text" id="familyNameInput" class="input-field" required>
                            <p id="familyNameError" class="error-message hidden">اسم العائلة مطلوب.</p>
                        </div>
                        <div class="mb-4 input-group">
                            <label for="motherNameInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-female text-gray-500 ml-1"></i> اسم الأم:
                            </label>
                            <input type="text" id="motherNameInput" class="input-field" placeholder="ابحث أو أدخل اسم الأم">
                            <div id="motherSuggestions" class="suggestions-list hidden"></div>
                            <input type="hidden" id="motherIdInput">
                        </div>
                        <div class="mb-4">
                            <label for="idNumberInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-id-card text-gray-500 ml-1"></i> رقم الهوية:
                            </label>
                            <input type="text" id="idNumberInput" class="input-field">
                            <p id="idNumberError" class="error-message hidden">رقم الهوية موجود بالفعل.</p>
                        </div>
                        <div class="mb-4">
                            <label for="phoneNumberInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-phone text-gray-500 ml-1"></i> رقم الجوال:
                            </label>
                            <input type="text" id="phoneNumberInput" class="input-field">
                        </div>
                        <div class="mb-4">
                            <label for="birthDateInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calendar-alt text-gray-500 ml-1"></i> تاريخ الميلاد:
                            </label>
                            <input type="date" id="birthDateInput" class="input-field" required>
                            <p id="birthDateError" class="error-message hidden">تاريخ الميلاد مطلوب.</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-venus-mars text-gray-500 ml-1"></i> الجنس:
                            </label>
                            <div class="flex gap-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" value="Male" id="genderMale" class="form-radio text-indigo-600" required>
                                    <span class="mr-2 text-gray-700">ذكر</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" value="Female" id="genderFemale" class="form-radio text-indigo-600" required>
                                    <span class="mr-2 text-gray-700">أنثى</span>
                                </label>
                            </div>
                            <p id="genderError" class="error-message hidden">الجنس مطلوب.</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-heartbeat text-gray-500 ml-1"></i> الحالة:
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="isAliveInput" class="form-checkbox text-indigo-600 rounded-md">
                                <span class="mr-2 text-gray-700">على قيد الحياة</span>
                            </label>
                        </div>
                        <div class="mb-4 hidden" id="deathDateContainer">
                            <label for="deathDateInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-skull-crossbones text-gray-500 ml-1"></i> تاريخ الوفاة:
                            </label>
                            <input type="date" id="deathDateInput" class="input-field">
                            <p id="deathDateError" class="error-message hidden">تاريخ الوفاة مطلوب إذا كان الشخص متوفى.</p>
                        </div>
                        <div class="mb-4">
                            <label for="notesInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-sticky-note text-gray-500 ml-1"></i> ملاحظات:
                            </label>
                            <textarea id="notesInput" class="input-field" rows="4" placeholder="أضف أي ملاحظات إضافية عن الشخص..."></textarea>
                        </div>
                    </div>

                    <!-- Marital Status and Relationships -->
                    <div class="md:col-span-1">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">الحالة الاجتماعية والعلاقات</h3>
                        <div class="mb-4">
                            <label for="maritalStatusInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-ring text-gray-500 ml-1"></i> الحالة الاجتماعية:
                            </label>
                            <select id="maritalStatusInput" class="input-field" required>
                                <option value="">اختر الحالة</option>
                                <option value="Single">أعزب</option>
                                <option value="Engaged">مخطوب</option> <!-- Added Engaged status -->
                                <option value="Married">متزوج</option>
                                <option value="Divorced">مطلق</option>
                                <option value="Widowed">أرمل</option>
                            </select>
                            <p id="maritalStatusError" class="error-message hidden">الحالة الاجتماعية مطلوبة.</p>
                        </div>

                        <!-- Marriage Date Input -->
                        <div class="mb-4 hidden" id="marriageDateContainer">
                            <label for="marriageDateInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calendar-check text-gray-500 ml-1"></i> تاريخ الزواج:
                            </label>
                            <input type="date" id="marriageDateInput" class="input-field">
                            <p id="marriageDateError" class="error-message hidden">تاريخ الزواج مطلوب إذا كان متزوجاً.</p>
                        </div>

                        <!-- Engagement Date Input -->
                        <div class="mb-4 hidden" id="engagementDateContainer">
                            <label for="engagementDateInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calendar-plus text-gray-500 ml-1"></i> تاريخ الخطوبة:
                            </label>
                            <input type="date" id="engagementDateInput" class="input-field">
                            <p id="engagementDateError" class="error-message hidden">تاريخ الخطوبة مطلوب إذا كان مخطوباً.</p>
                        </div>

                        <div id="spousesSection" class="mb-4">
                            <h4 class="text-lg font-medium text-gray-700 mb-2">الأزواج/الزوجات:</h4>
                            <div id="spousesList" class="bg-gray-50 p-4 rounded-lg mb-4">
                                <p class="text-gray-600" id="noSpousesMessage">لا يوجد أزواج/زوجات مضافون بعد.</p>
                                <!-- Spouses will be added here dynamically -->
                            </div>
                            <div class="mb-4 input-group">
                                <label for="addSpouseInput" class="block text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-plus-circle text-gray-500 ml-1"></i> إضافة زوج/زوجة:
                                </label>
                                <input type="text" id="addSpouseInput" class="input-field" placeholder="ابحث أو أدخل اسم الزوج/الزوجة">
                                <div id="addSpouseSuggestions" class="suggestions-list hidden"></div>
                                <input type="hidden" id="addSpouseIdInput">
                                <button type="button" id="addSpouseBtn" class="btn-secondary mt-2 w-full">أضف</button>
                            </div>
                            <p id="spouseError" class="error-message hidden">الرجاء إضافة زوج/زوجة واحد على الأقل إذا كان متزوجاً/مخطوباً.</p>
                            <p id="spouseGenderError" class="error-message hidden">جنس الزوج/الزوجة غير متوافق مع جنس الشخص الحالي.</p>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">الأبناء</h3>
                        <div id="childrenList" class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-gray-600" id="noChildrenMessage">لا يوجد أبناء مضافون بعد.</p>
                            <!-- Children will be added here dynamically -->
                        </div>
                        <div class="mb-4 input-group">
                            <label for="addChildInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-child text-gray-500 ml-1"></i> إضافة ابن/ابنة:
                            </label>
                            <input type="text" id="addChildInput" class="input-field" placeholder="ابحث أو أدخل اسم الابن/الابنة">
                            <div id="childrenSuggestions" class="suggestions-list hidden"></div>
                            <input type="hidden" id="addChildIdInput">
                            <button type="button" id="addChildBtn" class="btn-secondary mt-2 w-full">أضف</button>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">روابط إضافية</h3>
                        <div class="mb-4">
                            <label for="facebookLinkInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fab fa-facebook text-gray-500 ml-1"></i> رابط فيسبوك:
                            </label>
                            <input type="url" id="facebookLinkInput" class="input-field" placeholder="https://facebook.com/username">
                        </div>
                        <div class="mb-4">
                            <label for="linkedinLinkInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fab fa-linkedin text-gray-500 ml-1"></i> رابط لينكدإن:
                            </label>
                            <input type="url" id="linkedinLinkInput" class="input-field" placeholder="https://linkedin.com/in/username">
                        </div>
                        <div class="mb-4">
                            <label for="websiteLinkInput" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-globe text-gray-500 ml-1"></i> رابط موقع شخصي:
                            </label>
                            <input type="url" id="websiteLinkInput" class="input-field" placeholder="https://www.example.com">
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-4 mt-8 pt-4 border-t">
                    <button type="submit" class="btn-primary" id="savePersonBtn">حفظ البيانات</button>
                    <button type="button" class="btn-primary" id="saveAndAddAnotherBtn">حفظ وإضافة آخر</button>
                    <button type="button" class="btn-secondary" id="cancelBtn">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import auth, db, appId, and redirectTo from auth_guard.js
        import { auth, db, appId, redirectTo } from './auth_guard.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let userId = null;
        let editingPersonId = null; // Stores ID if in edit mode
        let allFamilyMembers = []; // Cache all family members for suggestions
        let originalPersonData = null; // Store original data for comparison during updates
        let hasUnsavedChanges = false; // Track if there are unsaved changes
        let userRole = null; // Store user's role
        let allowedPages = []; // Store pages allowed for the user

        // DOM Elements
        const pageTitle = document.getElementById('pageTitle');
        const personForm = document.getElementById('personForm');
        const firstNameInput = document.getElementById('firstNameInput');
        const firstNameError = document.getElementById('firstNameError');
        const fatherNameInput = document.getElementById('fatherNameInput');
        const fatherSuggestions = document.getElementById('fatherSuggestions');
        const fatherIdInput = document.getElementById('fatherIdInput');
        const grandFatherNameInput = document.getElementById('grandFatherNameInput');
        const grandFatherSuggestions = document.getElementById('grandFatherSuggestions'); // NEW
        const grandFatherIdInput = document.getElementById('grandFatherIdInput'); // NEW
        const familyNameInput = document.getElementById('familyNameInput');
        const familyNameError = document.getElementById('familyNameError');
        const motherNameInput = document.getElementById('motherNameInput');
        const motherSuggestions = document.getElementById('motherSuggestions');
        const motherIdInput = document.getElementById('motherIdInput');
        const idNumberInput = document.getElementById('idNumberInput');
        const idNumberError = document.getElementById('idNumberError');
        const phoneNumberInput = document.getElementById('phoneNumberInput');
        const birthDateInput = document.getElementById('birthDateInput');
        const birthDateError = document.getElementById('birthDateError');
        const genderMale = document.getElementById('genderMale');
        const genderFemale = document.getElementById('genderFemale');
        const genderError = document.getElementById('genderError');
        const isAliveInput = document.getElementById('isAliveInput');
        const deathDateContainer = document.getElementById('deathDateContainer');
        const deathDateInput = document.getElementById('deathDateInput');
        const deathDateError = document.getElementById('deathDateError');
        const maritalStatusInput = document.getElementById('maritalStatusInput');
        const maritalStatusError = document.getElementById('maritalStatusError');

        const marriageDateContainer = document.getElementById('marriageDateContainer');
        const marriageDateInput = document.getElementById('marriageDateInput');
        const marriageDateError = document.getElementById('marriageDateError'); // NEW

        const engagementDateContainer = document.getElementById('engagementDateContainer');
        const engagementDateInput = document.getElementById('engagementDateInput');
        const engagementDateError = document.getElementById('engagementDateError'); // NEW


        const spousesSection = document.getElementById('spousesSection');
        const spousesListDiv = document.getElementById('spousesList');
        const noSpousesMessage = document.getElementById('noSpousesMessage');
        const addSpouseInput = document.getElementById('addSpouseInput');
        const addSpouseSuggestions = document.getElementById('addSpouseSuggestions');
        const addSpouseIdInput = document.getElementById('addSpouseIdInput');
        const addSpouseBtn = document.getElementById('addSpouseBtn');
        const spouseError = document.getElementById('spouseError');
        const spouseGenderError = document.getElementById('spouseGenderError');

        const childrenListDiv = document.getElementById('childrenList');
        const noChildrenMessage = document.getElementById('noChildrenMessage');
        const addChildInput = document.getElementById('addChildInput');
        const childrenSuggestions = document.getElementById('childrenSuggestions');
        const addChildIdInput = document.getElementById('addChildIdInput');
        const addChildBtn = document.getElementById('addChildBtn');
        const savePersonBtn = document.getElementById('savePersonBtn');
        const saveAndAddAnotherBtn = document.getElementById('saveAndAddAnotherBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const facebookLinkInput = document.getElementById('facebookLinkInput');
        const linkedinLinkInput = document.getElementById('linkedinLinkInput');
        const websiteLinkInput = document.getElementById('websiteLinkInput');
        const notesInput = document.getElementById('notesInput');
        const mainNav = document.getElementById('mainNav'); // Get main navigation element
        const logoutBtn = document.getElementById('logoutBtn'); // Get logout button


        // Use Maps to manage children/spouses IDs and their names for uniqueness and easy lookup
        let currentChildren = new Map();
        let currentSpouses = new Map(); // Map for current spouses

        // Function to show custom modal messages
        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').style.display = 'flex';
        }

        // Function to close custom modal messages
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Function to show loading modal
        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = 'flex';
        }

        // Function to hide loading modal
        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        // Function to fetch all family members for suggestions
        async function fetchAllFamilyMembers() {
            if (!userId) {
                console.log("User ID not available, cannot fetch all family members for suggestions.");
                return;
            }
            try {
                const q = collection(db, `artifacts/${appId}/users/${userId}/familyMembers`);
                const querySnapshot = await getDocs(q);
                allFamilyMembers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("All family members cached for suggestions:", allFamilyMembers);
            } catch (error) {
                console.error("Error caching all family members:", error);
                showModal("حدث خطأ أثناء جلب قائمة العائلة للاقتراحات: " + error.message);
            }
        }

        // Helper function for name suggestions
        function setupNameSuggestions(inputElement, suggestionsElement, hiddenIdElement, filterGender = null) {
            if (!inputElement || !suggestionsElement || !hiddenIdElement) {
                console.error("Missing elements for setupNameSuggestions. Input:", inputElement, "Suggestions:", suggestionsElement, "Hidden ID:", hiddenIdElement);
                return;
            }

            inputElement.addEventListener('input', () => {
                hasUnsavedChanges = true; // Mark form as changed
                suggestionsElement.innerHTML = '';
                suggestionsElement.classList.add('hidden');
                hiddenIdElement.value = ''; // Clear hidden ID on input change

                const searchText = inputElement.value.toLowerCase();
                if (searchText.length < 2) return;

                let filteredSuggestions = allFamilyMembers.filter(person =>
                    person.fullName && person.fullName.toLowerCase().includes(searchText) &&
                    person.id !== editingPersonId // Exclude current person from suggestions
                );

                // Filter by gender if applicable
                if (filterGender) {
                    filteredSuggestions = filteredSuggestions.filter(person => person.gender === filterGender);
                }

                if (filteredSuggestions.length > 0) {
                    suggestionsElement.classList.remove('hidden');
                    filteredSuggestions.forEach(person => {
                        const div = document.createElement('div');
                        div.classList.add('suggestions-list-item');
                        div.textContent = person.fullName; // Display full name in suggestion list

                        div.addEventListener('click', async () => {
                            console.log(`Selected person for suggestion:`, person);

                            // Set the input field value
                            inputElement.value = person.fullName;
                            hiddenIdElement.value = person.id;
                            suggestionsElement.classList.add('hidden');

                            // Specific logic for father selection to auto-fill grandfather and mother
                            if (inputElement === fatherNameInput) {
                                // Auto-fill grandFatherNameInput
                                const paternalGrandfatherId = person.fatherId;
                                if (paternalGrandfatherId) {
                                    const paternalGrandfather = allFamilyMembers.find(member => member.id === paternalGrandfatherId);
                                    if (paternalGrandfather) {
                                        grandFatherNameInput.value = paternalGrandfather.fullName || '';
                                        grandFatherIdInput.value = paternalGrandfather.id;
                                        console.log("Father selected. Auto-filling grandFatherName with father's father's full name:", grandFatherNameInput.value);
                                    } else {
                                        grandFatherNameInput.value = '';
                                        grandFatherIdInput.value = '';
                                        console.log("Father selected, but paternal grandfather not found in cache. grandFatherName cleared.");
                                    }
                                } else {
                                    grandFatherNameInput.value = '';
                                    grandFatherIdInput.value = '';
                                    console.log("Father selected, but selected father has no fatherId. grandFatherName cleared.");
                                }

                                // Auto-fill motherNameInput (father's spouse)
                                if (person.spouseIds && person.spouseIds.length > 0) {
                                    const potentialMotherId = person.spouseIds.find(sId => {
                                        const sPerson = allFamilyMembers.find(member => member.id === sId);
                                        return sPerson && sPerson.gender === 'Female';
                                    });

                                    if (potentialMotherId) {
                                        const motherPerson = allFamilyMembers.find(member => member.id === potentialMotherId);
                                        if (motherPerson) {
                                            motherNameInput.value = motherPerson.fullName;
                                            motherIdInput.value = motherPerson.id;
                                            console.log("Father's spouse found. Auto-filling motherName:", motherNameInput.value);
                                        } else {
                                            motherNameInput.value = '';
                                            motherIdInput.value = '';
                                            console.log("Mother person data not found in cache. Mother not auto-filled.");
                                        }
                                    } else {
                                        motherNameInput.value = '';
                                        motherIdInput.value = '';
                                        console.log("Father has no female spouse. Mother not auto-filled.");
                                    }
                                } else {
                                    motherNameInput.value = '';
                                    motherIdInput.value = '';
                                    console.log("Father has no spouseIds. Mother not auto-filled.");
                                }
                            }
                        });
                        suggestionsElement.appendChild(div);
                    });
                }
            });

            document.addEventListener('click', (event) => {
                if (suggestionsElement && !inputElement.parentNode.contains(event.target)) {
                    suggestionsElement.classList.add('hidden');
                }
            });
        }


        // Function to render children list
        async function renderChildrenList() {
            childrenListDiv.innerHTML = '';
            if (currentChildren.size === 0) {
                noChildrenMessage.classList.remove('hidden');
                return;
            } else {
                noChildrenMessage.classList.add('hidden');
            }

            const childrenArray = Array.from(currentChildren.values());
            childrenArray.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            for (const child of childrenArray) {
                const childDiv = document.createElement('div');
                childDiv.classList.add('relation-item');

                const childName = document.createElement('span');
                childName.textContent = child.name;
                childDiv.appendChild(childName);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('btn-secondary', 'px-3', 'py-1', 'text-sm');
                removeBtn.textContent = 'إزالة';
                removeBtn.addEventListener('click', () => {
                    currentChildren.delete(child.id);
                    console.log("Child removed:", child.id, currentChildren);
                    renderChildrenList();
                    hasUnsavedChanges = true;
                });
                childDiv.appendChild(removeBtn);
                childrenListDiv.appendChild(childDiv);
            }
        }

        // Function to render spouses list
        async function renderSpousesList() {
            spousesListDiv.innerHTML = '';
            if (currentSpouses.size === 0) {
                noSpousesMessage.classList.remove('hidden');
                return;
            } else {
                noSpousesMessage.classList.add('hidden');
            }

            const spousesArray = Array.from(currentSpouses.values());
            spousesArray.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            for (const spouse of spousesArray) {
                const spouseDiv = document.createElement('div');
                spouseDiv.classList.add('relation-item');

                const spouseName = document.createElement('span');
                spouseName.textContent = spouse.name + (spouse.isManual ? ' (يدوي)' : '');
                spouseDiv.appendChild(spouseName);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('btn-secondary', 'px-3', 'py-1', 'text-sm');
                removeBtn.textContent = 'إزالة';
                removeBtn.addEventListener('click', () => {
                    currentSpouses.delete(spouse.id);
                    console.log("Spouse removed:", spouse.id, currentSpouses);
                    renderSpousesList();
                    hasUnsavedChanges = true;
                });
                spouseDiv.appendChild(removeBtn);
                spousesListDiv.appendChild(spouseDiv);
            }
        }


        // Function to load person data for editing
        async function loadPersonData(personId) {
            if (!userId) {
                console.log("User ID not available, cannot load person data for edit.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/familyMembers`, personId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    originalPersonData = { ...data, id: docSnap.id };
                    console.log("Loading person data for edit:", data);
                    firstNameInput.value = data.firstName || '';
                    fatherNameInput.value = data.fatherName || '';
                    fatherIdInput.value = data.fatherId || '';
                    grandFatherNameInput.value = data.grandFatherName || '';
                    grandFatherIdInput.value = data.grandFatherId || '';
                    familyNameInput.value = data.familyName || '';
                    motherNameInput.value = data.motherName || '';
                    motherIdInput.value = data.motherId || '';
                    idNumberInput.value = data.idNumber || '';
                    phoneNumberInput.value = data.phoneNumber || '';
                    birthDateInput.value = data.birthDate ? data.birthDate.toDate().toISOString().split('T')[0] : '';

                    if (data.gender === 'Male') {
                        genderMale.checked = true;
                    } else if (data.gender === 'Female') {
                        genderFemale.checked = true;
                    }

                    isAliveInput.checked = data.isAlive !== false;
                    deathDateInput.value = data.deathDate ? data.deathDate.toDate().toISOString().split('T')[0] : '';
                    deathDateContainer.classList.toggle('hidden', isAliveInput.checked);

                    maritalStatusInput.value = data.maritalStatus || '';

                    marriageDateInput.value = data.marriageDate ? data.marriageDate.toDate().toISOString().split('T')[0] : '';
                    engagementDateInput.value = data.engagementDate ? data.engagementDate.toDate().toISOString().split('T')[0] : '';

                    toggleMaritalStatusFields(); // Show/hide spouse/date fields based on status

                    currentSpouses.clear();
                    if (data.spouseIds && data.spouseIds.length > 0) {
                        for (const spouseId of data.spouseIds) {
                            const spouseDoc = allFamilyMembers.find(member => member.id === spouseId);
                            if (spouseDoc) {
                                currentSpouses.set(spouseId, { id: spouseId, name: spouseDoc.fullName, isManual: false });
                            } else {
                                console.warn(`Spouse with ID ${spouseId} not found in cache during load, skipping.`);
                            }
                        }
                    }
                    if (data.manualSpouseNames && data.manualSpouseNames.length > 0) {
                        data.manualSpouseNames.forEach(manualName => {
                            const tempId = `manual-${crypto.randomUUID()}`;
                            currentSpouses.set(tempId, { id: tempId, name: manualName, isManual: true });
                        });
                    }
                    renderSpousesList();

                    currentChildren.clear();
                    if (data.childrenIds && data.childrenIds.length > 0) {
                        for (const childId of data.childrenIds) {
                            const childDoc = allFamilyMembers.find(member => member.id === childId);
                            if (childDoc) {
                                currentChildren.set(childId, { id: childId, name: childDoc.fullName });
                            } else {
                                console.warn(`Child with ID ${childId} not found in cache during load, skipping.`);
                            }
                        }
                    }
                    renderChildrenList();

                    facebookLinkInput.value = data.facebookLink || '';
                    linkedinLinkInput.value = data.linkedinLink || '';
                    websiteLinkInput.value = data.websiteLink || '';
                    notesInput.value = data.notes || '';

                    hasUnsavedChanges = false;
                } else {
                    showModal("لم يتم العثور على بيانات لهذا الشخص.");
                    editingPersonId = null;
                    pageTitle.textContent = 'إضافة شخص جديد';
                    console.log("No person data found for ID:", personId);
                }
            } catch (error) {
                console.error("Error loading person data:", error);
                showModal("حدث خطأ أثناء تحميل بيانات الشخص: " + error.message);
            }
        }

        // Function to toggle death date input visibility
        function toggleDeathDateInput() {
            deathDateContainer.classList.toggle('hidden', isAliveInput.checked);
            if (isAliveInput.checked) {
                deathDateInput.value = '';
            }
        }

        // Function to toggle marital status related fields
        function toggleMaritalStatusFields() {
            const status = maritalStatusInput.value;
            spousesSection.classList.toggle('hidden', status !== 'Married' && status !== 'Engaged');
            marriageDateContainer.classList.toggle('hidden', status !== 'Married');
            engagementDateContainer.classList.toggle('hidden', status !== 'Engaged');

            if (status !== 'Married') {
                marriageDateInput.value = ''; // Clear marriage date if not married
            }
            if (status !== 'Engaged') {
                engagementDateInput.value = ''; // Clear engagement date if not engaged
            }
            if (status !== 'Married' && status !== 'Engaged') {
                currentSpouses.clear(); // Clear spouses if not married or engaged
                renderSpousesList();
                addSpouseInput.value = '';
                addSpouseIdInput.value = '';
            }
        }

        // Function to update related family members' documents (e.g., add child to parent, spouse to spouse)
        async function updateRelatedPersonDocuments(personId, newData, oldData = {}) {
            // Helper to update a person's relationship array
            const updateRelationshipArray = async (targetPersonId, fieldName, valueToAdd, valueToRemove = null) => {
                if (!targetPersonId) return;
                const targetRef = doc(db, `artifacts/${appId}/users/${userId}/familyMembers`, targetPersonId);
                const targetSnap = await getDoc(targetRef);
                if (targetSnap.exists()) {
                    const targetData = targetSnap.data();
                    let currentArray = new Set(targetData[fieldName] || []);
                    if (valueToAdd) {
                        currentArray.add(valueToAdd);
                    }
                    if (valueToRemove) {
                        currentArray.delete(valueToRemove);
                    }
                    await updateDoc(targetRef, { [fieldName]: Array.from(currentArray) });
                }
            };

            // Update Father's childrenIds
            if (newData.fatherId && newData.fatherId !== oldData.fatherId) {
                await updateRelationshipArray(newData.fatherId, 'childrenIds', personId);
            }
            if (oldData.fatherId && oldData.fatherId !== newData.fatherId) {
                await updateRelationshipArray(oldData.fatherId, 'childrenIds', null, personId);
            }

            // Update Mother's childrenIds
            if (newData.motherId && newData.motherId !== oldData.motherId) {
                await updateRelationshipArray(newData.motherId, 'childrenIds', personId);
            }
            if (oldData.motherId && oldData.motherId !== newData.motherId) {
                await updateRelationshipArray(oldData.motherId, 'childrenIds', null, personId);
            }

            // Update Spouse's spouseIds (bidirectional relationship)
            const oldLinkedSpouseIds = new Set(oldData.spouseIds || []);
            const newLinkedSpouseIds = new Set(newData.spouseIds || []);

            // Add current person's ID to new linked spouses' spouseIds
            for (const spouseId of newLinkedSpouseIds) {
                if (!oldLinkedSpouseIds.has(spouseId)) {
                    await updateRelationshipArray(spouseId, 'spouseIds', personId);
                }
            }
            // Remove current person's ID from old linked spouses' spouseIds
            for (const spouseId of oldLinkedSpouseIds) {
                if (!newLinkedSpouseIds.has(spouseId)) {
                    await updateRelationshipArray(spouseId, 'spouseIds', null, personId);
                }
            }

            // Update Children's parentIds (if we decide to store parentIds on children)
            const oldChildrenIds = new Set(oldData.childrenIds || []);
            const newChildrenIds = new Set(newData.childrenIds || []);

            // Add current person's ID as parent to newly added children
            for (const childId of newChildrenIds) {
                if (!oldChildrenIds.has(childId)) {
                    // This is more complex as a child can have two parents.
                    // For now, we'll assume children only have one set of parents for simplicity in this update.
                    // A more robust solution would involve checking existing parent IDs.
                    // For this iteration, we'll just ensure the child's parent ID (if any) is updated.
                    // This part might need more sophisticated logic if a child can have multiple parents linked in the DB.
                }
            }
            // Remove current person's ID as parent from removed children
            for (const childId of oldChildrenIds) {
                if (!newChildrenIds.has(childId)) {
                    // Similar complexity as above.
                }
            }
        }


        // Function to validate the form
        async function validateForm(personData, isNewPerson) {
            let isValid = true;

            // Reset errors
            document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('input[name="gender"]').forEach(el => el.classList.remove('error'));

            // Validate First Name
            if (firstNameInput.value.trim() === '') {
                firstNameError.classList.remove('hidden');
                firstNameInput.classList.add('error');
                isValid = false;
            }

            // Validate Family Name
            if (familyNameInput.value.trim() === '') {
                familyNameError.classList.remove('hidden');
                familyNameInput.classList.add('error');
                isValid = false;
            }

            // Validate Birth Date
            if (birthDateInput.value === '') {
                birthDateError.classList.remove('hidden');
                birthDateInput.classList.add('error');
                isValid = false;
            }

            // Validate Gender
            const selectedGender = document.querySelector('input[name="gender"]:checked');
            if (!selectedGender) {
                genderError.classList.remove('hidden');
                genderMale.classList.add('error'); // Highlight one of the radios
                genderFemale.classList.add('error');
                isValid = false;
            }

            // Validate Death Date if not alive
            if (!isAliveInput.checked && deathDateInput.value.trim() === '') {
                deathDateError.classList.remove('hidden');
                deathDateInput.classList.add('error');
                isValid = false;
            }

            // Validate Marital Status
            if (maritalStatusInput.value === '') {
                maritalStatusError.classList.remove('hidden');
                maritalStatusInput.classList.add('error');
                isValid = false;
            }

            // Validate Spouse if Married or Engaged (now checks if at least one spouse is added)
            if (maritalStatusInput.value === 'Married' || maritalStatusInput.value === 'Engaged') {
                if (currentSpouses.size === 0) {
                    spouseError.classList.remove('hidden');
                    addSpouseInput.classList.add('error');
                    isValid = false;
                } else {
                    // Validate spouse gender consistency ONLY for linked spouses
                    const currentPersonGender = selectedGender?.value;
                    for (const [spouseId, spouseData] of currentSpouses) {
                        if (!spouseData.isManual) { // Only check gender for linked profiles
                            const spouseInAllFamily = allFamilyMembers.find(member => member.id === spouseId);
                            if (spouseInAllFamily && currentPersonGender && spouseInAllFamily.gender === currentPersonGender) {
                                spouseGenderError.classList.remove('hidden');
                                addSpouseInput.classList.add('error');
                                isValid = false;
                                break; // Stop checking after first mismatch
                            }
                        }
                    }
                }
                // Validate marriage date if married
                if (maritalStatusInput.value === 'Married' && marriageDateInput.value.trim() === '') {
                    marriageDateError.classList.remove('hidden');
                    marriageDateInput.classList.add('error');
                    isValid = false;
                }
                // Validate engagement date if engaged
                if (maritalStatusInput.value === 'Engaged' && engagementDateInput.value.trim() === '') {
                    engagementDateError.classList.remove('hidden');
                    engagementDateInput.classList.add('error');
                    isValid = false;
                }
            }


            // Validate for duplicate full name or ID number
            const qFullName = query(collection(db, `artifacts/${appId}/users/${userId}/familyMembers`), where("fullName", "==", personData.fullName));
            const qIdNumber = query(collection(db, `artifacts/${appId}/users/${userId}/familyMembers`), where("idNumber", "==", personData.idNumber));

            const [fullNameSnapshot, idNumberSnapshot] = await Promise.all([getDocs(qFullName), getDocs(qIdNumber)]);

            // Check full name duplicates
            const fullNameDuplicates = fullNameSnapshot.docs.filter(doc => doc.id !== editingPersonId);
            if (fullNameDuplicates.length > 0) {
                showModal("شخص بنفس الاسم الكامل موجود بالفعل.");
                firstNameInput.classList.add('error');
                familyNameInput.classList.add('error');
                isValid = false;
            }

            // Check ID number duplicates (only if ID is provided)
            if (personData.idNumber && personData.idNumber.trim() !== '') {
                const idNumberDuplicates = idNumberSnapshot.docs.filter(doc => doc.id !== editingPersonId);
                if (idNumberDuplicates.length > 0) {
                    showModal("شخص بنفس رقم الهوية موجود بالفعل.");
                    idNumberInput.classList.add('error');
                    idNumberError.classList.remove('hidden');
                    isValid = false;
                }
            }

            return isValid;
        }


        // Function to reset the form
        function resetForm() {
            personForm.reset();
            editingPersonId = null;
            pageTitle.textContent = 'إضافة شخص جديد';
            savePersonBtn.textContent = 'حفظ البيانات';
            isAliveInput.checked = true;
            deathDateContainer.classList.add('hidden');
            spousesSection.classList.add('hidden');
            marriageDateContainer.classList.add('hidden');
            engagementDateContainer.classList.add('hidden');
            currentChildren.clear();
            currentSpouses.clear();
            renderChildrenList();
            renderSpousesList();
            originalPersonData = null;
            hasUnsavedChanges = false;
            document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('input[name="gender"]').forEach(el => el.classList.remove('error'));
        }

        // Function to save/update person data
        async function savePerson(redirectToProfile = true) {
            showLoadingModal();
            try {
                if (!userId) {
                    showModal("يرجى تسجيل الدخول لحفظ البيانات.");
                    console.error("User ID is null, cannot save data.");
                    return;
                }

                // Gather data from form
                const personData = {
                    firstName: firstNameInput.value.trim(),
                    fatherName: fatherNameInput.value.trim(),
                    fatherId: fatherIdInput.value.trim() || null,
                    grandFatherName: grandFatherNameInput.value.trim(),
                    grandFatherId: grandFatherIdInput.value.trim() || null, // NEW
                    familyName: familyNameInput.value.trim(),
                    motherName: motherNameInput.value.trim(),
                    motherId: motherIdInput.value.trim() || null,
                    idNumber: idNumberInput.value.trim(),
                    phoneNumber: phoneNumberInput.value.trim(),
                    birthDate: birthDateInput.value ? Timestamp.fromDate(new Date(birthDateInput.value)) : null,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || null,
                    isAlive: isAliveInput.checked,
                    deathDate: (isAliveInput.checked || !deathDateInput.value) ? null : Timestamp.fromDate(new Date(deathDateInput.value)),
                    maritalStatus: maritalStatusInput.value,
                    marriageDate: maritalStatusInput.value === 'Married' && marriageDateInput.value ? Timestamp.fromDate(new Date(marriageDateInput.value)) : null,
                    engagementDate: maritalStatusInput.value === 'Engaged' && engagementDateInput.value ? Timestamp.fromDate(new Date(engagementDateInput.value)) : null,
                    spouseIds: [],
                    manualSpouseNames: [],
                    childrenIds: Array.from(currentChildren.keys()),
                    facebookLink: facebookLinkInput.value.trim() || null,
                    linkedinLink: linkedinLinkInput.value.trim() || null,
                    websiteLink: websiteLinkInput.value.trim() || null,
                    notes: notesInput.value.trim() || null
                };

                currentSpouses.forEach(spouse => {
                    if (spouse.isManual) {
                        personData.manualSpouseNames.push(spouse.name);
                    } else {
                        personData.spouseIds.push(spouse.id);
                    }
                });


                // Generate full name
                personData.fullName = `${personData.firstName} ${personData.fatherName ? personData.fatherName + ' ' : ''}${personData.grandFatherName ? personData.grandFatherName + ' ' : ''}${personData.familyName}`.trim().replace(/\s+/g, ' ');

                // Validate form including duplicates and gender consistency
                const isNewPerson = !editingPersonId;
                if (!(await validateForm(personData, isNewPerson))) {
                    hideLoadingModal();
                    showModal("الرجاء تصحيح الأخطاء في النموذج قبل الحفظ.");
                    console.log("Form validation failed.");
                    return;
                }

                let savedPersonId = editingPersonId;
                let oldPersonDataForUpdate = originalPersonData || {}; // Use original data if exists, else empty object


                if (editingPersonId) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/familyMembers`, editingPersonId);
                    await setDoc(docRef, personData, { merge: true });
                    showModal("تم تحديث بيانات الشخص بنجاح!");
                    console.log("Person updated successfully with ID:", editingPersonId);
                } else {
                    personData.creationDate = Timestamp.now();
                    const docRef = collection(db, `artifacts/${appId}/users/${userId}/familyMembers`);
                    const newDoc = await addDoc(docRef, personData);
                    savedPersonId = newDoc.id;
                    pageTitle.textContent = 'تعديل شخص';
                    editingPersonId = savedPersonId; // Set editingPersonId for newly added person
                    showModal("تم إضافة شخص جديد بنجاح!");
                    console.log("New person added with ID:", savedPersonId);
                }

                // Update related person documents (parents, spouses, children)
                await updateRelatedPersonDocuments(savedPersonId, personData, oldPersonDataForUpdate);

                hasUnsavedChanges = false;

                if (redirectToProfile) {
                    setTimeout(() => {
                        window.location.href = `profile.html?id=${savedPersonId}`;
                    }, 1500);
                } else {
                    resetForm();
                    await fetchAllFamilyMembers(); // Re-fetch all family members to update suggestions cache
                }

            } catch (error) {
                console.error("Error saving person data:", error);
                showModal("حدث خطأ أثناء حفظ البيانات: " + error.message);
            } finally {
                hideLoadingModal();
            }
        }

        // Function to update navigation button visibility based on user's allowed pages and role
        function updateNavigationLinks() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                const pageName = link.dataset.page;
                if (allowedPages.includes(pageName)) {
                    link.style.display = ''; // Show the link
                } else {
                    link.style.display = 'none'; // Hide the link
                }
            });
        }


        // Confirmation before leaving page
        window.onbeforeunload = (event) => {
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = ''; // Required for some browsers
                return 'لديك تغييرات غير محفوظة. هل أنت متأكد أنك تريد المغادرة؟';
            }
        };

        // Main DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements
            // (All assignments moved here to ensure they exist when accessed)
            // ... (All const assignments from above should be here) ...
            // Example:
            // pageTitle = document.getElementById('pageTitle');
            // personForm = document.getElementById('personForm');
            // ... and so on for all DOM elements

            // Re-assign all DOM elements here as they are used in the IIFE setup
            pageTitle = document.getElementById('pageTitle');
            personForm = document.getElementById('personForm');
            firstNameInput = document.getElementById('firstNameInput');
            firstNameError = document.getElementById('firstNameError');
            fatherNameInput = document.getElementById('fatherNameInput');
            fatherSuggestions = document.getElementById('fatherSuggestions');
            fatherIdInput = document.getElementById('fatherIdInput');
            grandFatherNameInput = document.getElementById('grandFatherNameInput');
            grandFatherSuggestions = document.getElementById('grandFatherSuggestions');
            grandFatherIdInput = document.getElementById('grandFatherIdInput');
            familyNameInput = document.getElementById('familyNameInput');
            familyNameError = document.getElementById('familyNameError');
            motherNameInput = document.getElementById('motherNameInput');
            motherSuggestions = document.getElementById('motherSuggestions');
            motherIdInput = document.getElementById('motherIdInput');
            idNumberInput = document.getElementById('idNumberInput');
            idNumberError = document.getElementById('idNumberError');
            phoneNumberInput = document.getElementById('phoneNumberInput');
            birthDateInput = document.getElementById('birthDateInput');
            birthDateError = document.getElementById('birthDateError');
            genderMale = document.getElementById('genderMale');
            genderFemale = document.getElementById('genderFemale');
            genderError = document.getElementById('genderError');
            isAliveInput = document.getElementById('isAliveInput');
            deathDateContainer = document.getElementById('deathDateContainer');
            deathDateInput = document.getElementById('deathDateInput');
            deathDateError = document.getElementById('deathDateError');
            maritalStatusInput = document.getElementById('maritalStatusInput');
            maritalStatusError = document.getElementById('maritalStatusError');
            marriageDateContainer = document.getElementById('marriageDateContainer');
            marriageDateInput = document.getElementById('marriageDateInput');
            marriageDateError = document.getElementById('marriageDateError');
            engagementDateContainer = document.getElementById('engagementDateContainer');
            engagementDateInput = document.getElementById('engagementDateInput');
            engagementDateError = document.getElementById('engagementDateError');
            spousesSection = document.getElementById('spousesSection');
            spousesListDiv = document.getElementById('spousesList');
            noSpousesMessage = document.getElementById('noSpousesMessage');
            addSpouseInput = document.getElementById('addSpouseInput');
            addSpouseSuggestions = document.getElementById('addSpouseSuggestions');
            addSpouseIdInput = document.getElementById('addSpouseIdInput');
            addSpouseBtn = document.getElementById('addSpouseBtn');
            spouseError = document.getElementById('spouseError');
            spouseGenderError = document.getElementById('spouseGenderError');
            childrenListDiv = document.getElementById('childrenList');
            noChildrenMessage = document.getElementById('noChildrenMessage');
            addChildInput = document.getElementById('addChildInput');
            childrenSuggestions = document.getElementById('childrenSuggestions');
            addChildIdInput = document.getElementById('addChildIdInput');
            addChildBtn = document.getElementById('addChildBtn');
            savePersonBtn = document.getElementById('savePersonBtn');
            saveAndAddAnotherBtn = document.getElementById('saveAndAddAnotherBtn');
            cancelBtn = document.getElementById('cancelBtn');
            facebookLinkInput = document.getElementById('facebookLinkInput');
            linkedinLinkInput = document.getElementById('linkedinLinkInput');
            websiteLinkInput = document.getElementById('websiteLinkInput');
            notesInput = document.getElementById('notesInput');
            // mainNav and logoutBtn are already global outside the IIFE, no need to re-assign here.

            // Modal close buttons
            document.getElementById('closeMessageModalBtn').addEventListener('click', () => closeModal('messageModal'));
            document.getElementById('confirmMessageModalBtn').addEventListener('click', () => closeModal('messageModal'));

            // Get person ID from URL (edit mode)
            const urlParams = new URLSearchParams(window.location.search);
            editingPersonId = urlParams.get('id');

            if (editingPersonId) {
                pageTitle.textContent = 'تعديل شخص';
                savePersonBtn.textContent = 'تحديث البيانات';
                console.log("Page in EDIT mode for ID:", editingPersonId);
            } else {
                pageTitle.textContent = 'إضافة شخص جديد';
                savePersonBtn.textContent = 'حفظ البيانات';
                console.log("Page in ADD NEW mode.");
                isAliveInput.checked = true; // Default for new person
                deathDateContainer.classList.add('hidden');
                spousesSection.classList.add('hidden'); // Hide spouses section by default for new person
                marriageDateContainer.classList.add('hidden'); // Hide by default
                engagementDateContainer.classList.add('hidden'); // Hide by default
            }

            // Listen for auth state changes to get userId and fetch data
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authentication state changed. User ID:", userId);

                    // Fetch user settings to get role and allowed pages
                    try {
                        const userSettingsRef = doc(db, `artifacts/${appId}/userSettings`, userId);
                        const userSettingsSnap = await getDoc(userSettingsRef);

                        if (userSettingsSnap.exists()) {
                            const settings = userSettingsSnap.data();
                            userRole = settings.role || 'viewer';
                            allowedPages = settings.allowedPages || [];
                            updateNavigationLinks(); // Update navigation based on fetched permissions
                        } else {
                            console.warn("User settings not found for current user. Defaulting to viewer role.");
                            userRole = 'viewer';
                            allowedPages = ['dashboard.html', 'index.html', 'family_tree.html', 'events.html', 'profile.html', 'statistics.html', 'add_edit_person.html']; // Default for add/edit page
                            updateNavigationLinks();
                        }
                    } catch (error) {
                        console.error("Error fetching user settings:", error);
                        showModal("حدث خطأ أثناء جلب إعدادات المستخدم: " + error.message);
                        userRole = 'viewer'; // Fallback
                        allowedPages = ['dashboard.html', 'index.html', 'family_tree.html', 'events.html', 'profile.html', 'statistics.html', 'add_edit_person.html']; // Fallback
                        updateNavigationLinks();
                    }

                    // Only proceed if user has permission
                    if (!(userRole === 'admin' || userRole === 'editor')) {
                        showModal("ليس لديك الصلاحية للوصول إلى هذه الصفحة.", 'messageModal');
                        setTimeout(() => redirectTo('dashboard.html'), 2000); // Redirect if no permission
                        return;
                    }

                    await fetchAllFamilyMembers(); // Fetch all members for suggestions once authenticated

                    // Setup name suggestions for relationships
                    setupNameSuggestions(fatherNameInput, fatherSuggestions, fatherIdInput, 'Male');
                    setupNameSuggestions(motherNameInput, motherSuggestions, motherIdInput, 'Female');
                    setupNameSuggestions(grandFatherNameInput, grandFatherSuggestions, grandFatherIdInput, 'Male'); // Now linked to suggestions
                    setupNameSuggestions(addSpouseInput, addSpouseSuggestions, addSpouseIdInput, null); // Spouse can be male or female
                    setupNameSuggestions(addChildInput, childrenSuggestions, addChildIdInput, null); // Children can be male or female

                    if (editingPersonId) {
                        await loadPersonData(editingPersonId); // Load data if in edit mode
                    }
                } else {
                    userId = null;
                    console.log("User signed out or no user.");
                    showModal("يرجى تسجيل الدخول لإضافة أو تعديل بيانات الأشخاص.", 'messageModal');
                    // Hide all navigation links
                    document.querySelectorAll('.nav-link').forEach(link => link.style.display = 'none');
                }
            });

            // Event Listeners for conditional display and form changes
            isAliveInput.addEventListener('change', () => {
                toggleDeathDateInput();
                hasUnsavedChanges = true;
            });

            maritalStatusInput.addEventListener('change', () => {
                toggleMaritalStatusFields();
                hasUnsavedChanges = true;
            });

            // Mark form as changed on any input
            personForm.addEventListener('input', () => {
                hasUnsavedChanges = true;
            });

            // Handle form submission for "Save" button
            savePersonBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await savePerson(true); // Redirect to profile after saving
            });

            // Handle form submission for "Save and Add Another" button
            saveAndAddAnotherBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await savePerson(false); // Reset form after saving
            });

            // Cancel button functionality with confirmation
            cancelBtn.addEventListener('click', () => {
                if (hasUnsavedChanges) {
                    showModal("لديك تغييرات غير محفوظة. هل أنت متأكد أنك تريد إلغاء التغييرات والمغادرة؟");
                    document.getElementById('confirmMessageModalBtn').onclick = () => {
                        closeModal('messageModal');
                        hasUnsavedChanges = false; // Allow navigation
                        if (editingPersonId) {
                            window.location.href = `profile.html?id=${editingPersonId}`;
                        } else {
                            window.location.href = `index.html`;
                        }
                    };
                } else {
                    if (editingPersonId) {
                        window.location.href = `profile.html?id=${editingPersonId}`;
                    } else {
                        window.location.href = `index.html`;
                    }
                }
            });

            // Function to add a child
            addChildBtn.addEventListener('click', () => {
                const childId = addChildIdInput.value;
                const childName = addChildInput.value.trim();

                if (childId && childName) {
                    if (!currentChildren.has(childId)) {
                        currentChildren.set(childId, { id: childId, name: childName });
                        console.log("Child added:", childId, childName, currentChildren);
                        addChildInput.value = '';
                        addChildIdInput.value = '';
                        childrenSuggestions.classList.add('hidden');
                        renderChildrenList();
                        hasUnsavedChanges = true;
                    } else {
                        showModal("هذا الابن/الابنة مضاف بالفعل.");
                    }
                } else {
                    showModal("يرجى اختيار ابن/ابنة من الاقتراحات أو التأكد من وجود الاسم والمعرف.");
                }
            });

            // Function to add a spouse
            addSpouseBtn.addEventListener('click', () => {
                const spouseId = addSpouseIdInput.value;
                const spouseName = addSpouseInput.value.trim();

                if (!spouseName) {
                    showModal("يرجى إدخال اسم الزوج/الزوجة.");
                    return;
                }

                const currentPersonGender = document.querySelector('input[name="gender"]:checked')?.value;
                if (!currentPersonGender) {
                    showModal("الرجاء تحديد جنس الشخص الحالي أولاً.");
                    return;
                }

                // Check gender consistency ONLY if a linked spouse is being added
                if (spouseId) {
                    const spousePerson = allFamilyMembers.find(member => member.id === spouseId);

                    if (spousePerson && currentPersonGender === spousePerson.gender) {
                        spouseGenderError.classList.remove('hidden');
                        showModal("لا يمكن إضافة زوج/زوجة من نفس الجنس.");
                        return;
                    } else {
                        spouseGenderError.classList.add('hidden'); // Hide if previous error was shown
                    }
                }

                const isManual = !spouseId;
                const entryId = isManual ? `manual-${crypto.randomUUID()}` : spouseId;

                if (!currentSpouses.has(entryId)) {
                    currentSpouses.set(entryId, { id: entryId, name: spouseName, isManual: isManual });
                    console.log("Spouse added:", entryId, spouseName, currentSpouses);
                    addSpouseInput.value = '';
                    addSpouseIdInput.value = '';
                    addSpouseSuggestions.classList.add('hidden');
                    renderSpousesList();
                    hasUnsavedChanges = true;
                } else {
                    showModal("هذا الزوج/الزوجة مضاف بالفعل.");
                }
            });

            // Logout button
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    redirectTo('login.html'); // Redirect to login page after logout
                } catch (error) {
                    console.error("Error logging out:", error);
                    showModal("حدث خطأ أثناء تسجيل الخروج: " + error.message);
                }
            });
        });
    </script>
</body>
</html>
