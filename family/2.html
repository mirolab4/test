<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>إضافة / تعديل شخص (بدون تسجيل دخول)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap">
    <style>
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #f8fafc; 
            direction: rtl; 
            text-align: right; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 1.5rem; 
        }
        .card { 
            background: #fff; 
            border-radius: 1.5rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            padding: 2rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid #e2e8f0;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: #fff; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.75rem; 
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary { 
            background: #f1f5f9; 
            color: #334155; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.75rem; 
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        .input-field { 
            border: 1px solid #cbd5e1; 
            padding: 0.85rem 1.25rem; 
            border-radius: 0.75rem; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        .input-field:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
            background: #fff;
        }
        .suggestions-list { 
            position: absolute; 
            background: #fff; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.75rem; 
            max-height: 200px; 
            overflow-y: auto; 
            width: 100%; 
            z-index: 10; 
            box-shadow: 0 10px 15px rgba(0,0,0,0.08);
            margin-top: 0.25rem;
        }
        .suggestions-list-item { 
            padding: 0.75rem 1.25rem; 
            cursor: pointer; 
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        .suggestions-list-item:hover {
            background: #f1f5f9;
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(2px);
        }
        .modal-content { 
            background: #fff; 
            padding: 2.5rem; 
            border-radius: 1.5rem; 
            width: 90%; 
            max-width: 500px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .close-button { 
            color: #94a3b8; 
            float: left; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .close-button:hover {
            color: #64748b;
        }
        .relation-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem 1rem; 
            border-bottom: 1px dashed #e2e8f0;
            background: #f8fafc;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .error-message { 
            color: #ef4444; 
            font-size: 0.875rem; 
            margin-top: 0.25rem; 
            text-align: right; 
            font-weight: 500;
        }
        .input-field.error { 
            border-color: #ef4444; 
            background: #fff5f5;
        }
        #loadingModal .modal-content { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 3rem; 
        }
        .spinner { 
            border: 4px solid rgba(0,0,0,0.1); 
            border-left-color: #4f46e5; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin-bottom: 1rem; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .section-title {
            color: #4f46e5;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e0e7ff;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 80px;
            height: 2px;
            background: #4f46e5;
            border-radius: 10px;
        }
        .form-label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .form-icon {
            color: #4f46e5;
            margin-left: 0.5rem;
            font-size: 1.1rem;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-alive {
            background: #dcfce7;
            color: #166534;
        }
        .status-deceased {
            background: #fee2e2;
            color: #b91c1c;
        }
        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #f1f5f9;
            border: 2px dashed #cbd5e1;
            cursor: pointer;
            margin: 0 auto 1.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .photo-upload:hover {
            border-color: #818cf8;
            background: #e0e7ff;
        }
        .photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .photo-upload i {
            font-size: 2.5rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        .photo-upload span {
            color: #64748b;
            font-weight: 500;
            text-align: center;
        }
        .flex-inputs {
            display: flex;
            gap: 1rem;
        }
        .flex-inputs > div {
            flex: 1;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.75rem;
        }
        .toggle-label {
            font-weight: 600;
            color: #334155;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .optional-badge {
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.15rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        .manual-add-btn {
            background: #e0f2fe;
            color: #0ea5e9;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .manual-add-btn:hover {
            background: #bae6fd;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 0.5rem;
            color: #94a3b8;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 0.75rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">

<!-- Message Modal -->
<div id="messageModal" class="modal">
  <div class="modal-content">
    <span id="closeMessageModalBtn" class="close-button">&times;</span>
    <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
    <button id="confirmMessageModalBtn" class="btn-primary">حسناً</button>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="modal">
  <div class="modal-content">
    <div class="spinner"></div>
    <p class="text-lg font-semibold text-gray-800">جارٍ معالجة البيانات...</p>
  </div>
</div>

<div class="container">
  <div class="flex flex-col md:flex-row justify-between items-center mb-8 p-5 bg-white rounded-2xl shadow-md">
    <div>
      <h1 id="pageTitle" class="text-3xl font-bold text-gray-800 mb-2">إضافة شخص جديد</h1>
      <p class="text-gray-600">املأ البيانات التالية لإضافة شخص جديد إلى شجرة العائلة</p>
    </div>
    <nav class="flex flex-wrap gap-3 mt-4 md:mt-0">
      <a href="index.html" class="btn-secondary"><i class="fas fa-list mr-2"></i>قائمة العائلة</a>
      <a href="family_tree.html" class="btn-secondary"><i class="fas fa-tree mr-2"></i>شجرة العائلة</a>
      <a href="add_edit_person.html" class="btn-primary"><i class="fas fa-user-plus mr-2"></i>إضافة شخص جديد</a>
    </nav>
  </div>

  <div class="card">
    <form id="personForm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
        <div>
          <!-- الصورة الشخصية -->
          <div class="mb-8 text-center">
            <div class="photo-upload" id="photoUpload">
              <i class="fas fa-camera"></i>
              <span>إضافة صورة شخصية</span>
              <img id="personPhoto" src="" alt="صورة الشخص">
              <input type="file" id="photoInput" accept="image/*" class="hidden">
            </div>
          </div>
          
          <h3 class="section-title">المعلومات الشخصية</h3>
          
          <div class="mb-5">
            <label for="firstNameInput" class="form-label">
              <i class="fas fa-user-tag form-icon"></i> الاسم الأول:
            </label>
            <input type="text" id="firstNameInput" class="input-field" placeholder="أدخل الاسم الأول" required>
            <p id="firstNameError" class="error-message hidden">الاسم الأول مطلوب.</p>
          </div>

          <div class="flex-inputs">
            <div class="mb-5">
              <label for="fatherNameInput" class="form-label">
                <i class="fas fa-male form-icon"></i> اسم الأب:
              </label>
              <input type="text" id="fatherNameInput" class="input-field" placeholder="ابحث أو أدخل اسم الأب">
              <div id="fatherSuggestions" class="suggestions-list hidden"></div>
              <input type="hidden" id="fatherIdInput">
            </div>

            <div class="mb-5">
              <label for="grandFatherNameInput" class="form-label">
                <i class="fas fa-user-tie form-icon"></i> اسم الجد:
                <span class="tooltip">
                  <i class="fas fa-info-circle"></i>
                  <span class="tooltiptext">سيتم حفظ الاسم الأول للجد فقط</span>
                </span>
              </label>
              <input type="text" id="grandFatherNameInput" class="input-field" placeholder="اسم الجد الأول">
            </div>
          </div>

          <div class="flex-inputs">
            <div class="mb-5">
              <label for="familyNameInput" class="form-label">
                <i class="fas fa-users form-icon"></i> اسم العائلة:
              </label>
              <input type="text" id="familyNameInput" class="input-field" placeholder="اسم العائلة" required>
              <p id="familyNameError" class="error-message hidden">اسم العائلة مطلوب.</p>
            </div>

            <div class="mb-5 input-group">
              <label for="motherNameInput" class="form-label">
                <i class="fas fa-female form-icon"></i> اسم الأم:
              </label>
              <input type="text" id="motherNameInput" class="input-field" placeholder="ابحث أو أدخل اسم الأم">
              <div id="motherSuggestions" class="suggestions-list hidden"></div>
              <input type="hidden" id="motherIdInput">
            </div>
          </div>

          <div class="flex-inputs">
            <div class="mb-5">
              <label for="idNumberInput" class="form-label">
                <i class="fas fa-id-card form-icon"></i> رقم الهوية:
              </label>
              <input type="text" id="idNumberInput" class="input-field" placeholder="رقم الهوية">
              <p id="idNumberError" class="error-message hidden">رقم الهوية موجود بالفعل.</p>
            </div>

            <div class="mb-5">
              <label for="phoneNumberInput" class="form-label">
                <i class="fas fa-phone form-icon"></i> رقم الجوال:
              </label>
              <input type="text" id="phoneNumberInput" class="input-field" placeholder="رقم الجوال">
            </div>
          </div>

          <div class="flex-inputs">
            <div class="mb-5">
              <label for="birthDateInput" class="form-label">
                <i class="fas fa-calendar-alt form-icon"></i> تاريخ الميلاد:
              </label>
              <input type="date" id="birthDateInput" class="input-field" required>
              <p id="birthDateError" class="error-message hidden">تاريخ الميلاد مطلوب.</p>
            </div>

            <div class="mb-5">
              <label class="form-label">
                <i class="fas fa-venus-mars form-icon"></i> الجنس:
              </label>
              <div class="flex gap-4 mt-2">
                <label class="inline-flex items-center">
                  <input type="radio" name="gender" value="Male" id="genderMale" class="form-radio h-5 w-5 text-indigo-600" required>
                  <span class="mr-2 text-gray-700">ذكر</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="radio" name="gender" value="Female" id="genderFemale" class="form-radio h-5 w-5 text-indigo-600" required>
                  <span class="mr-2 text-gray-700">أنثى</span>
                </label>
              </div>
              <p id="genderError" class="error-message hidden">الجنس مطلوب.</p>
            </div>
          </div>

          <div class="toggle-container">
            <label class="toggle-label">الحالة:</label>
            <div class="flex items-center gap-3">
              <span class="status-badge status-alive" id="aliveStatus">
                <i class="fas fa-heartbeat mr-1"></i> على قيد الحياة
              </span>
              <label class="switch">
                <input type="checkbox" id="isAliveInput" checked>
                <span class="slider"></span>
              </label>
              <span class="status-badge status-deceased hidden" id="deceasedStatus">
                <i class="fas fa-skull mr-1"></i> متوفى
              </span>
            </div>
          </div>

          <div class="mb-5 hidden" id="deathDateContainer">
            <label for="deathDateInput" class="form-label">
              <i class="fas fa-skull-crossbones form-icon"></i> تاريخ الوفاة:
            </label>
            <input type="date" id="deathDateInput" class="input-field">
            <p id="deathDateError" class="error-message hidden">تاريخ الوفاة مطلوب إذا كان الشخص متوفى.</p>
          </div>

          <div class="mb-5">
            <label for="notesInput" class="form-label">
              <i class="fas fa-sticky-note form-icon"></i> ملاحظات:
            </label>
            <textarea id="notesInput" class="input-field" rows="4" placeholder="ملاحظات إضافية..."></textarea>
          </div>
        </div>

        <div>
          <h3 class="section-title">الحالة الاجتماعية والعلاقات</h3>
          
          <div class="mb-5">
            <label for="maritalStatusInput" class="form-label">
              <i class="fas fa-ring form-icon"></i> الحالة الاجتماعية:
            </label>
            <select id="maritalStatusInput" class="input-field" required>
              <option value="">اختر الحالة</option>
              <option value="Single">أعزب</option>
              <option value="Engaged">مخطوب</option>
              <option value="Married">متزوج</option>
              <option value="Divorced">مطلق</option>
              <option value="Widowed">أرمل</option>
            </select>
            <p id="maritalStatusError" class="error-message hidden">الحالة الاجتماعية مطلوبة.</p>
          </div>

          <div class="flex-inputs">
            <div class="mb-5 hidden" id="marriageDateContainer">
              <label for="marriageDateInput" class="form-label">
                <i class="fas fa-calendar-check form-icon"></i> تاريخ الزواج:
                <span class="optional-badge">اختياري</span>
              </label>
              <input type="date" id="marriageDateInput" class="input-field">
            </div>

            <div class="mb-5 hidden" id="engagementDateContainer">
              <label for="engagementDateInput" class="form-label">
                <i class="fas fa-heart form-icon"></i> تاريخ الخطوبة:
                <span class="optional-badge">اختياري</span>
              </label>
              <input type="date" id="engagementDateInput" class="input-field">
            </div>
          </div>

          <div id="spousesSection" class="mb-6">
            <h4 class="text-lg font-medium text-gray-700 mb-3">
              <i class="fas fa-user-friends text-indigo-500 mr-2"></i>
              الأزواج/الزوجات:
              <span class="optional-badge">اختياري</span>
            </h4>
            <div id="spousesList" class="bg-gray-50 p-4 rounded-xl mb-4">
              <p id="noSpousesMessage" class="text-gray-600 text-center py-3">لا يوجد أزواج/زوجات مضافون بعد.</p>
            </div>

            <div class="mb-4 input-group">
              <label for="addSpouseInput" class="form-label">
                <i class="fas fa-plus-circle form-icon"></i> إضافة زوج/زوجة:
              </label>
              <input type="text" id="addSpouseInput" class="input-field" placeholder="ابحث أو أدخل اسم الزوج/الزوجة">
              <div id="addSpouseSuggestions" class="suggestions-list hidden"></div>
              <input type="hidden" id="addSpouseIdInput">
              <div class="flex gap-3 mt-3">
                <button type="button" id="addSpouseBtn" class="btn-secondary flex-1">
                  <i class="fas fa-search mr-2"></i>إضافة من القائمة
                </button>
                <button type="button" id="addManualSpouseBtn" class="manual-add-btn">
                  <i class="fas fa-plus"></i> إضافة يدوي
                </button>
              </div>
            </div>
            <p id="spouseGenderError" class="error-message hidden">جنس الزوج/الزوجة غير متوافق مع جنس الشخص الحالي.</p>
          </div>

          <h3 class="section-title mt-8">الأبناء</h3>
          <div id="childrenList" class="bg-gray-50 p-4 rounded-xl mb-4">
            <p class="text-gray-600 text-center py-3" id="noChildrenMessage">لا يوجد أبناء مضافون بعد.</p>
          </div>

          <div class="mb-6 input-group">
            <label for="addChildInput" class="form-label">
              <i class="fas fa-child form-icon"></i> إضافة ابن/ابنة:
            </label>
            <input type="text" id="addChildInput" class="input-field" placeholder="ابحث أو أدخل اسم الابن/الابنة">
            <div id="childrenSuggestions" class="suggestions-list hidden"></div>
            <input type="hidden" id="addChildIdInput">
            <div class="flex gap-3 mt-3">
              <button type="button" id="addChildBtn" class="btn-secondary flex-1">
                <i class="fas fa-search mr-2"></i>إضافة من القائمة
              </button>
              <button type="button" id="addManualChildBtn" class="manual-add-btn">
                <i class="fas fa-plus"></i> إضافة يدوي
              </button>
            </div>
          </div>

          <h3 class="section-title mt-8">روابط إضافية</h3>
          <div class="mb-5">
            <label for="facebookLinkInput" class="form-label">
              <i class="fab fa-facebook text-blue-600 mr-2"></i> رابط فيسبوك:
              <span class="optional-badge">اختياري</span>
            </label>
            <input type="url" id="facebookLinkInput" class="input-field" placeholder="https://facebook.com/username">
          </div>
          <div class="mb-5">
            <label for="linkedinLinkInput" class="form-label">
              <i class="fab fa-linkedin text-blue-500 mr-2"></i> رابط لينكدإن:
              <span class="optional-badge">اختياري</span>
            </label>
            <input type="url" id="linkedinLinkInput" class="input-field" placeholder="https://linkedin.com/in/username">
          </div>
          <div class="mb-5">
            <label for="websiteLinkInput" class="form-label">
              <i class="fas fa-globe text-indigo-500 mr-2"></i> موقع شخصي:
              <span class="optional-badge">اختياري</span>
            </label>
            <input type="url" id="websiteLinkInput" class="input-field" placeholder="https://example.com">
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row justify-end gap-4 mt-8 pt-6 border-t border-gray-100">
        <button type="button" class="btn-secondary" id="cancelBtn">
          <i class="fas fa-times mr-2"></i>إلغاء
        </button>
        <button type="button" class="btn-primary" id="saveAndAddAnotherBtn">
          <i class="fas fa-save mr-2"></i>حفظ وإضافة آخر
        </button>
        <button type="submit" class="btn-primary" id="savePersonBtn">
          <i class="fas fa-check mr-2"></i>حفظ البيانات
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase SDK (Firestore only, no Auth) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBOXGJek0FHS1VqXhkgORMq-VrPoN1db3w",
    authDomain: "family-9b0b8.firebaseapp.com",
    databaseURL: "https://family-9b0b8-default-rtdb.firebaseio.com",
    projectId: "family-9b0b8",
    storageBucket: "family-9b0b8.firebasestorage.app",
    messagingSenderId: "409089079475",
    appId: "1:409089079475:web:93f8be81e247ecfe2758c6",
    measurementId: "G-X5LDQB1WC9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // appId constant
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // Public Firestore path
  const baseCollectionPath = `artifacts/${appId}/familyMembers`;

  // globals
  let editingPersonId = null;
  let allFamilyMembers = [];
  let originalPersonData = null;
  let hasUnsavedChanges = false;
  let currentChildren = new Map();
  let currentSpouses = new Map();

  // DOM references
  let pageTitle, personForm, firstNameInput, firstNameError, fatherNameInput, fatherSuggestions, fatherIdInput, grandFatherNameInput;
  let familyNameInput, familyNameError, motherNameInput, motherSuggestions, motherIdInput, idNumberInput, idNumberError;
  let phoneNumberInput, birthDateInput, birthDateError, genderMale, genderFemale, genderError, isAliveInput, deathDateContainer, deathDateInput, deathDateError;
  let aliveStatus, deceasedStatus;
  let maritalStatusInput, maritalStatusError, marriageDateContainer, marriageDateInput, engagementDateContainer, engagementDateInput;
  let spousesSection, spousesListDiv, noSpousesMessage, addSpouseInput, addSpouseSuggestions, addSpouseIdInput, addSpouseBtn, spouseError, spouseGenderError;
  let childrenListDiv, noChildrenMessage, addChildInput, childrenSuggestions, addChildIdInput, addChildBtn, savePersonBtn, saveAndAddAnotherBtn, cancelBtn;
  let facebookLinkInput, linkedinLinkInput, websiteLinkInput, notesInput, photoUpload, photoInput, personPhoto;
  let addManualSpouseBtn, addManualChildBtn;

  // Modal helpers
  const showModal = (msg) => { 
    document.getElementById('modalMessage').textContent = msg; 
    document.getElementById('messageModal').style.display = 'flex'; 
  };
  const closeModal = (id) => { document.getElementById(id).style.display = 'none'; };
  const showLoadingModal = () => { document.getElementById('loadingModal').style.display = 'flex'; };
  const hideLoadingModal = () => { document.getElementById('loadingModal').style.display = 'none'; };

  // Fetch all family members (for suggestions & caching)
  async function fetchAllFamilyMembers() {
    try {
      const q = collection(db, baseCollectionPath);
      const snapshot = await getDocs(q);
      allFamilyMembers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      console.log("cached all family members:", allFamilyMembers.length);
    } catch (err) {
      console.error("fetchAllFamilyMembers error:", err);
      showModal("خطأ أثناء جلب بيانات العائلة: " + (err.message || err));
    }
  }

  // Handle suggestions input
  function handleRelatedPersonInput(inputElement, suggestionsElement, hiddenIdElement, relationType) {
    if (!inputElement) return;
    
    inputElement.addEventListener('input', () => {
      hasUnsavedChanges = true;
      if (suggestionsElement) { suggestionsElement.innerHTML = ''; suggestionsElement.classList.add('hidden'); }
      if (hiddenIdElement) hiddenIdElement.value = '';

      const searchText = inputElement.value.trim().toLowerCase();
      if (searchText.length < 2) return;

      let filtered = allFamilyMembers.filter(p => p.fullName && p.fullName.toLowerCase().includes(searchText) && p.id !== editingPersonId);

      if (relationType === 'mother') filtered = filtered.filter(p => p.gender === 'Female');
      if (relationType === 'father') filtered = filtered.filter(p => p.gender === 'Male');
      if (relationType === 'spouse') {
        const curGender = document.querySelector('input[name="gender"]:checked')?.value;
        if (curGender === 'Male') filtered = filtered.filter(p => p.gender === 'Female');
        if (curGender === 'Female') filtered = filtered.filter(p => p.gender === 'Male');
      }

      if (filtered.length && suggestionsElement) {
        suggestionsElement.classList.remove('hidden');
        filtered.forEach(person => {
          const div = document.createElement('div');
          div.className = 'suggestions-list-item';
          div.textContent = person.fullName || (person.firstName || '');
          div.addEventListener('click', async () => {
            if (relationType === 'father') {
              inputElement.value = person.firstName || person.fullName;
              // استخراج الاسم الأول للجد فقط
              if (person.fatherName) {
                const grandFatherFirstName = person.fatherName.split(' ')[0];
                grandFatherNameInput.value = grandFatherFirstName;
              }
            } else {
              inputElement.value = person.fullName || person.firstName;
            }
            
            if (hiddenIdElement) hiddenIdElement.value = person.id;
            suggestionsElement.classList.add('hidden');

            // تعبئة اسم العائلة تلقائياً
            if ((relationType === 'father' || relationType === 'mother') && person.familyName) {
              familyNameInput.value = person.familyName;
            }

            // إضافة زوجة الأب تلقائياً
            if (relationType === 'father') {
              if (person.spouseIds && person.spouseIds.length) {
                const potentialMotherId = person.spouseIds.find(sId => {
                  const s = allFamilyMembers.find(m => m.id === sId);
                  return s && s.gender === 'Female';
                });
                if (potentialMotherId) {
                  const m = allFamilyMembers.find(mm => mm.id === potentialMotherId);
                  motherNameInput.value = m ? (m.fullName || '') : '';
                  motherIdInput.value = m ? m.id : '';
                }
              }
            }
          });
          suggestionsElement.appendChild(div);
        });
      }
    });

    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', (ev) => {
      if (suggestionsElement && !inputElement.parentNode.contains(ev.target)) suggestionsElement.classList.add('hidden');
    });
  }
  // Render children and spouses lists
  function renderChildrenList() {
    childrenListDiv.innerHTML = '';
    if (currentChildren.size === 0) { 
      noChildrenMessage.classList.remove('hidden'); 
      return; 
    }
    noChildrenMessage.classList.add('hidden');
    
    const arr = Array.from(currentChildren.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    arr.forEach(child => {
      const div = document.createElement('div'); 
      div.className='relation-item';
      
      const span = document.createElement('span'); 
      span.textContent = child.name;
      span.className = child.isManual ? 'italic text-gray-600' : '';
      
      const btn = document.createElement('button'); 
      btn.type='button'; 
      btn.className='btn-secondary px-3 py-1 text-sm'; 
      btn.innerHTML = '<i class="fas fa-times"></i>';
      btn.title = 'إزالة';
      btn.addEventListener('click', ()=>{ 
        currentChildren.delete(child.id); 
        renderChildrenList(); 
        hasUnsavedChanges=true; 
      });
      
      div.appendChild(span); 
      div.appendChild(btn); 
      childrenListDiv.appendChild(div);
    });
  }
  
  function renderSpousesList() {
    spousesListDiv.innerHTML = '';
    if (currentSpouses.size === 0) { 
      noSpousesMessage.classList.remove('hidden'); 
      return; 
    }
    noSpousesMessage.classList.add('hidden');
    
    const arr = Array.from(currentSpouses.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    arr.forEach(sp => {
      const div = document.createElement('div'); 
      div.className='relation-item';
      
      const span = document.createElement('span'); 
      span.textContent = sp.name;
      span.className = sp.isManual ? 'italic text-gray-600' : '';
      
      const btn = document.createElement('button'); 
      btn.type='button'; 
      btn.className='btn-secondary px-3 py-1 text-sm'; 
      btn.innerHTML = '<i class="fas fa-times"></i>';
      btn.title = 'إزالة';
      btn.addEventListener('click', ()=>{ 
        currentSpouses.delete(sp.id); 
        renderSpousesList(); 
        hasUnsavedChanges=true; 
      });
      
      div.appendChild(span); 
      div.appendChild(btn); 
      spousesListDiv.appendChild(div);
    });
  }

  // Load person data for edit
  async function loadPersonData(personId) {
    try {
      const docRef = doc(db, baseCollectionPath, personId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) { 
        showModal("لم يتم العثور على بيانات لهذا الشخص."); 
        editingPersonId = null; 
        pageTitle.textContent='إضافة شخص جديد'; 
        return; 
      }
      
      const data = docSnap.data();
      originalPersonData = { ...data, id: docSnap.id };
      
      // populate fields
      firstNameInput.value = data.firstName || '';
      fatherNameInput.value = data.fatherName || '';
      fatherIdInput.value = data.fatherId || '';
      grandFatherNameInput.value = data.grandFatherName || '';
      familyNameInput.value = data.familyName || '';
      motherNameInput.value = data.motherName || '';
      motherIdInput.value = data.motherId || '';
      idNumberInput.value = data.idNumber || '';
      phoneNumberInput.value = data.phoneNumber || '';
      birthDateInput.value = data.birthDate ? data.birthDate.toDate().toISOString().split('T')[0] : '';
      
      if (data.gender === 'Male') genderMale.checked = true; 
      else if (data.gender === 'Female') genderFemale.checked = true;
      
      isAliveInput.checked = data.isAlive !== false;
      updateLifeStatus();
      
      deathDateInput.value = data.deathDate ? data.deathDate.toDate().toISOString().split('T')[0] : '';
      maritalStatusInput.value = data.maritalStatus || '';
      marriageDateInput.value = data.marriageDate ? data.marriageDate.toDate().toISOString().split('T')[0] : '';
      engagementDateInput.value = data.engagementDate ? data.engagementDate.toDate().toISOString().split('T')[0] : '';
      
      // spouses
      currentSpouses.clear();
      if (data.spouseIds && data.spouseIds.length) {
        data.spouseIds.forEach(sId => {
          const s = allFamilyMembers.find(m => m.id === sId);
          if (s) currentSpouses.set(sId, { id: sId, name: s.fullName || (s.firstName || ''), isManual: false });
        });
      }
      if (data.manualSpouseNames && data.manualSpouseNames.length) {
        data.manualSpouseNames.forEach(name => currentSpouses.set(`manual-${crypto.randomUUID()}`, { 
          id: `manual-${crypto.randomUUID()}`, 
          name, 
          isManual: true 
        }));
      }
      renderSpousesList();
      updateMaritalStatusUI();

      // children
      currentChildren.clear();
      if (data.childrenIds && data.childrenIds.length) {
        data.childrenIds.forEach(cId => {
          const ch = allFamilyMembers.find(m => m.id === cId);
          if (ch) currentChildren.set(cId, { id: cId, name: ch.fullName || (ch.firstName || ''), isManual: false });
        });
      }
      if (data.manualChildNames && data.manualChildNames.length) {
        data.manualChildNames.forEach(name => currentChildren.set(`manual-${crypto.randomUUID()}`, { 
          id: `manual-${crypto.randomUUID()}`, 
          name, 
          isManual: true 
        }));
      }
      renderChildrenList();

      facebookLinkInput.value = data.facebookLink || '';
      linkedinLinkInput.value = data.linkedinLink || '';
      websiteLinkInput.value = data.websiteLink || '';
      notesInput.value = data.notes || '';

      hasUnsavedChanges = false;
      pageTitle.textContent = 'تعديل شخص';
      savePersonBtn.textContent = 'تحديث البيانات';
    } catch (err) {
      console.error("loadPersonData error:", err);
      showModal("خطأ أثناء تحميل بيانات الشخص: " + (err.message || err));
    }
  }

 
  // Update UI based on life status
  function updateLifeStatus() {
    const isAlive = isAliveInput.checked;
    
    if (isAlive) {
      if (aliveStatus) aliveStatus.classList.remove('hidden');
      if (deceasedStatus) deceasedStatus.classList.add('hidden');
      if (deathDateContainer) deathDateContainer.classList.add('hidden');
      if (deathDateInput) deathDateInput.value = '';
    } else {
      if (aliveStatus) aliveStatus.classList.add('hidden');
      if (deceasedStatus) deceasedStatus.classList.remove('hidden');
      if (deathDateContainer) deathDateContainer.classList.remove('hidden');
    }
  }
  
  // Update UI based on marital status
  function updateMaritalStatusUI() {
    const status = maritalStatusInput.value;
    
    // إظهار/إخفاء تاريخ الزواج
    if (marriageDateContainer) {
      marriageDateContainer.classList.toggle('hidden', status !== 'Married');
    }
    
    // إظهار/إخفاء تاريخ الخطوبة
    if (engagementDateContainer) {
      engagementDateContainer.classList.toggle('hidden', status !== 'Engaged');
    }
    
    // إظهار/إخفاء قسم الأزواج
    if (spousesSection) {
      spousesSection.classList.toggle('hidden', status !== 'Married' && status !== 'Engaged');
    }
    
    if (status !== 'Married' && status !== 'Engaged') {
      if (marriageDateInput) marriageDateInput.value = '';
      if (engagementDateInput) engagementDateInput.value = '';
    }
  }

  // Validation
  async function validateForm(personData, isNewPerson) {
    let isValid = true;
    // إخفاء جميع رسائل الخطأ
    document.querySelectorAll('.error-message').forEach(e => {
      if (e) e.classList.add('hidden');
    });
    // إزالة حالة الخطأ من الحقول
    document.querySelectorAll('.input-field').forEach(e => {
      if (e) e.classList.remove('error');
    });
    // إزالة حالة الخطأ من أزرار الجنس
    if (genderMale) genderMale.classList.remove('error');
    if (genderFemale) genderFemale.classList.remove('error');

    // التحقق من الحقول المطلوبة
    if (!firstNameInput.value.trim()) { 
      if (firstNameError) firstNameError.classList.remove('hidden'); 
      if (firstNameInput) firstNameInput.classList.add('error'); 
      isValid = false; 
    }
    
    if (!familyNameInput.value.trim()) { 
      if (familyNameError) familyNameError.classList.remove('hidden'); 
      if (familyNameInput) familyNameInput.classList.add('error'); 
      isValid = false; 
    }
    
    if (!birthDateInput.value) { 
      if (birthDateError) birthDateError.classList.remove('hidden'); 
      if (birthDateInput) birthDateInput.classList.add('error'); 
      isValid = false; 
    }
    
    const selectedGender = document.querySelector('input[name="gender"]:checked');
    if (!selectedGender) { 
      if (genderError) genderError.classList.remove('hidden'); 
      if (genderMale) genderMale.classList.add('error'); 
      if (genderFemale) genderFemale.classList.add('error'); 
      isValid = false; 
    }
    
    if (!isAliveInput.checked) {
      if ((!deathDateInput || !deathDateInput.value.trim())) { 
        if (deathDateError) deathDateError.classList.remove('hidden'); 
        if (deathDateInput) deathDateInput.classList.add('error'); 
        isValid = false; 
      }
    }
    
    if (!maritalStatusInput.value) { 
      if (maritalStatusError) maritalStatusError.classList.remove('hidden'); 
      if (maritalStatusInput) maritalStatusInput.classList.add('error'); 
      isValid = false; 
    }

    // لم نعد نطلب زوج/زوجة للحالة الاجتماعية

    // التحقق من التكرارات
    try {
      const qFullName = query(collection(db, baseCollectionPath), where("fullName", "==", personData.fullName));
      const qIdNumber = query(collection(db, baseCollectionPath), where("idNumber", "==", personData.idNumber || ""));
      const [fullNameSnap, idNumberSnap] = await Promise.all([ getDocs(qFullName), getDocs(qIdNumber) ]);

      const fullNameDuplicates = fullNameSnap.docs.filter(d => d.id !== editingPersonId);
      if (fullNameDuplicates.length > 0) { 
        showModal("شخص بنفس الاسم الكامل موجود بالفعل."); 
        if (firstNameInput) firstNameInput.classList.add('error'); 
        if (familyNameInput) familyNameInput.classList.add('error'); 
        isValid = false; 
      }

      if (personData.idNumber && personData.idNumber.trim()) {
        const idNumberDuplicates = idNumberSnap.docs.filter(d => d.id !== editingPersonId);
        if (idNumberDuplicates.length > 0) { 
          showModal("شخص بنفس رقم الهوية موجود بالفعل."); 
          if (idNumberInput) idNumberInput.classList.add('error'); 
          if (idNumberError) idNumberError.classList.remove('hidden'); 
          isValid = false; 
        }
      }
    } catch (err) {
      console.error("validateForm duplicates error:", err);
      showModal("تحذير: تعذر التحقق من التكرارات. تأكد من اتصال الإنترنت وصلاحيات Firestore.");
    }

    return isValid;
  }
  // Reset form
  function resetForm() {
    personForm.reset();
    editingPersonId = null;
    pageTitle.textContent = 'إضافة شخص جديد';
    savePersonBtn.textContent = 'حفظ البيانات';
    isAliveInput.checked = true;
    updateLifeStatus();
    maritalStatusInput.value = '';
    updateMaritalStatusUI();
    currentChildren.clear(); 
    currentSpouses.clear();
    renderChildrenList(); 
    renderSpousesList();
    originalPersonData = null;
    hasUnsavedChanges = false;
    document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));
    personPhoto.style.display = 'none';
    photoUpload.querySelector('i').style.display = 'block';
    photoUpload.querySelector('span').style.display = 'block';
  }

  // Save or update person
  async function savePerson(redirectToProfile = true) {
    showLoadingModal();
    try {
      // compose data
      const personData = {
        firstName: firstNameInput.value.trim(),
        fatherName: fatherNameInput.value.trim(),
        fatherId: fatherIdInput.value.trim() || null,
        grandFatherName: grandFatherNameInput.value.trim(),
        familyName: familyNameInput.value.trim(),
        motherName: motherNameInput.value.trim(),
        motherId: motherIdInput.value.trim() || null,
        idNumber: idNumberInput.value.trim() || null,
        phoneNumber: phoneNumberInput.value.trim() || null,
        birthDate: birthDateInput.value ? Timestamp.fromDate(new Date(birthDateInput.value)) : null,
        gender: document.querySelector('input[name="gender"]:checked')?.value || null,
        isAlive: isAliveInput.checked,
        deathDate: (isAliveInput.checked || !deathDateInput.value) ? null : Timestamp.fromDate(new Date(deathDateInput.value)),
        maritalStatus: maritalStatusInput.value || null,
        marriageDate: maritalStatusInput.value === 'Married' && marriageDateInput.value ? Timestamp.fromDate(new Date(marriageDateInput.value)) : null,
        engagementDate: maritalStatusInput.value === 'Engaged' && engagementDateInput.value ? Timestamp.fromDate(new Date(engagementDateInput.value)) : null,
        spouseIds: [],
        manualSpouseNames: [],
        childrenIds: [],
        manualChildNames: [],
        facebookLink: facebookLinkInput.value.trim() || null,
        linkedinLink: linkedinLinkInput.value.trim() || null,
        websiteLink: websiteLinkInput.value.trim() || null,
        notes: notesInput.value.trim() || null
      };

      // Process spouses
      currentSpouses.forEach(s => {
        if (s.isManual) {
          personData.manualSpouseNames.push(s.name);
        } else {
          personData.spouseIds.push(s.id);
        }
      });

      // Process children
      currentChildren.forEach(c => {
        if (c.isManual) {
          personData.manualChildNames.push(c.name);
        } else {
          personData.childrenIds.push(c.id);
        }
      });

      personData.fullName = `${personData.firstName} ${personData.fatherName} ${personData.grandFatherName} ${personData.familyName}`.trim().replace(/\s+/g,' ');

      const isNew = !editingPersonId;
      if (!(await validateForm(personData, isNew))) { 
        hideLoadingModal(); 
        showModal("الرجاء تصحيح الأخطاء قبل الحفظ."); 
        return; 
      }

      let savedPersonId = editingPersonId;

      if (editingPersonId) {
        // update
        const docRef = doc(db, baseCollectionPath, editingPersonId);
        await setDoc(docRef, personData, { merge: true });
        showModal("تم تحديث بيانات الشخص بنجاح!");
      } else {
        // add
        const collRef = collection(db, baseCollectionPath);
        const newDoc = await addDoc(collRef, personData);
        savedPersonId = newDoc.id;
        showModal("تم إضافة شخص جديد بنجاح!");
      }

      // update father's childrenIds
      if (personData.fatherId && savedPersonId) {
        try {
          const fatherRef = doc(db, baseCollectionPath, personData.fatherId);
          const fatherSnap = await getDoc(fatherRef);
          if (fatherSnap.exists()) {
            const fatherData = fatherSnap.data();
            const setKids = new Set(fatherData.childrenIds || []);
            setKids.add(savedPersonId);
            await setDoc(fatherRef, { childrenIds: Array.from(setKids) }, { merge: true });
          }
        } catch (err) { console.warn("update father children error:", err); }
      }

      // keep spouse bidirectional for linked spouses
      try {
        const newLinked = new Set(personData.spouseIds || []);
        const oldLinked = new Set(originalPersonData?.spouseIds || []);
        // add
        for (const sId of newLinked) {
          if (!oldLinked.has(sId)) {
            const sRef = doc(db, baseCollectionPath, sId);
            const sSnap = await getDoc(sRef);
            if (sSnap.exists()) {
              const sData = sSnap.data();
              const sSet = new Set(sData.spouseIds || []);
              sSet.add(savedPersonId);
              await setDoc(sRef, { spouseIds: Array.from(sSet) }, { merge: true });
            }
          }
        }
        // remove
        for (const sId of oldLinked) {
          if (!newLinked.has(sId)) {
            const sRef = doc(db, baseCollectionPath, sId);
            const sSnap = await getDoc(sRef);
            if (sSnap.exists()) {
              const sData = sSnap.data();
              const sSet = new Set(sData.spouseIds || []);
              sSet.delete(savedPersonId);
              await setDoc(sRef, { spouseIds: Array.from(sSet) }, { merge: true });
            }
          }
        }
      } catch (err) { console.warn("spouse bidirectional update error:", err); }

      hasUnsavedChanges = false;

      if (redirectToProfile) {
        setTimeout(() => { window.location.href = `profile.html?id=${savedPersonId}`; }, 1200);
      } else {
        await fetchAllFamilyMembers();
        resetForm();
      }
    } catch (err) {
      console.error("savePerson error:", err);
      showModal("حدث خطأ أثناء حفظ البيانات: " + (err.message || err));
    } finally {
      hideLoadingModal();
    }
  }

  // Before unload warning
  window.onbeforeunload = (e) => {
    if (hasUnsavedChanges) { 
      e.preventDefault(); 
      e.returnValue = ''; 
      return 'لديك تغييرات غير محفوظة.'; 
    }
  };

  // DOM ready
  document.addEventListener('DOMContentLoaded', async () => {
    // assign DOM
    pageTitle = document.getElementById('pageTitle');
    personForm = document.getElementById('personForm');
    firstNameInput = document.getElementById('firstNameInput'); 
    firstNameError = document.getElementById('firstNameError');
    fatherNameInput = document.getElementById('fatherNameInput'); 
    fatherSuggestions = document.getElementById('fatherSuggestions'); 
    fatherIdInput = document.getElementById('fatherIdInput');
    grandFatherNameInput = document.getElementById('grandFatherNameInput');
    familyNameInput = document.getElementById('familyNameInput'); 
    familyNameError = document.getElementById('familyNameError');
    motherNameInput = document.getElementById('motherNameInput'); 
    motherSuggestions = document.getElementById('motherSuggestions'); 
    motherIdInput = document.getElementById('motherIdInput');
    idNumberInput = document.getElementById('idNumberInput'); 
    idNumberError = document.getElementById('idNumberError');
    phoneNumberInput = document.getElementById('phoneNumberInput'); 
    birthDateInput = document.getElementById('birthDateInput'); 
    birthDateError = document.getElementById('birthDateError');
    genderMale = document.getElementById('genderMale'); 
    genderFemale = document.getElementById('genderFemale'); 
    genderError = document.getElementById('genderError');
    isAliveInput = document.getElementById('isAliveInput'); 
    deathDateContainer = document.getElementById('deathDateContainer'); 
    deathDateInput = document.getElementById('deathDateInput'); 
    deathDateError = document.getElementById('deathDateError');
    aliveStatus = document.getElementById('aliveStatus');
    deceasedStatus = document.getElementById('deceasedStatus');
    maritalStatusInput = document.getElementById('maritalStatusInput'); 
    maritalStatusError = document.getElementById('maritalStatusError');
    marriageDateContainer = document.getElementById('marriageDateContainer'); 
    marriageDateInput = document.getElementById('marriageDateInput');
    engagementDateContainer = document.getElementById('engagementDateContainer'); 
    engagementDateInput = document.getElementById('engagementDateInput');

    spousesSection = document.getElementById('spousesSection'); 
    spousesListDiv = document.getElementById('spousesList'); 
    noSpousesMessage = document.getElementById('noSpousesMessage');
    addSpouseInput = document.getElementById('addSpouseInput'); 
    addSpouseSuggestions = document.getElementById('addSpouseSuggestions'); 
    addSpouseIdInput = document.getElementById('addSpouseIdInput'); 
    addSpouseBtn = document.getElementById('addSpouseBtn');
    spouseError = document.getElementById('spouseError'); 
    spouseGenderError = document.getElementById('spouseGenderError');

    childrenListDiv = document.getElementById('childrenList'); 
    noChildrenMessage = document.getElementById('noChildrenMessage');
    addChildInput = document.getElementById('addChildInput'); 
    childrenSuggestions = document.getElementById('childrenSuggestions'); 
    addChildIdInput = document.getElementById('addChildIdInput'); 
    addChildBtn = document.getElementById('addChildBtn');

    savePersonBtn = document.getElementById('savePersonBtn'); 
    saveAndAddAnotherBtn = document.getElementById('saveAndAddAnotherBtn'); 
    cancelBtn = document.getElementById('cancelBtn');
    facebookLinkInput = document.getElementById('facebookLinkInput'); 
    linkedinLinkInput = document.getElementById('linkedinLinkInput'); 
    websiteLinkInput = document.getElementById('websiteLinkInput'); 
    notesInput = document.getElementById('notesInput');
    
    photoUpload = document.getElementById('photoUpload');
    photoInput = document.getElementById('photoInput');
    personPhoto = document.getElementById('personPhoto');
    
    addManualSpouseBtn = document.getElementById('addManualSpouseBtn');
    addManualChildBtn = document.getElementById('addManualChildBtn');

    // modal handlers
    document.getElementById('closeMessageModalBtn').addEventListener('click', ()=> closeModal('messageModal'));
    document.getElementById('confirmMessageModalBtn').addEventListener('click', ()=> closeModal('messageModal'));
    isAliveInput.addEventListener('change', () => { 
          updateLifeStatus(); 
          hasUnsavedChanges = true; 
    // read URL param for edit mode
    const urlParams = new URLSearchParams(window.location.search);
    editingPersonId = urlParams.get('id');

    if (editingPersonId) { 
      pageTitle.textContent = 'تعديل شخص'; 
      savePersonBtn.textContent = 'تحديث البيانات'; 
    } else { 
      pageTitle.textContent = 'إضافة شخص جديد'; 
      savePersonBtn.textContent = 'حفظ البيانات'; 
      isAliveInput.checked = true; 
      updateLifeStatus();
      updateMaritalStatusUI();
    }

    // initial data load (no auth required)
    await fetchAllFamilyMembers();

    if (editingPersonId) await loadPersonData(editingPersonId);

    // attach handlers for suggestions
    handleRelatedPersonInput(firstNameInput, null, null, 'self');
    handleRelatedPersonInput(fatherNameInput, fatherSuggestions, fatherIdInput, 'father');
    handleRelatedPersonInput(motherNameInput, motherSuggestions, motherIdInput, 'mother');
    handleRelatedPersonInput(addSpouseInput, addSpouseSuggestions, addSpouseIdInput, 'spouse');
    handleRelatedPersonInput(addChildInput, childrenSuggestions, addChildIdInput, 'child');

    // event listeners
    isAliveInput.addEventListener('change', () => { 
      updateLifeStatus(); 
      hasUnsavedChanges = true; 
    });
    
    maritalStatusInput.addEventListener('change', () => {
      updateMaritalStatusUI();
      hasUnsavedChanges = true;
    });

    personForm.addEventListener('input', () => hasUnsavedChanges = true);

    savePersonBtn.addEventListener('click', async (e) => { 
      e.preventDefault(); 
      await savePerson(true); 
    });
    
    saveAndAddAnotherBtn.addEventListener('click', async (e) => { 
      e.preventDefault(); 
      await savePerson(false); 
    });

    cancelBtn.addEventListener('click', () => {
      if (hasUnsavedChanges) {
        showModal("لديك تغييرات غير محفوظة. هل تريد الإلغاء فعلاً؟");
        document.getElementById('confirmMessageModalBtn').onclick = () => { 
          closeModal('messageModal'); 
          hasUnsavedChanges = false; 
          if (editingPersonId) window.location.href = `profile.html?id=${editingPersonId}`; 
          else window.location.href = 'index.html'; 
        };
      } else {
        if (editingPersonId) window.location.href = `profile.html?id=${editingPersonId}`; 
        else window.location.href = 'index.html';
      }
    });

    addChildBtn.addEventListener('click', () => {
      const childId = addChildIdInput.value; 
      const childName = addChildInput.value.trim();
      
      if (childId && childName) {
        if (!currentChildren.has(childId)) { 
          currentChildren.set(childId, { id: childId, name: childName, isManual: false }); 
          addChildInput.value = ''; 
          addChildIdInput.value = ''; 
          childrenSuggestions.classList.add('hidden'); 
          renderChildrenList(); 
          hasUnsavedChanges = true; 
        } else {
          showModal("هذا الابن/الابنة مضاف بالفعل.");
        }
      } else {
        showModal("يرجى اختيار ابن/ابنة من الاقتراحات.");
      }
    });

    addManualChildBtn.addEventListener('click', () => {
      const childName = addChildInput.value.trim();
      
      if (childName) {
        const entryId = `manual-${crypto.randomUUID()}`;
        currentChildren.set(entryId, { 
          id: entryId, 
          name: childName, 
          isManual: true 
        });
        addChildInput.value = '';
        addChildIdInput.value = '';
        childrenSuggestions.classList.add('hidden');
        renderChildrenList();
        hasUnsavedChanges = true;
      } else {
        showModal("يرجى إدخال اسم الابن/الابنة.");
      }
    });

    addSpouseBtn.addEventListener('click', () => {
      const spouseId = addSpouseIdInput.value; 
      const spouseName = addSpouseInput.value.trim();
      
      if (!spouseName) { 
        showModal("يرجى إدخال اسم الزوج/الزوجة."); 
        return; 
      }
      
      if (spouseId) {
        const currentGender = document.querySelector('input[name="gender"]:checked')?.value;
        const spousePerson = allFamilyMembers.find(m => m.id === spouseId);
        if (currentGender && spousePerson && currentGender === spousePerson.gender) { 
          spouseGenderError.classList.remove('hidden'); 
          showModal("لا يمكن إضافة زوج/زوجة من نفس الجنس."); 
          return; 
        } else {
          spouseGenderError.classList.add('hidden');
        }
      }
      
      const isManual = !spouseId;
      const entryId = isManual ? `manual-${crypto.randomUUID()}` : spouseId;
      
      if (!currentSpouses.has(entryId)) { 
        currentSpouses.set(entryId, { 
          id: entryId, 
          name: spouseName, 
          isManual 
        }); 
        addSpouseInput.value = ''; 
        addSpouseIdInput.value = ''; 
        addSpouseSuggestions.classList.add('hidden'); 
        renderSpousesList(); 
        hasUnsavedChanges = true; 
      } else {
        showModal("هذا الزوج/الزوجة مضاف بالفعل.");
      }
    });

    addManualSpouseBtn.addEventListener('click', () => {
      const spouseName = addSpouseInput.value.trim();
      
      if (spouseName) {
        const entryId = `manual-${crypto.randomUUID()}`;
        currentSpouses.set(entryId, { 
          id: entryId, 
          name: spouseName, 
          isManual: true 
        });
        addSpouseInput.value = '';
        addSpouseIdInput.value = '';
        addSpouseSuggestions.classList.add('hidden');
        renderSpousesList();
        hasUnsavedChanges = true;
      } else {
        showModal("يرجى إدخال اسم الزوج/الزوجة.");
      }
    });

    // Photo upload handling
    photoUpload.addEventListener('click', () => {
      photoInput.click();
    });
    
    photoInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (event) => {
          personPhoto.src = event.target.result;
          personPhoto.style.display = 'block';
          photoUpload.querySelector('i').style.display = 'none';
          photoUpload.querySelector('span').style.display = 'none';
          hasUnsavedChanges = true;
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });

  }); // DOMContentLoaded end
</script>
</body>
</html>
