<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إحصائيات العائلة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .stat-box {
            background-color: #e0f2fe;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .stat-box .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2563eb;
        }
        .stat-box .label {
            font-size: 1rem;
            color: #374151;
            margin-top: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        #chartDetailsModal .modal-content {
            max-width: 600px;
            text-align: right;
        }
        #chartDetailsList li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        #chartDetailsList li:last-child {
            border-bottom: none;
        }
        .person-link {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 500;
        }
        .person-link:hover {
            text-decoration: underline;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .filter-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .filter-group select {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: white;
            cursor: pointer;
        }
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            .btn-primary, .btn-secondary, nav, .flex.flex-wrap.justify-end.gap-4.mt-6.mb-6, .filter-group {
                display: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #eee;
                margin-bottom: 1rem;
                page-break-inside: avoid;
            }
            .chart-container {
                height: auto;
                width: 100%;
            }
            canvas {
                max-width: 100%;
                height: auto !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span id="closeMessageModalBtn" class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="confirmMessageModalBtn" class="btn-primary">حسناً</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="spinner"></div>
            <p class="text-lg font-semibold text-gray-800">جارٍ تحميل الإحصائيات...</p>
        </div>
    </div>

    <!-- Modal for Chart Details (Drill-down) -->
    <div id="chartDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeChartDetailsModalBtn" class="close-button">&times;</span>
            <h3 id="chartDetailsTitle" class="text-2xl font-semibold text-gray-700 mb-4">تفاصيل الفئة</h3>
            <ul id="chartDetailsList" class="list-disc pr-6 text-gray-700">
                <!-- Details will be loaded here -->
            </ul>
        </div>
    </div>

    <div class="container">
        <!-- Header and Navigation -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">لوحة إحصائيات العائلة</h1>
            <nav class="flex flex-wrap gap-3" id="mainNav">
                <a href="#" class="btn-secondary nav-link">لوحة التحكم</a>
                <a href="#" class="btn-secondary nav-link">قائمة العائلة</a>
                <a href="#" class="btn-secondary nav-link">الأحداث</a>
                <a href="#" class="btn-secondary nav-link">شجرة العائلة</a>
                <a href="#" class="btn-secondary nav-link">إضافة شخص جديد</a>
                <a href="#" class="btn-secondary nav-link">تصدير البيانات</a>
                <a href="#" class="btn-primary">الإحصائيات</a>
            </nav>
        </div>

        <!-- General Statistics -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">إحصائيات عامة</h2>
            <div class="filter-group">
                <label for="familyFilter">تحديد العائلة:</label>
                <select id="familyFilter" class="input-field w-auto">
                    <option value="All">الكل</option>
                    <!-- Family names will be populated here by JavaScript -->
                </select>
            </div>
            <div id="statisticsContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <div class="stat-box" id="statTotalMembers">
                    <div id="totalMembers" class="value">0</div>
                    <div class="label">إجمالي أفراد العائلة</div>
                </div>
                <div class="stat-box" id="statAliveMembers">
                    <div id="aliveMembers" class="value">0</div>
                    <div class="label">أفراد على قيد الحياة</div>
                </div>
                <div class="stat-box" id="statDeceasedMembers">
                    <div id="deceasedMembers" class="value">0</div>
                    <div class="label">أفراد متوفون</div>
                </div>
                <div class="stat-box">
                    <div id="averageAge" class="value">0</div>
                    <div class="label">متوسط العمر (الأحياء)</div>
                </div>
                <div class="stat-box">
                    <div id="averageAgeAtDeath" class="value">0</div>
                    <div class="label">متوسط العمر عند الوفاة</div>
                </div>
                <div class="stat-box" id="statUniqueFamilyNames">
                    <div id="uniqueFamilyNames" class="value">0</div>
                    <div class="label">عدد أسماء العائلات الفريدة</div>
                </div>
                <div class="stat-box" id="statLivingMales">
                    <div id="livingMales" class="value">0</div>
                    <div class="label">ذكور أحياء</div>
                </div>
                <div class="stat-box" id="statLivingFemales">
                    <div id="livingFemales" class="value">0</div>
                    <div class="label">إناث أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarried">
                    <div id="livingMarried" class="value">0</div>
                    <div class="label">متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingEngaged">
                    <div id="livingEngaged" class="value">0</div>
                    <div class="label">مخطوبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedMales">
                    <div id="livingMarriedMales" class="value">0</div>
                    <div class="label">ذكور متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedFemales">
                    <div id="livingMarriedFemales" class="value">0</div>
                    <div class="label">إناث متزوجات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleMales">
                    <div id="livingSingleMales" class="value">0</div>
                    <div class="label">ذكور عازبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedMales">
                    <div id="livingDivorcedMales" class="value">0</div>
                    <div class="label">ذكور مطلقون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedMales">
                    <div id="livingWidowedMales" class="value">0</div>
                    <div class="label">ذكور أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleFemales">
                    <div id="livingSingleFemales" class="value">0</div>
                    <div class="label">إناث عازبات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedFemales">
                    <div id="livingDivorcedFemales" class="value">0</div>
                    <div class="label">إناث مطلقات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedFemales">
                    <div id="livingWidowedFemales" class="value">0</div>
                    <div class="label">إناث أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statMalesOver16">
                    <div id="malesOver16" class="value">0</div>
                    <div class="label">ذكور فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesOver16">
                    <div id="femalesOver16" class="value">0</div>
                    <div class="label">إناث فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statMalesUnder16">
                    <div id="malesUnder16" class="value">0</div>
                    <div class="label">ذكور أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesUnder16">
                    <div id="femalesUnder16" class="value">0</div>
                    <div class="label">إناث أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box">
                    <div id="avgChildrenPerParent" class="value">0</div>
                    <div class="label">متوسط الأبناء لكل والد</div>
                </div>
                <div class="stat-box" id="statMembersWithoutChildren">
                    <div id="membersWithoutChildren" class="value">0</div>
                    <div class="label">أفراد بدون أبناء</div>
                </div>
                <div class="stat-box">
                    <div id="profileCompletion" class="value">0%</div>
                    <div class="label">اكتمال الملفات الشخصية</div>
                </div>
                <div class="stat-box" id="statMissingBirthDate">
                    <div id="missingBirthDate" class="value">0</div>
                    <div class="label">أفراد بدون تاريخ ميلاد</div>
                </div>
                <div class="stat-box" id="statMissingGender">
                    <div id="missingGender" class="value">0</div>
                    <div class="label">أفراد بدون جنس</div>
                </div>
                <div class="stat-box" id="statMissingFamilyName">
                    <div id="missingFamilyName" class="value">0</div>
                    <div class="label">أفراد بدون اسم عائلة</div>
                </div>
                <div class="stat-box">
                    <div id="avgMaleMarriageAge" class="value">0</div>
                    <div class="label">متوسط عمر الزواج (ذكور)</div>
                </div>
                <div class="stat-box">
                    <div id="avgFemaleMarriageAge" class="value">0</div>
                    <div class="label">متوسط عمر الزواج (إناث)</div>
                </div>
                <div class="stat-box">
                    <div id="avgMaleEngagementAge" class="value">0</div>
                    <div class="label">متوسط عمر الخطوبة (ذكور)</div>
                </div>
                <div class="stat-box">
                    <div id="avgFemaleEngagementAge" class="value">0</div>
                    <div class="label">متوسط عمر الخطوبة (إناث)</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-end gap-4 mt-6 mb-6">
            <button id="exportCsvBtn" class="btn-primary">تصدير البيانات (CSV)</button>
            <button id="exportChartsBtn" class="btn-primary">تصدير المخططات (PNG)</button>
            <button id="printPageBtn" class="btn-secondary">طباعة الصفحة</button>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الجنس</h2>
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الحالة الاجتماعية (جميع الأفراد)</h2>
                <div class="chart-container">
                    <canvas id="maritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الحالة الاجتماعية (الأفراد الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="maritalStatusAliveChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الأعمار (الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع أعياد الميلاد حسب الشهر</h2>
                <div class="chart-container">
                    <canvas id="birthMonthChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع أسماء العائلات</h2>
                <div class="chart-container">
                    <canvas id="familyNameChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الحالة الاجتماعية للذكور (الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="maleMaritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الحالة الاجتماعية للإناث (الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="femaleMaritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">المواليد حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="birthsPerYearChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الوفيات حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="deathsPerYearChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الزيجات والخطوبات حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="marriagesEngagementsPerYearChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أكثر الأشخاص أبناءً</h2>
                <div id="mostChildrenList" class="p-4">
                    <p class="text-gray-600">جاري التحميل...</p>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أكبر 5 أفراد سناً (الأحياء)</h2>
                <div id="oldestMembersList" class="p-4">
                    <p class="text-gray-600">جاري التحميل...</p>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أصغر 5 أفراد سناً (الأحياء)</h2>
                <div id="youngestMembersList" class="p-4">
                    <p class="text-gray-600">جاري التحميل...</p>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أعلى 5 عائلات فرعية من حيث العدد</h2>
                <div id="topSubFamiliesList" class="p-4">
                    <p class="text-gray-600">جاري التحميل...</p>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أسماء الأبناء الأكثر شيوعاً</h2>
                <div id="mostCommonChildrenNamesList" class="p-4">
                    <p class="text-gray-600">جاري التحميل...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase configuration from the user's prompt
        const firebaseConfig = {
            apiKey: "AIzaSyBOXGJek0FHS1VqXhkgORMq-VrPoN1db3w",
            authDomain: "family-9b0b8.firebaseapp.com",
            databaseURL: "https://family-9b0b8-default-rtdb.firebaseio.com",
            projectId: "family-9b0b8",
            storageBucket: "family-9b0b8.firebasestorage.app",
            messagingSenderId: "409089079475",
            appId: "1:409089079475:web:93f8be81e247ecfe2758c6",
            measurementId: "G-X5LDQB1WC9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Get auth instance, but don't perform sign-in

        let allFamilyMembers = []; // Stores all members fetched from Firestore
        let filteredFamilyMembers = []; // Stores members filtered by the selected family name

        // Chart instances
        let genderChartInstance;
        let maritalStatusChartInstance;
        let maritalStatusAliveChartInstance;
        let ageDistributionChartInstance;
        let birthMonthChartInstance;
        let familyNameChartInstance;
        let maleMaritalStatusChartInstance;
        let femaleMaritalStatusChartInstance;
        let birthsPerYearChartInstance;
        let deathsPerYearChartInstance;
        let marriagesEngagementsPerYearChartInstance;

        // Modal for chart details
        const chartDetailsModal = document.getElementById('chartDetailsModal');
        const chartDetailsTitle = document.getElementById('chartDetailsTitle');
        const chartDetailsList = document.getElementById('chartDetailsList');
        const familyFilterSelect = document.getElementById('familyFilter');

        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeMessageModalBtn = document.getElementById('closeMessageModalBtn');
        const confirmMessageModalBtn = document.getElementById('confirmMessageModalBtn');

        const loadingModal = document.getElementById('loadingModal');

        // Show/Hide Modals
        function showMessageModal(message, isError = false) {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        function hideMessageModal() {
            messageModal.style.display = 'none';
        }

        function showLoadingModal() {
            loadingModal.style.display = 'flex';
        }

        function hideLoadingModal() {
            loadingModal.style.display = 'none';
        }

        // Close message modal
        closeMessageModalBtn.addEventListener('click', hideMessageModal);
        confirmMessageModalBtn.addEventListener('click', hideMessageModal);

        // Utility Functions
        function getAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            const birth = birthDate.toDate(); // Convert Firestore Timestamp to Date
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function getAgeAtDeath(birthDate, deathDate) {
            if (!birthDate || !deathDate) return null;
            const birth = birthDate.toDate();
            const death = deathDate.toDate();
            let age = death.getFullYear() - birth.getFullYear();
            const m = death.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && death.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // Drill-down functionality
        function handleDrillDown(chart, event) {
            const activePoints = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (activePoints.length === 0) return;

            const clickedPoint = activePoints[0];
            const datasetIndex = clickedPoint.datasetIndex;
            const label = chart.data.labels[clickedPoint.index];

            let membersToShow = [];
            const isAliveData = chart.data.datasets[datasetIndex].label === 'الأحياء' || chart.data.datasets[datasetIndex].label === 'ذكور' || chart.data.datasets[datasetIndex].label === 'إناث';

            if (chart.canvas.id === 'maritalStatusChart' || chart.canvas.id === 'maritalStatusAliveChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.maritalStatus === label && (isAliveData ? member.status === 'Alive' : true));
            } else if (chart.canvas.id === 'genderChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.gender === label);
            } else if (chart.canvas.id === 'maleMaritalStatusChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.gender === 'Male' && member.maritalStatus === label && member.status === 'Alive');
            } else if (chart.canvas.id === 'femaleMaritalStatusChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.gender === 'Female' && member.maritalStatus === label && member.status === 'Alive');
            } else if (chart.canvas.id === 'birthMonthChart') {
                membersToShow = filteredFamilyMembers.filter(member => {
                    const month = member.birthDate ? member.birthDate.toDate().getMonth() : null;
                    const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    return monthNames[month] === label;
                });
            } else if (chart.canvas.id === 'familyNameChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.familyName === label);
            } else if (chart.canvas.id === 'birthsPerYearChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.birthDate && member.birthDate.toDate().getFullYear().toString() === label);
            } else if (chart.canvas.id === 'deathsPerYearChart') {
                membersToShow = filteredFamilyMembers.filter(member => member.deathDate && member.deathDate.toDate().getFullYear().toString() === label);
            } else if (chart.canvas.id === 'marriagesEngagementsPerYearChart') {
                membersToShow = filteredFamilyMembers.filter(member => {
                    if (!member.engagementDate && !member.marriageDate) return false;
                    const marriageYear = member.marriageDate ? member.marriageDate.toDate().getFullYear().toString() : null;
                    const engagementYear = member.engagementDate ? member.engagementDate.toDate().getFullYear().toString() : null;
                    return (marriageYear === label || engagementYear === label);
                });
            } else if (chart.canvas.id === 'ageDistributionChart') {
                const ageRange = label.split('-');
                const minAge = parseInt(ageRange[0]);
                const maxAge = parseInt(ageRange[1]);
                membersToShow = filteredFamilyMembers.filter(member => {
                    const age = getAge(member.birthDate);
                    return member.status === 'Alive' && age !== null && age >= minAge && age <= maxAge;
                });
            }

            // Display details in the modal
            chartDetailsTitle.textContent = `الأفراد في فئة: ${label}`;
            chartDetailsList.innerHTML = '';
            if (membersToShow.length > 0) {
                membersToShow.forEach(member => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${member.fullName} (${getAge(member.birthDate)} سنة)`;
                    chartDetailsList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'لا توجد بيانات متاحة.';
                chartDetailsList.appendChild(listItem);
            }
            chartDetailsModal.style.display = 'flex';
        }

        // Close chart details modal
        document.getElementById('closeChartDetailsModalBtn').addEventListener('click', () => {
            chartDetailsModal.style.display = 'none';
        });

        // Event Listeners for Export and Print buttons
        document.getElementById('exportCsvBtn').addEventListener('click', () => exportDataToCsv(filteredFamilyMembers));
        document.getElementById('exportChartsBtn').addEventListener('click', exportAllChartsAsPng);
        document.getElementById('printPageBtn').addEventListener('click', () => window.print());

        // Export data to CSV
        function exportDataToCsv(data) {
            if (data.length === 0) {
                showMessageModal('لا توجد بيانات لتصديرها.');
                return;
            }

            const header = Object.keys(data[0]).join(',');
            const rows = data.map(obj => Object.values(obj).map(value => {
                if (value instanceof Timestamp) {
                    return value.toDate().toISOString();
                }
                if (typeof value === 'object' && value !== null) {
                    return JSON.stringify(value).replace(/"/g, '""');
                }
                return `"${String(value).replace(/"/g, '""')}"`;
            }).join(','));

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [header, ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "family_statistics.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export all charts to a single PNG
        async function exportAllChartsAsPng() {
            const cards = document.querySelectorAll('.card');
            const canvasContainers = Array.from(cards).map(card => card.querySelector('canvas'));
            const images = await Promise.all(canvasContainers.filter(c => c).map(async (canvas) => {
                const title = canvas.closest('.card').querySelector('h2').textContent;
                const img = new Image();
                img.src = canvas.toDataURL('image/png');
                await new Promise(resolve => img.onload = resolve);
                return { title, img };
            }));

            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            let totalHeight = 0;
            let maxWidth = 0;

            images.forEach(item => {
                totalHeight += item.img.height + 60; // Add space for title and margin
                maxWidth = Math.max(maxWidth, item.img.width);
            });

            combinedCanvas.width = maxWidth;
            combinedCanvas.height = totalHeight;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);

            let currentY = 0;
            ctx.font = '24px "Inter"';
            ctx.fillStyle = '#1f2937';
            ctx.textAlign = 'right';

            images.forEach(item => {
                ctx.fillText(item.title, combinedCanvas.width - 20, currentY + 40);
                ctx.drawImage(item.img, 0, currentY + 60);
                currentY += item.img.height + 60;
            });

            const link = document.createElement('a');
            link.download = 'family_charts.png';
            link.href = combinedCanvas.toDataURL('image/png');
            link.click();
        }

        // Filter and update statistics
        function updateStatsAndCharts(members) {
            if (members.length === 0) {
                document.getElementById('statisticsContent').innerHTML = '<p class="text-gray-600">لا توجد بيانات لعرضها.</p>';
                if (genderChartInstance) genderChartInstance.destroy();
                // Destroy all other charts similarly
                return;
            }

            // General Stats
            const totalMembers = members.length;
            document.getElementById('totalMembers').textContent = totalMembers;

            const aliveMembers = members.filter(m => m.status === 'Alive');
            document.getElementById('aliveMembers').textContent = aliveMembers.length;

            const deceasedMembers = members.filter(m => m.status === 'Deceased');
            document.getElementById('deceasedMembers').textContent = deceasedMembers.length;

            const uniqueFamilyNames = new Set(members.map(m => m.familyName)).size;
            document.getElementById('uniqueFamilyNames').textContent = uniqueFamilyNames;

            const livingMales = aliveMembers.filter(m => m.gender === 'Male').length;
            document.getElementById('livingMales').textContent = livingMales;

            const livingFemales = aliveMembers.filter(m => m.gender === 'Female').length;
            document.getElementById('livingFemales').textContent = livingFemales;

            const livingMarried = aliveMembers.filter(m => m.maritalStatus === 'Married').length;
            document.getElementById('livingMarried').textContent = livingMarried;

            const livingEngaged = aliveMembers.filter(m => m.maritalStatus === 'Engaged').length;
            document.getElementById('livingEngaged').textContent = livingEngaged;

            const livingMarriedMales = aliveMembers.filter(m => m.gender === 'Male' && m.maritalStatus === 'Married').length;
            document.getElementById('livingMarriedMales').textContent = livingMarriedMales;
            
            const livingMarriedFemales = aliveMembers.filter(m => m.gender === 'Female' && m.maritalStatus === 'Married').length;
            document.getElementById('livingMarriedFemales').textContent = livingMarriedFemales;

            const livingSingleMales = aliveMembers.filter(m => m.gender === 'Male' && m.maritalStatus === 'Single').length;
            document.getElementById('livingSingleMales').textContent = livingSingleMales;

            const livingDivorcedMales = aliveMembers.filter(m => m.gender === 'Male' && m.maritalStatus === 'Divorced').length;
            document.getElementById('livingDivorcedMales').textContent = livingDivorcedMales;

            const livingWidowedMales = aliveMembers.filter(m => m.gender === 'Male' && m.maritalStatus === 'Widowed').length;
            document.getElementById('livingWidowedMales').textContent = livingWidowedMales;

            const livingSingleFemales = aliveMembers.filter(m => m.gender === 'Female' && m.maritalStatus === 'Single').length;
            document.getElementById('livingSingleFemales').textContent = livingSingleFemales;

            const livingDivorcedFemales = aliveMembers.filter(m => m.gender === 'Female' && m.maritalStatus === 'Divorced').length;
            document.getElementById('livingDivorcedFemales').textContent = livingDivorcedFemales;

            const livingWidowedFemales = aliveMembers.filter(m => m.gender === 'Female' && m.maritalStatus === 'Widowed').length;
            document.getElementById('livingWidowedFemales').textContent = livingWidowedFemales;

            const malesOver16 = aliveMembers.filter(m => m.gender === 'Male' && getAge(m.birthDate) >= 16).length;
            document.getElementById('malesOver16').textContent = malesOver16;

            const femalesOver16 = aliveMembers.filter(m => m.gender === 'Female' && getAge(m.birthDate) >= 16).length;
            document.getElementById('femalesOver16').textContent = femalesOver16;

            const malesUnder16 = aliveMembers.filter(m => m.gender === 'Male' && getAge(m.birthDate) < 16).length;
            document.getElementById('malesUnder16').textContent = malesUnder16;

            const femalesUnder16 = aliveMembers.filter(m => m.gender === 'Female' && getAge(m.birthDate) < 16).length;
            document.getElementById('femalesUnder16').textContent = femalesUnder16;

            const membersWithChildren = members.filter(m => m.children && m.children.length > 0);
            const totalChildrenCount = membersWithChildren.reduce((sum, member) => sum + member.children.length, 0);
            const avgChildrenPerParent = membersWithChildren.length > 0 ? (totalChildrenCount / membersWithChildren.length).toFixed(2) : 0;
            document.getElementById('avgChildrenPerParent').textContent = avgChildrenPerParent;

            const membersWithoutChildren = members.filter(m => !m.children || m.children.length === 0).length;
            document.getElementById('membersWithoutChildren').textContent = membersWithoutChildren;

            const totalProfiles = members.length;
            const completedProfiles = members.filter(m => m.fullName && m.gender && m.birthDate && m.familyName).length;
            const profileCompletion = totalProfiles > 0 ? ((completedProfiles / totalProfiles) * 100).toFixed(2) : 0;
            document.getElementById('profileCompletion').textContent = `${profileCompletion}%`;
            
            const missingBirthDate = members.filter(m => !m.birthDate).length;
            document.getElementById('missingBirthDate').textContent = missingBirthDate;

            const missingGender = members.filter(m => !m.gender).length;
            document.getElementById('missingGender').textContent = missingGender;

            const missingFamilyName = members.filter(m => !m.familyName).length;
            document.getElementById('missingFamilyName').textContent = missingFamilyName;

            const maleMarriages = members.filter(m => m.gender === 'Male' && m.maritalStatus === 'Married' && m.marriageDate);
            const totalMaleMarriageAge = maleMarriages.reduce((sum, m) => sum + getAgeAtMarriage(m.marriageDate, m.birthDate), 0);
            const avgMaleMarriageAge = maleMarriages.length > 0 ? (totalMaleMarriageAge / maleMarriages.length).toFixed(2) : 0;
            document.getElementById('avgMaleMarriageAge').textContent = avgMaleMarriageAge;

            const femaleMarriages = members.filter(m => m.gender === 'Female' && m.maritalStatus === 'Married' && m.marriageDate);
            const totalFemaleMarriageAge = femaleMarriages.reduce((sum, m) => sum + getAgeAtMarriage(m.marriageDate, m.birthDate), 0);
            const avgFemaleMarriageAge = femaleMarriages.length > 0 ? (totalFemaleMarriageAge / femaleMarriages.length).toFixed(2) : 0;
            document.getElementById('avgFemaleMarriageAge').textContent = avgFemaleMarriageAge;
            
            function getAgeAtMarriage(marriageDate, birthDate) {
                if (!marriageDate || !birthDate) return 0;
                const birth = birthDate.toDate();
                const marriage = marriageDate.toDate();
                let age = marriage.getFullYear() - birth.getFullYear();
                const m = marriage.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && marriage.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }

            const maleEngagements = members.filter(m => m.gender === 'Male' && m.maritalStatus === 'Engaged' && m.engagementDate);
            const totalMaleEngagementAge = maleEngagements.reduce((sum, m) => sum + getAgeAtEngagement(m.engagementDate, m.birthDate), 0);
            const avgMaleEngagementAge = maleEngagements.length > 0 ? (totalMaleEngagementAge / maleEngagements.length).toFixed(2) : 0;
            document.getElementById('avgMaleEngagementAge').textContent = avgMaleEngagementAge;

            const femaleEngagements = members.filter(m => m.gender === 'Female' && m.maritalStatus === 'Engaged' && m.engagementDate);
            const totalFemaleEngagementAge = femaleEngagements.reduce((sum, m) => sum + getAgeAtEngagement(m.engagementDate, m.birthDate), 0);
            const avgFemaleEngagementAge = femaleEngagements.length > 0 ? (totalFemaleEngagementAge / femaleEngagements.length).toFixed(2) : 0;
            document.getElementById('avgFemaleEngagementAge').textContent = avgFemaleEngagementAge;

            function getAgeAtEngagement(engagementDate, birthDate) {
                if (!engagementDate || !birthDate) return 0;
                const birth = birthDate.toDate();
                const engagement = engagementDate.toDate();
                let age = engagement.getFullYear() - birth.getFullYear();
                const m = engagement.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && engagement.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }


            const ages = aliveMembers.filter(m => m.birthDate).map(m => getAge(m.birthDate));
            const averageAge = ages.length > 0 ? (ages.reduce((sum, age) => sum + age, 0) / ages.length).toFixed(2) : 0;
            document.getElementById('averageAge').textContent = averageAge;

            const agesAtDeath = deceasedMembers.filter(m => m.birthDate && m.deathDate).map(m => getAgeAtDeath(m.birthDate, m.deathDate));
            const averageAgeAtDeath = agesAtDeath.length > 0 ? (agesAtDeath.reduce((sum, age) => sum + age, 0) / agesAtDeath.length).toFixed(2) : 0;
            document.getElementById('averageAgeAtDeath').textContent = averageAgeAtDeath;

            // List Stats
            const mostChildrenList = document.getElementById('mostChildrenList');
            const membersWithChildrenCount = members.map(m => ({
                ...m,
                childrenCount: m.children ? m.children.length : 0
            })).sort((a, b) => b.childrenCount - a.childrenCount).slice(0, 5);
            mostChildrenList.innerHTML = membersWithChildrenCount.length > 0 ?
                membersWithChildrenCount.map(m => `<p>${m.fullName}: ${m.childrenCount} أبناء</p>`).join('') :
                '<p class="text-gray-600">لا توجد بيانات.</p>';

            const oldestMembersList = document.getElementById('oldestMembersList');
            const oldestMembers = aliveMembers.filter(m => m.birthDate).sort((a, b) => a.birthDate.toDate().getTime() - b.birthDate.toDate().getTime()).slice(0, 5);
            oldestMembersList.innerHTML = oldestMembers.length > 0 ?
                oldestMembers.map(m => `<p>${m.fullName} (${getAge(m.birthDate)} سنة)</p>`).join('') :
                '<p class="text-gray-600">لا توجد بيانات.</p>';

            const youngestMembersList = document.getElementById('youngestMembersList');
            const youngestMembers = aliveMembers.filter(m => m.birthDate).sort((a, b) => b.birthDate.toDate().getTime() - a.birthDate.toDate().getTime()).slice(0, 5);
            youngestMembersList.innerHTML = youngestMembers.length > 0 ?
                youngestMembers.map(m => `<p>${m.fullName} (${getAge(m.birthDate)} سنة)</p>`).join('') :
                '<p class="text-gray-600">لا توجد بيانات.</p>';

            const topSubFamiliesList = document.getElementById('topSubFamiliesList');
            const familyCounts = members.reduce((acc, member) => {
                if (member.familyName) {
                    acc[member.familyName] = (acc[member.familyName] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedFamilies = Object.entries(familyCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
            topSubFamiliesList.innerHTML = sortedFamilies.length > 0 ?
                sortedFamilies.map(([name, count]) => `<p>${name}: ${count} أفراد</p>`).join('') :
                '<p class="text-gray-600">لا توجد بيانات.</p>';

            const mostCommonChildrenNamesList = document.getElementById('mostCommonChildrenNamesList');
            const childrenNames = members.reduce((acc, member) => {
                if (member.children) {
                    member.children.forEach(childId => {
                        const child = members.find(m => m.id === childId);
                        if (child && child.firstName) {
                            acc[child.firstName] = (acc[child.firstName] || 0) + 1;
                        }
                    });
                }
                return acc;
            }, {});
            const sortedChildrenNames = Object.entries(childrenNames).sort(([, a], [, b]) => b - a).slice(0, 5);
            mostCommonChildrenNamesList.innerHTML = sortedChildrenNames.length > 0 ?
                sortedChildrenNames.map(([name, count]) => `<p>${name}: ${count} مرات</p>`).join('') :
                '<p class="text-gray-600">لا توجد بيانات.</p>';

            // Charts
            const colors = {
                'Male': '#3b82f6', // Blue
                'Female': '#f472b6', // Pink
                'Married': '#22c55e', // Green
                'Engaged': '#f97316', // Orange
                'Single': '#6b7280', // Gray
                'Divorced': '#ef4444', // Red
                'Widowed': '#9ca3af', // Dark Gray
                'Alive': '#22c55e',
                'Deceased': '#ef4444'
            };

            // Gender Chart
            if (genderChartInstance) genderChartInstance.destroy();
            const genderData = members.reduce((acc, member) => {
                if (member.gender) {
                    acc[member.gender] = (acc[member.gender] || 0) + 1;
                }
                return acc;
            }, {});
            const genderChartCtx = document.getElementById('genderChart').getContext('2d');
            genderChartInstance = new Chart(genderChartCtx, {
                type: 'pie',
                data: {
                    labels: ['ذكور', 'إناث'],
                    datasets: [{
                        label: 'توزيع الجنس',
                        data: [genderData['Male'] || 0, genderData['Female'] || 0],
                        backgroundColor: [colors['Male'], colors['Female']],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                }
                            }
                        }
                    }
                }
            });

            // Marital Status Chart (All)
            if (maritalStatusChartInstance) maritalStatusChartInstance.destroy();
            const maritalStatusData = members.reduce((acc, member) => {
                if (member.maritalStatus) {
                    acc[member.maritalStatus] = (acc[member.maritalStatus] || 0) + 1;
                }
                return acc;
            }, {});
            const maritalStatusChartCtx = document.getElementById('maritalStatusChart').getContext('2d');
            maritalStatusChartInstance = new Chart(maritalStatusChartCtx, {
                type: 'bar',
                data: {
                    labels: ['متزوج', 'أعزب', 'مطلق', 'أرمل', 'مخطوب'],
                    datasets: [{
                        label: 'الحالة الاجتماعية',
                        data: [
                            maritalStatusData['Married'] || 0,
                            maritalStatusData['Single'] || 0,
                            maritalStatusData['Divorced'] || 0,
                            maritalStatusData['Widowed'] || 0,
                            maritalStatusData['Engaged'] || 0
                        ],
                        backgroundColor: [
                            colors['Married'],
                            colors['Single'],
                            colors['Divorced'],
                            colors['Widowed'],
                            colors['Engaged']
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Marital Status Chart (Alive)
            if (maritalStatusAliveChartInstance) maritalStatusAliveChartInstance.destroy();
            const maritalStatusAliveData = aliveMembers.reduce((acc, member) => {
                if (member.maritalStatus) {
                    acc[member.maritalStatus] = (acc[member.maritalStatus] || 0) + 1;
                }
                return acc;
            }, {});
            const maritalStatusAliveChartCtx = document.getElementById('maritalStatusAliveChart').getContext('2d');
            maritalStatusAliveChartInstance = new Chart(maritalStatusAliveChartCtx, {
                type: 'bar',
                data: {
                    labels: ['متزوج', 'أعزب', 'مطلق', 'أرمل', 'مخطوب'],
                    datasets: [{
                        label: 'الحالة الاجتماعية للأحياء',
                        data: [
                            maritalStatusAliveData['Married'] || 0,
                            maritalStatusAliveData['Single'] || 0,
                            maritalStatusAliveData['Divorced'] || 0,
                            maritalStatusAliveData['Widowed'] || 0,
                            maritalStatusAliveData['Engaged'] || 0
                        ],
                        backgroundColor: [
                            colors['Married'],
                            colors['Single'],
                            colors['Divorced'],
                            colors['Widowed'],
                            colors['Engaged']
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Age Distribution Chart
            if (ageDistributionChartInstance) ageDistributionChartInstance.destroy();
            const ageDistributionData = {
                '0-10': 0, '11-20': 0, '21-30': 0, '31-40': 0, '41-50': 0,
                '51-60': 0, '61-70': 0, '71-80': 0, '81-90': 0, '91+': 0
            };
            aliveMembers.forEach(member => {
                const age = getAge(member.birthDate);
                if (age !== null) {
                    if (age <= 10) ageDistributionData['0-10']++;
                    else if (age <= 20) ageDistributionData['11-20']++;
                    else if (age <= 30) ageDistributionData['21-30']++;
                    else if (age <= 40) ageDistributionData['31-40']++;
                    else if (age <= 50) ageDistributionData['41-50']++;
                    else if (age <= 60) ageDistributionData['51-60']++;
                    else if (age <= 70) ageDistributionData['61-70']++;
                    else if (age <= 80) ageDistributionData['71-80']++;
                    else if (age <= 90) ageDistributionData['81-90']++;
                    else ageDistributionData['91+']++;
                }
            });
            const ageDistributionChartCtx = document.getElementById('ageDistributionChart').getContext('2d');
            ageDistributionChartInstance = new Chart(ageDistributionChartCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageDistributionData),
                    datasets: [{
                        label: 'توزيع الأعمار',
                        data: Object.values(ageDistributionData),
                        backgroundColor: '#059669', // Emerald
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Birth Month Chart
            if (birthMonthChartInstance) birthMonthChartInstance.destroy();
            const birthMonthData = new Array(12).fill(0);
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            members.forEach(member => {
                if (member.birthDate) {
                    const month = member.birthDate.toDate().getMonth();
                    birthMonthData[month]++;
                }
            });
            const birthMonthChartCtx = document.getElementById('birthMonthChart').getContext('2d');
            birthMonthChartInstance = new Chart(birthMonthChartCtx, {
                type: 'polarArea',
                data: {
                    labels: monthNames,
                    datasets: [{
                        data: birthMonthData,
                        backgroundColor: [
                            '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#be185d', '#d946ef', '#14b8a6', '#06b6d4', '#475569'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });

            // Family Name Chart
            if (familyNameChartInstance) familyNameChartInstance.destroy();
            const familyNameData = members.reduce((acc, member) => {
                if (member.familyName) {
                    acc[member.familyName] = (acc[member.familyName] || 0) + 1;
                }
                return acc;
            }, {});
            const familyNameChartCtx = document.getElementById('familyNameChart').getContext('2d');
            familyNameChartInstance = new Chart(familyNameChartCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(familyNameData),
                    datasets: [{
                        data: Object.values(familyNameData),
                        backgroundColor: [
                            '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#be185d', '#d946ef', '#14b8a6', '#06b6d4', '#475569'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });

            // Male Marital Status Chart
            if (maleMaritalStatusChartInstance) maleMaritalStatusChartInstance.destroy();
            const maleMaritalStatusData = aliveMembers.filter(m => m.gender === 'Male').reduce((acc, member) => {
                if (member.maritalStatus) {
                    acc[member.maritalStatus] = (acc[member.maritalStatus] || 0) + 1;
                }
                return acc;
            }, {});
            const maleMaritalStatusChartCtx = document.getElementById('maleMaritalStatusChart').getContext('2d');
            maleMaritalStatusChartInstance = new Chart(maleMaritalStatusChartCtx, {
                type: 'bar',
                data: {
                    labels: ['متزوج', 'أعزب', 'مطلق', 'أرمل'],
                    datasets: [{
                        label: 'الحالة الاجتماعية للذكور',
                        data: [
                            maleMaritalStatusData['Married'] || 0,
                            maleMaritalStatusData['Single'] || 0,
                            maleMaritalStatusData['Divorced'] || 0,
                            maleMaritalStatusData['Widowed'] || 0
                        ],
                        backgroundColor: [
                            colors['Married'],
                            colors['Single'],
                            colors['Divorced'],
                            colors['Widowed']
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Female Marital Status Chart
            if (femaleMaritalStatusChartInstance) femaleMaritalStatusChartInstance.destroy();
            const femaleMaritalStatusData = aliveMembers.filter(m => m.gender === 'Female').reduce((acc, member) => {
                if (member.maritalStatus) {
                    acc[member.maritalStatus] = (acc[member.maritalStatus] || 0) + 1;
                }
                return acc;
            }, {});
            const femaleMaritalStatusChartCtx = document.getElementById('femaleMaritalStatusChart').getContext('2d');
            femaleMaritalStatusChartInstance = new Chart(femaleMaritalStatusChartCtx, {
                type: 'bar',
                data: {
                    labels: ['متزوجة', 'عزباء', 'مطلقة', 'أرملة'],
                    datasets: [{
                        label: 'الحالة الاجتماعية للإناث',
                        data: [
                            femaleMaritalStatusData['Married'] || 0,
                            femaleMaritalStatusData['Single'] || 0,
                            femaleMaritalStatusData['Divorced'] || 0,
                            femaleMaritalStatusData['Widowed'] || 0
                        ],
                        backgroundColor: [
                            colors['Married'],
                            colors['Single'],
                            colors['Divorced'],
                            colors['Widowed']
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Births Per Year Chart
            if (birthsPerYearChartInstance) birthsPerYearChartInstance.destroy();
            const birthsPerYearData = members.filter(m => m.birthDate).reduce((acc, member) => {
                const year = member.birthDate.toDate().getFullYear();
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            const sortedBirthYears = Object.keys(birthsPerYearData).sort();
            const birthsPerYearChartCtx = document.getElementById('birthsPerYearChart').getContext('2d');
            birthsPerYearChartInstance = new Chart(birthsPerYearChartCtx, {
                type: 'line',
                data: {
                    labels: sortedBirthYears,
                    datasets: [{
                        label: 'المواليد',
                        data: sortedBirthYears.map(year => birthsPerYearData[year]),
                        backgroundColor: '#3b82f6',
                        borderColor: '#3b82f6',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Deaths Per Year Chart
            if (deathsPerYearChartInstance) deathsPerYearChartInstance.destroy();
            const deathsPerYearData = members.filter(m => m.deathDate).reduce((acc, member) => {
                const year = member.deathDate.toDate().getFullYear();
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            const sortedDeathYears = Object.keys(deathsPerYearData).sort();
            const deathsPerYearChartCtx = document.getElementById('deathsPerYearChart').getContext('2d');
            deathsPerYearChartInstance = new Chart(deathsPerYearChartCtx, {
                type: 'line',
                data: {
                    labels: sortedDeathYears,
                    datasets: [{
                        label: 'الوفيات',
                        data: sortedDeathYears.map(year => deathsPerYearData[year]),
                        backgroundColor: '#ef4444',
                        borderColor: '#ef4444',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Marriages & Engagements Per Year Chart
            if (marriagesEngagementsPerYearChartInstance) marriagesEngagementsPerYearChartInstance.destroy();
            const marriageData = members.filter(m => m.marriageDate).reduce((acc, member) => {
                const year = member.marriageDate.toDate().getFullYear();
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            const engagementData = members.filter(m => m.engagementDate).reduce((acc, member) => {
                const year = member.engagementDate.toDate().getFullYear();
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            const allYears = new Set([...Object.keys(marriageData), ...Object.keys(engagementData)]);
            const sortedYears = Array.from(allYears).sort();
            const marriagesEngagementsPerYearChartCtx = document.getElementById('marriagesEngagementsPerYearChart').getContext('2d');
            marriagesEngagementsPerYearChartInstance = new Chart(marriagesEngagementsPerYearChartCtx, {
                type: 'line',
                data: {
                    labels: sortedYears,
                    datasets: [
                        {
                            label: 'الزيجات',
                            data: sortedYears.map(year => marriageData[year] || 0),
                            backgroundColor: '#22c55e',
                            borderColor: '#22c55e',
                            tension: 0.1,
                            fill: false,
                        },
                        {
                            label: 'الخطوبات',
                            data: sortedYears.map(year => engagementData[year] || 0),
                            backgroundColor: '#f97316',
                            borderColor: '#f97316',
                            tension: 0.1,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements, chart) => handleDrillDown(chart, e),
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Main function to fetch data and render stats
        async function fetchDataAndRender() {
            showLoadingModal();
            try {
                // Get all documents from the "people" collection
                const peopleCollection = collection(db, 'people');
                const querySnapshot = await getDocs(peopleCollection);
                allFamilyMembers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Populate the family filter dropdown
                const familyNames = ['الكل', ...new Set(allFamilyMembers.map(m => m.familyName))].filter(Boolean);
                familyFilterSelect.innerHTML = familyNames.map(name => `<option value="${name}">${name}</option>`).join('');

                // Initially, show all members
                filteredFamilyMembers = allFamilyMembers;
                updateStatsAndCharts(filteredFamilyMembers);
            } catch (error) {
                console.error("Error fetching data:", error);
                showMessageModal('حدث خطأ أثناء تحميل البيانات: ' + error.message, true);
            } finally {
                hideLoadingModal();
            }
        }
        
        // Add event listener for the family filter
        familyFilterSelect.addEventListener('change', (e) => {
            const selectedFamily = e.target.value;
            if (selectedFamily === 'الكل') {
                filteredFamilyMembers = allFamilyMembers;
            } else {
                filteredFamilyMembers = allFamilyMembers.filter(m => m.familyName === selectedFamily);
            }
            updateStatsAndCharts(filteredFamilyMembers);
        });

        // Initialize on page load
        window.onload = fetchDataAndRender;
    </script>
</body>
</html>
