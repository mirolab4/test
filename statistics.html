<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إحصائيات العائلة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        /* Custom styles for modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            width: 90%;
            max-width: 400px;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container">
        <header class="text-center py-6">
            <h1 class="text-3xl font-bold text-gray-800">لوحة إحصائيات العائلة</h1>
        </header>

        <!-- Family Filter and Controls -->
        <div class="mb-6 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
            <div class="w-full sm:w-1/3">
                <label for="familyFilter" class="block text-gray-700 font-medium mb-2">تصفية حسب العائلة:</label>
                <select id="familyFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="الكل">الكل</option>
                </select>
            </div>
            <!-- This section is for displaying the userId, which is mandatory for multi-user apps -->
            <div class="w-full sm:w-2/3 text-right">
                <p id="userIdDisplay" class="text-sm text-gray-500"></p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div id="totalMembersCard" class="card text-center bg-blue-500 text-white shadow-lg">
                <i class="fa-solid fa-users text-4xl mb-2"></i>
                <h3 class="text-lg font-semibold">إجمالي الأفراد</h3>
                <p id="totalMembersCount" class="text-4xl font-bold">0</p>
            </div>
            <div id="malesCard" class="card text-center bg-sky-500 text-white shadow-lg">
                <i class="fa-solid fa-person text-4xl mb-2"></i>
                <h3 class="text-lg font-semibold">الذكور</h3>
                <p id="malesCount" class="text-4xl font-bold">0</p>
            </div>
            <div id="femalesCard" class="card text-center bg-pink-500 text-white shadow-lg">
                <i class="fa-solid fa-person-dress text-4xl mb-2"></i>
                <h3 class="text-lg font-semibold">الإناث</h3>
                <p id="femalesCount" class="text-4xl font-bold">0</p>
            </div>
            <div id="avgAgeCard" class="card text-center bg-emerald-500 text-white shadow-lg">
                <i class="fa-solid fa-user-clock text-4xl mb-2"></i>
                <h3 class="text-lg font-semibold">متوسط العمر</h3>
                <p id="avgAge" class="text-4xl font-bold">0</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Gender Distribution Chart -->
            <div class="card">
                <h3 class="text-xl font-bold text-gray-800 mb-4">توزيع الأفراد حسب الجنس</h3>
                <canvas id="genderChart"></canvas>
            </div>
            <!-- Age Distribution Chart -->
            <div class="card">
                <h3 class="text-xl font-bold text-gray-800 mb-4">توزيع الأعمار</h3>
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p>جاري تحميل البيانات...</p>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="messageText" class="text-gray-700"></p>
            <button id="closeModalBtn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">إغلاق</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration, populated by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI elements
        const familyFilterSelect = document.getElementById('familyFilter');
        const totalMembersCount = document.getElementById('totalMembersCount');
        const malesCount = document.getElementById('malesCount');
        const femalesCount = document.getElementById('femalesCount');
        const avgAge = document.getElementById('avgAge');
        const loadingModal = document.getElementById('loadingModal');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Chart instances
        let genderChartInstance = null;
        let ageChartInstance = null;
        
        // Data
        let allFamilyMembers = [];
        let filteredFamilyMembers = [];

        // Helper functions for modals
        function showLoadingModal() {
            loadingModal.style.display = 'flex';
        }

        function hideLoadingModal() {
            loadingModal.style.display = 'none';
        }

        function showMessageModal(message, isError = false) {
            messageText.textContent = message;
            if (isError) {
                messageText.classList.add('text-red-500');
            } else {
                messageText.classList.remove('text-red-500');
            }
            messageModal.style.display = 'flex';
        }

        closeModalBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        /**
         * Updates the statistics cards and charts with the given family members data.
         * @param {Array} members - The array of family member objects.
         */
        function updateStatsAndCharts(members) {
            // Destruction of old charts to avoid rendering conflicts
            if (genderChartInstance) {
                genderChartInstance.destroy();
            }
            if (ageChartInstance) {
                ageChartInstance.destroy();
            }

            // 1. Calculate General Statistics
            const total = members.length;
            const males = members.filter(m => m.gender === 'ذكر').length;
            const females = members.filter(m => m.gender === 'أنثى').length;
            const totalAge = members.reduce((sum, member) => sum + (member.age || 0), 0);
            const averageAge = total > 0 ? (totalAge / total).toFixed(1) : 0;

            // 2. Update the UI cards
            totalMembersCount.textContent = total;
            malesCount.textContent = males;
            femalesCount.textContent = females;
            avgAge.textContent = averageAge;

            // 3. Create Gender Distribution Chart
            const genderChartCtx = document.getElementById('genderChart').getContext('2d');
            genderChartInstance = new Chart(genderChartCtx, {
                type: 'bar',
                data: {
                    labels: ['الذكور', 'الإناث'],
                    datasets: [{
                        label: 'توزيع الأفراد حسب الجنس',
                        data: [males, females],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)', // blue
                            'rgba(236, 72, 153, 0.6)'  // pink
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(236, 72, 153, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // 4. Create Age Distribution Chart
            const ageBrackets = {
                '0-18': 0,
                '19-35': 0,
                '36-60': 0,
                '60+': 0
            };

            members.forEach(m => {
                const age = m.age;
                if (age >= 0 && age <= 18) {
                    ageBrackets['0-18']++;
                } else if (age >= 19 && age <= 35) {
                    ageBrackets['19-35']++;
                } else if (age >= 36 && age <= 60) {
                    ageBrackets['36-60']++;
                } else if (age > 60) {
                    ageBrackets['60+']++;
                }
            });

            const ageChartCtx = document.getElementById('ageChart').getContext('2d');
            ageChartInstance = new Chart(ageChartCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ageBrackets),
                    datasets: [{
                        label: 'توزيع الأعمار',
                        data: Object.values(ageBrackets),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                    }
                }
            });
        }

        /**
         * Fetches data from Firestore, populates the family filter, and renders initial stats.
         */
        async function fetchDataAndRender() {
            showLoadingModal();
            try {
                // Sign in with the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                userIdDisplay.textContent = `معرّف المستخدم (للمشاركة): ${userId}`;

                // Corrected collection path for public data
                const familyCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'people');
                const querySnapshot = await getDocs(familyCollectionRef);
                allFamilyMembers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Populate the family filter dropdown
                const familyNames = ['الكل', ...new Set(allFamilyMembers.map(m => m.familyName))].filter(Boolean);
                familyFilterSelect.innerHTML = familyNames.map(name => `<option value="${name}">${name}</option>`).join('');

                // Initially, show all members
                filteredFamilyMembers = allFamilyMembers;
                updateStatsAndCharts(filteredFamilyMembers);
            } catch (error) {
                console.error("Error fetching data:", error);
                showMessageModal('حدث خطأ أثناء تحميل البيانات: ' + error.message, true);
            } finally {
                hideLoadingModal();
            }
        }
        
        // Add event listener for the family filter
        familyFilterSelect.addEventListener('change', (e) => {
            const selectedFamily = e.target.value;
            if (selectedFamily === 'الكل') {
                filteredFamilyMembers = allFamilyMembers;
            } else {
                filteredFamilyMembers = allFamilyMembers.filter(m => m.familyName === selectedFamily);
            }
            updateStatsAndCharts(filteredFamilyMembers);
        });

        // Initialize on page load
        window.onload = fetchDataAndRender;
    </script>
</body>
</html>
