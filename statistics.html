<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إحصائيات العائلة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- JSZip for exporting data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- html2canvas for exporting charts as images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .stat-box {
            background-color: #e0f2fe;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .stat-box .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2563eb;
        }
        .stat-box .label {
            font-size: 1rem;
            color: #374151;
            margin-top: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        #chartDetailsModal .modal-content {
            max-width: 600px;
            text-align: right;
        }
        #chartDetailsList li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        #chartDetailsList li:last-child {
            border-bottom: none;
        }
        .person-link {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 500;
        }
        .person-link:hover {
            text-decoration: underline;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .filter-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .filter-group select {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: white;
            cursor: pointer;
        }
        @media print {
            body { background-color: #fff; margin: 0; padding: 0; }
            .container { max-width: none; margin: 0; padding: 0; }
            .btn-primary, .btn-secondary, nav, .flex.flex-wrap.justify-end.gap-4.mt-6.mb-6, .filter-group, #export-buttons, .back-button { display: none; }
            .card { box-shadow: none; border: 1px solid #eee; margin-bottom: 1rem; page-break-inside: avoid; }
            .chart-container { height: auto; width: 100%; }
            canvas { max-width: 100%; height: auto !important; }
        }
        .back-button {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span id="closeMessageModalBtn" class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="confirmMessageModalBtn" class="btn-primary">حسناً</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal flex">
        <div class="modal-content">
            <div class="spinner border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 mb-4 mx-auto animate-spin"></div>
            <p class="text-lg font-semibold text-gray-800">جارٍ تحميل الإحصائيات...</p>
        </div>
    </div>

    <!-- Modal for Chart Details (Drill-down) -->
    <div id="chartDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeChartDetailsModalBtn" class="close-button">&times;</span>
            <h3 id="chartDetailsTitle" class="text-2xl font-semibold text-gray-700 mb-4">تفاصيل الفئة</h3>
            <ul id="chartDetailsList" class="list-disc pr-6 text-gray-700">
                <!-- Details will be loaded here -->
            </ul>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
            <a href="family.html" class="back-button mb-4 md:mb-0"><i class="fas fa-arrow-right ml-2"></i>العودة إلى شجرة العائلة</a>
            <h1 class="text-3xl font-bold text-gray-800">لوحة إحصائيات العائلة</h1>
        </div>

        <!-- General Statistics -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">إحصائيات عامة</h2>
            <div class="filter-group">
                <label for="familyFilter">تحديد العائلة:</label>
                <select id="familyFilter" class="input-field w-auto">
                    <option value="All">الكل</option>
                    <!-- Family names will be populated here by JavaScript -->
                </select>
            </div>
            <div id="statisticsContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <div class="stat-box" id="statTotalMembers">
                    <div id="totalMembers" class="value">0</div>
                    <div class="label">إجمالي أفراد العائلة</div>
                </div>
                <div class="stat-box" id="statAliveMembers">
                    <div id="aliveMembers" class="value">0</div>
                    <div class="label">أفراد على قيد الحياة</div>
                </div>
                <div class="stat-box" id="statDeceasedMembers">
                    <div id="deceasedMembers" class="value">0</div>
                    <div class="label">أفراد متوفون</div>
                </div>
                <div class="stat-box">
                    <div id="averageAge" class="value">0</div>
                    <div class="label">متوسط العمر (الأحياء)</div>
                </div>
                <div class="stat-box">
                    <div id="averageAgeAtDeath" class="value">0</div>
                    <div class="label">متوسط العمر عند الوفاة</div>
                </div>
                <div class="stat-box" id="statUniqueFamilyNames">
                    <div id="uniqueFamilyNames" class="value">0</div>
                    <div class="label">عدد أسماء العائلات الفريدة</div>
                </div>
                <div class="stat-box" id="statLivingMales">
                    <div id="livingMales" class="value">0</div>
                    <div class="label">ذكور أحياء</div>
                </div>
                <div class="stat-box" id="statLivingFemales">
                    <div id="livingFemales" class="value">0</div>
                    <div class="label">إناث أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarried">
                    <div id="livingMarried" class="value">0</div>
                    <div class="label">متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingEngaged">
                    <div id="livingEngaged" class="value">0</div>
                    <div class="label">مخطوبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedMales">
                    <div id="livingMarriedMales" class="value">0</div>
                    <div class="label">ذكور متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedFemales">
                    <div id="livingMarriedFemales" class="value">0</div>
                    <div class="label">إناث متزوجات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleMales">
                    <div id="livingSingleMales" class="value">0</div>
                    <div class="label">ذكور عازبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedMales">
                    <div id="livingDivorcedMales" class="value">0</div>
                    <div class="label">ذكور مطلقون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedMales">
                    <div id="livingWidowedMales" class="value">0</div>
                    <div class="label">ذكور أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleFemales">
                    <div id="livingSingleFemales" class="value">0</div>
                    <div class="label">إناث عازبات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedFemales">
                    <div id="livingDivorcedFemales" class="value">0</div>
                    <div class="label">إناث مطلقات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedFemales">
                    <div id="livingWidowedFemales" class="value">0</div>
                    <div class="label">إناث أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statMalesOver16">
                    <div id="malesOver16" class="value">0</div>
                    <div class="label">ذكور فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesOver16">
                    <div id="femalesOver16" class="value">0</div>
                    <div class="label">إناث فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statMalesUnder16">
                    <div id="malesUnder16" class="value">0</div>
                    <div class="label">ذكور أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesUnder16">
                    <div id="femalesUnder16" class="value">0</div>
                    <div class="label">إناث أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box">
                    <div id="avgChildrenPerParent" class="value">0</div>
                    <div class="label">متوسط الأبناء لكل والد</div>
                </div>
                <div class="stat-box" id="statMembersWithoutChildren">
                    <div id="membersWithoutChildren" class="value">0</div>
                    <div class="label">أفراد ليس لديهم أبناء (أحياء)</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">الرسوم البيانية</h2>
                <div id="export-buttons" class="flex gap-2">
                    <button id="exportChartsPdfBtn" class="btn-primary" title="تصدير المخططات كملف PDF"><i class="fas fa-file-pdf"></i></button>
                    <button id="exportChartsCsvBtn" class="btn-primary" title="تصدير بيانات الأعضاء كملف CSV"><i class="fas fa-file-csv"></i></button>
                    <button id="exportChartsPngBtn" class="btn-primary" title="تصدير المخططات كصورة PNG"><i class="fas fa-file-image"></i></button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Chart: Gender Distribution -->
                <div class="chart-card p-4 rounded-lg bg-white shadow-sm" id="genderChartContainer">
                    <h3 class="text-xl font-medium text-gray-800 text-center mb-4">توزيع الجنس (أحياء)</h3>
                    <div class="chart-container">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
                <!-- Chart: Age Distribution -->
                <div class="chart-card p-4 rounded-lg bg-white shadow-sm" id="ageChartContainer">
                    <h3 class="text-xl font-medium text-gray-800 text-center mb-4">توزيع العمر (أحياء)</h3>
                    <div class="chart-container">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
                <!-- Chart: Marital Status -->
                <div class="chart-card p-4 rounded-lg bg-white shadow-sm" id="maritalChartContainer">
                    <h3 class="text-xl font-medium text-gray-800 text-center mb-4">الحالة الاجتماعية (أحياء)</h3>
                    <div class="chart-container">
                        <canvas id="maritalStatusChart"></canvas>
                    </div>
                </div>
                <!-- Chart: Children Count -->
                <div class="chart-card p-4 rounded-lg bg-white shadow-sm" id="childrenCountChartContainer">
                    <h3 class="text-xl font-medium text-gray-800 text-center mb-4">عدد الأبناء لكل فرد</h3>
                    <div class="chart-container">
                        <canvas id="childrenCountChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase and User variables
        let app;
        let db;
        let auth;
        let userId;

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBOXGJek0FHS1VqXhkgORMq-VrPoN1db3w",
            authDomain: "family-9b0b8.firebaseapp.com",
            databaseURL: "https://family-9b0b8-default-rtdb.firebaseio.com",
            projectId: "family-9b0b8",
            storageBucket: "family-9b0b8.firebasestorage.app",
            messagingSenderId: "409089079475",
            appId: "1:409089079475:web:93f8be81e247ecfe2758c6",
            measurementId: "G-X5LDQB1WC9"
        };
        // The appId and auth token are now taken from the firebaseConfig object
        const appId = firebaseConfig.projectId;
        const initialAuthToken = null; // We are not using a custom auth token in this new setup.
        // ------------------------------------------------------------------

        // Global data and charts
        let allMembers = [];
        const charts = {};
        let familyNames = [];
        let selectedFamilyName = "All";

        // DOM elements
        const loadingModal = document.getElementById('loadingModal');
        const familyFilterSelect = document.getElementById('familyFilter');

        // Initial loading state
        showModal(loadingModal);

        // Utility functions for modals
        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }

        function showMessageModal(message) {
            document.getElementById('modalMessage').innerText = message;
            showModal(document.getElementById('messageModal'));
        }

        document.getElementById('closeMessageModalBtn').onclick = () => hideModal(document.getElementById('messageModal'));
        document.getElementById('confirmMessageModalBtn').onclick = () => hideModal(document.getElementById('messageModal'));

        // Initialize Firebase and Auth
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase initialized successfully.");

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User authenticated:", userId);
                            // Start listening for data after authentication
                            listenForFamilyData();
                        } else {
                            console.error("User not authenticated.");
                            hideModal(loadingModal);
                            showMessageModal("لم يتم المصادقة على المستخدم. يرجى التأكد من أنك قمت بتسجيل الدخول.");
                        }
                    });
                } else {
                    console.error("Firebase config is missing or invalid.");
                    hideModal(loadingModal);
                    showMessageModal("حدث خطأ في إعدادات Firebase. يرجى التأكد من إضافة الإعدادات الصحيحة في الكود.");
                }
            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                hideModal(loadingModal);
                showMessageModal(`حدث خطأ أثناء تهيئة Firebase: ${error.message}`);
            }
        }

        // Listen for real-time family data updates from Firestore
        function listenForFamilyData() {
            const familyCollectionPath = `/artifacts/${appId}/users/${userId}/familyMembers`;
            const familyRef = collection(db, familyCollectionPath);

            onSnapshot(familyRef, (querySnapshot) => {
                const members = [];
                if (querySnapshot.empty) {
                    console.log("No family members found.");
                    hideModal(loadingModal);
                    showMessageModal("لا توجد بيانات متاحة لعرضها. يرجى التأكد من إضافة أفراد إلى العائلة أولاً.");
                    renderStatistics([]); // Render with empty data
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const member = doc.data();
                    member.id = doc.id;
                    members.push(member);
                });
                allMembers = members;
                console.log("Data fetched successfully.");
                hideModal(loadingModal);
                renderStatistics(allMembers);
            }, (error) => {
                console.error("Error listening to family data:", error);
                hideModal(loadingModal);
                showMessageModal(`حدث خطأ في جلب البيانات: ${error.message}`);
            });
        }

        // دالة لحساب العمر بناءً على تاريخ الميلاد (مستخدمة للأفراد الأحياء)
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // دالة جديدة لحساب العمر عند الوفاة (مستخدمة للأفراد المتوفين)
        function calculateAgeAtDeath(birthDate, deathDate) {
            if (!birthDate || !deathDate) return null;
            const birth = new Date(birthDate);
            const death = new Date(deathDate);
            let age = death.getFullYear() - birth.getFullYear();
            const m = death.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && death.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // Main function to render all statistics and charts
        function renderStatistics(members) {
            const livingMembers = members.filter(m => m.alive);
            const deceasedMembers = members.filter(m => !m.alive);
            const livingMales = livingMembers.filter(m => m.gender === 'male');
            const livingFemales = livingMembers.filter(m => m.gender === 'female');
            const uniqueFamilyNamesSet = new Set(members.map(m => m.familyName).filter(Boolean));

            // Update general statistics
            document.getElementById('totalMembers').innerText = members.length;
            document.getElementById('aliveMembers').innerText = livingMembers.length;
            document.getElementById('deceasedMembers').innerText = deceasedMembers.length;
            document.getElementById('uniqueFamilyNames').innerText = uniqueFamilyNamesSet.size;

            // Age calculations
            const ages = livingMembers.map(m => calculateAge(m.birthDate)).filter(age => age !== null);
            const totalAge = ages.reduce((sum, age) => sum + age, 0);
            const averageAge = ages.length > 0 ? (totalAge / ages.length).toFixed(1) : 0;
            document.getElementById('averageAge').innerText = averageAge;

            // تم تصحيح هذا الجزء لاستخدام الدالة الجديدة calculateAgeAtDeath
            const agesAtDeath = deceasedMembers.map(m => calculateAgeAtDeath(m.birthDate, m.deathDate)).filter(age => age !== null);
            const totalAgeAtDeath = agesAtDeath.reduce((sum, age) => sum + age, 0);
            const averageAgeAtDeath = agesAtDeath.length > 0 ? (totalAgeAtDeath / agesAtDeath.length).toFixed(1) : 0;
            document.getElementById('averageAgeAtDeath').innerText = averageAgeAtDeath;

            // Gender & Marital status
            document.getElementById('livingMales').innerText = livingMales.length;
            document.getElementById('livingFemales').innerText = livingFemales.length;
            
            const livingMarried = livingMembers.filter(m => m.maritalStatus === 'married');
            const livingEngaged = livingMembers.filter(m => m.maritalStatus === 'engaged');
            document.getElementById('livingMarried').innerText = livingMarried.length;
            document.getElementById('livingEngaged').innerText = livingEngaged.length;

            const livingMarriedMales = livingMarried.filter(m => m.gender === 'male');
            const livingMarriedFemales = livingMarried.filter(m => m.gender === 'female');
            document.getElementById('livingMarriedMales').innerText = livingMarriedMales.length;
            document.getElementById('livingMarriedFemales').innerText = livingMarriedFemales.length;

            const livingSingleMales = livingMales.filter(m => m.maritalStatus === 'single');
            const livingDivorcedMales = livingMales.filter(m => m.maritalStatus === 'divorced');
            const livingWidowedMales = livingMales.filter(m => m.maritalStatus === 'widowed');
            document.getElementById('livingSingleMales').innerText = livingSingleMales.length;
            document.getElementById('livingDivorcedMales').innerText = livingDivorcedMales.length;
            document.getElementById('livingWidowedMales').innerText = livingWidowedMales.length;

            const livingSingleFemales = livingFemales.filter(m => m.maritalStatus === 'single');
            const livingDivorcedFemales = livingFemales.filter(m => m.maritalStatus === 'divorced');
            const livingWidowedFemales = livingFemales.filter(m => m.maritalStatus === 'widowed');
            document.getElementById('livingSingleFemales').innerText = livingSingleFemales.length;
            document.getElementById('livingDivorcedFemales').innerText = livingDivorcedFemales.length;
            document.getElementById('livingWidowedFemales').innerText = livingWidowedFemales.length;
            
            // Age groups
            const malesOver16 = livingMales.filter(m => calculateAge(m.birthDate) >= 16);
            const femalesOver16 = livingFemales.filter(m => calculateAge(m.birthDate) >= 16);
            const malesUnder16 = livingMales.filter(m => calculateAge(m.birthDate) < 16);
            const femalesUnder16 = livingFemales.filter(m => calculateAge(m.birthDate) < 16);
            document.getElementById('malesOver16').innerText = malesOver16.length;
            document.getElementById('femalesOver16').innerText = femalesOver16.length;
            document.getElementById('malesUnder16').innerText = malesUnder16.length;
            document.getElementById('femalesUnder16').innerText = femalesUnder16.length;

            // Children stats
            const parents = livingMembers.filter(m => m.children && m.children.length > 0);
            const totalChildren = parents.reduce((sum, p) => sum + p.children.length, 0);
            const avgChildrenPerParent = parents.length > 0 ? (totalChildren / parents.length).toFixed(1) : 0;
            document.getElementById('avgChildrenPerParent').innerText = avgChildrenPerParent;

            const membersWithoutChildren = livingMembers.filter(m => !m.children || m.children.length === 0);
            document.getElementById('membersWithoutChildren').innerText = membersWithoutChildren.length;

            // Populate family filter
            familyNames = ["All", ...Array.from(uniqueFamilyNamesSet).sort()];
            familyFilterSelect.innerHTML = familyNames.map(name => `<option value="${name}">${name}</option>`).join('');
            familyFilterSelect.value = selectedFamilyName;
            
            // Filter data based on selected family
            const filteredMembers = selectedFamilyName === "All" ? members : members.filter(m => m.familyName === selectedFamilyName);
            
            // Redraw charts with filtered data
            renderCharts(filteredMembers);
        }

        // Function to create and update all charts
        function renderCharts(members) {
            const livingMembers = members.filter(m => m.alive);

            // Chart 1: Gender Distribution
            const males = livingMembers.filter(m => m.gender === 'male').length;
            const females = livingMembers.filter(m => m.gender === 'female').length;
            updateChart('genderChart', 'pie', {
                labels: ['ذكور', 'إناث'],
                datasets: [{
                    data: [males, females],
                    backgroundColor: ['#60a5fa', '#f87171'],
                    borderColor: ['#3b82f6', '#ef4444']
                }]
            }, {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const total = males + females;
                                const value = tooltipItem.raw;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${tooltipItem.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                onClick: (event, activeElements) => handleChartClick(event, activeElements, 'gender')
            });

            // Chart 2: Age Distribution
            const ageRanges = { '0-15': 0, '16-30': 0, '31-50': 0, '51-70': 0, '71+': 0 };
            livingMembers.forEach(m => {
                const age = calculateAge(m.birthDate);
                if (age !== null) {
                    if (age >= 0 && age <= 15) ageRanges['0-15']++;
                    else if (age >= 16 && age <= 30) ageRanges['16-30']++;
                    else if (age >= 31 && age <= 50) ageRanges['31-50']++;
                    else if (age >= 51 && age <= 70) ageRanges['51-70']++;
                    else ageRanges['71+']++;
                }
            });
            updateChart('ageChart', 'bar', {
                labels: Object.keys(ageRanges),
                datasets: [{
                    label: 'عدد الأفراد',
                    data: Object.values(ageRanges),
                    backgroundColor: '#818cf8',
                    borderColor: '#4f46e5',
                    borderWidth: 1
                }]
            }, {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: 'الفئة العمرية' } },
                    y: { title: { display: true, text: 'العدد' }, beginAtZero: true }
                },
                onClick: (event, activeElements) => handleChartClick(event, activeElements, 'age')
            });

            // Chart 3: Marital Status
            const maritalCounts = {
                'married': livingMembers.filter(m => m.maritalStatus === 'married').length,
                'single': livingMembers.filter(m => m.maritalStatus === 'single').length,
                'engaged': livingMembers.filter(m => m.maritalStatus === 'engaged').length,
                'divorced': livingMembers.filter(m => m.maritalStatus === 'divorced').length,
                'widowed': livingMembers.filter(m => m.maritalStatus === 'widowed').length,
                'unknown': livingMembers.filter(m => !m.maritalStatus || m.maritalStatus === 'unknown').length,
            };
            const maritalLabels = {
                'married': 'متزوج', 'single': 'أعزب', 'engaged': 'مخطوب',
                'divorced': 'مطلق', 'widowed': 'أرمل', 'unknown': 'غير محدد'
            };
            const maritalBackgrounds = {
                'married': '#34d399', 'single': '#fde047', 'engaged': '#93c5fd',
                'divorced': '#fb7185', 'widowed': '#9ca3af', 'unknown': '#e5e7eb'
            };
            const maritalBorderColors = {
                'married': '#059669', 'single': '#d97706', 'engaged': '#3b82f6',
                'divorced': '#e11d48', 'widowed': '#4b5563', 'unknown': '#9ca3af'
            };
            updateChart('maritalStatusChart', 'doughnut', {
                labels: Object.keys(maritalCounts).map(key => maritalLabels[key]),
                datasets: [{
                    data: Object.values(maritalCounts),
                    backgroundColor: Object.values(maritalBackgrounds),
                    borderColor: Object.values(maritalBorderColors),
                    hoverOffset: 4
                }]
            }, {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const total = Object.values(maritalCounts).reduce((sum, count) => sum + count, 0);
                                const value = tooltipItem.raw;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${tooltipItem.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                onClick: (event, activeElements) => handleChartClick(event, activeElements, 'maritalStatus', maritalLabels)
            });

            // Chart 4: Children Count
            const childrenCounts = livingMembers.filter(m => m.children && m.children.length > 0).map(m => m.children.length);
            const childrenLabels = Array.from(new Set(childrenCounts)).sort((a, b) => a - b);
            const childrenData = childrenLabels.map(count => childrenCounts.filter(c => c === count).length);
            updateChart('childrenCountChart', 'polarArea', {
                labels: childrenLabels.map(c => c === 1 ? `1 ابن` : `${c} أبناء`),
                datasets: [{
                    data: childrenData,
                    backgroundColor: childrenLabels.map((_, i) => `hsl(${i * 60}, 70%, 75%)`),
                    borderColor: childrenLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`)
                }]
            }, {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `لديهم ${tooltipItem.label}: ${tooltipItem.raw} فرد`;
                            }
                        }
                    }
                },
                onClick: (event, activeElements) => handleChartClick(event, activeElements, 'childrenCount', childrenLabels)
            });
        }

        // Helper function to create/update charts
        function updateChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    ...options
                }
            });
        }
        
        // Function to handle chart click events (drill-down)
        function handleChartClick(event, activeElements, chartType, labelMapping = null) {
            if (activeElements.length > 0) {
                const elementIndex = activeElements[0].index;
                const filteredMembers = selectedFamilyName === "All" ? allMembers : allMembers.filter(m => m.familyName === selectedFamilyName);
                
                let detailsTitle = '';
                let peopleList = [];

                if (chartType === 'gender') {
                    const label = charts['genderChart'].data.labels[elementIndex];
                    detailsTitle = `تفاصيل ${label}`;
                    const gender = label === 'ذكور' ? 'male' : 'female';
                    peopleList = filteredMembers.filter(m => m.alive && m.gender === gender);
                } else if (chartType === 'age') {
                    const label = charts['ageChart'].data.labels[elementIndex];
                    detailsTitle = `تفاصيل الفئة العمرية: ${label}`;
                    const [minAge, maxAge] = label.split('-').map(Number);
                    if (label.includes('+')) {
                        peopleList = filteredMembers.filter(m => m.alive && calculateAge(m.birthDate) >= minAge);
                    } else {
                        peopleList = filteredMembers.filter(m => m.alive && calculateAge(m.birthDate) >= minAge && calculateAge(m.birthDate) <= maxAge);
                    }
                } else if (chartType === 'maritalStatus') {
                    const label = charts['maritalStatusChart'].data.labels[elementIndex];
                    const status = Object.keys(labelMapping).find(key => labelMapping[key] === label);
                    detailsTitle = `تفاصيل الحالة الاجتماعية: ${label}`;
                    peopleList = filteredMembers.filter(m => m.alive && m.maritalStatus === status);
                } else if (chartType === 'childrenCount') {
                    const count = labelMapping[elementIndex];
                    detailsTitle = `تفاصيل الأفراد الذين لديهم ${count} أبناء`;
                    peopleList = filteredMembers.filter(m => m.alive && m.children && m.children.length === count);
                }

                const listElement = document.getElementById('chartDetailsList');
                listElement.innerHTML = peopleList.map(person => 
                    `<li>${person.fullName} (${calculateAge(person.birthDate)} سنة)</li>`
                ).join('');
                document.getElementById('chartDetailsTitle').innerText = detailsTitle;
                showModal(document.getElementById('chartDetailsModal'));
            }
        }
        
        // Close chart details modal
        document.getElementById('closeChartDetailsModalBtn').onclick = () => hideModal(document.getElementById('chartDetailsModal'));

        // Event listener for family filter change
        familyFilterSelect.addEventListener('change', (e) => {
            selectedFamilyName = e.target.value;
            renderStatistics(allMembers);
        });

        // Export functions
        document.getElementById('exportChartsPdfBtn').addEventListener('click', () => {
            showMessageModal("وظيفة تصدير PDF غير متاحة حاليًا.");
        });

        // Event listener for CSV export button
        document.getElementById('exportChartsCsvBtn').addEventListener('click', () => {
            const filteredMembers = selectedFamilyName === "All" ? allMembers : allMembers.filter(m => m.familyName === selectedFamilyName);
            if (filteredMembers.length === 0) {
                showMessageModal("لا توجد بيانات لتصديرها.");
                return;
            }
            const csvData = convertToCsv(filteredMembers);
            downloadFile(csvData, `family_members_${selectedFamilyName}.csv`, 'text/csv');
        });

        // Event listener for PNG export button
        document.getElementById('exportChartsPngBtn').addEventListener('click', async () => {
            const zip = new JSZip();
            const chartCards = document.querySelectorAll('.chart-card');
            
            showModal(loadingModal);
            loadingModal.querySelector('p').innerText = 'جارٍ تصدير الرسوم البيانية...';

            const chartImages = await Promise.all(Array.from(chartCards).map(async (card) => {
                const canvas = await html2canvas(card, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true
                });
                const chartTitle = card.querySelector('h3').innerText;
                const base64Image = canvas.toDataURL('image/png').split(',')[1];
                return { title: chartTitle, data: base64Image };
            }));

            chartImages.forEach(img => {
                zip.file(`${img.title}.png`, img.data, { base64: true });
            });

            zip.generateAsync({ type: 'blob' }).then(function(content) {
                downloadFile(content, 'family_charts.zip', 'application/zip');
                hideModal(loadingModal);
                showMessageModal("تم تصدير الرسوم البيانية بنجاح كملف مضغوط PNG.");
            });
        });

        // Helper function to convert data to CSV
        function convertToCsv(members) {
            const headers = [
                'الاسم الكامل', 'اسم العائلة', 'الجنس', 'تاريخ الميلاد', 'تاريخ الوفاة',
                'الحالة الاجتماعية', 'تاريخ الزواج', 'تاريخ الخطوبة',
                'الأبناء (الاسم الكامل)', 'الوالد (الاسم الكامل)', 'الوالدة (الاسم الكامل)',
                'على قيد الحياة', 'ملاحظات'
            ].map(value => `"${value}"`).join(',');
            
            const rows = members.map(member => {
                const values = [
                    member.fullName || '',
                    member.familyName || '',
                    member.gender === 'male' ? 'ذكر' : 'أنثى',
                    member.birthDate || '',
                    member.deathDate || '',
                    member.maritalStatus || '',
                    member.marriageDate || '',
                    member.engagementDate || '',
                    (member.children || []).map(c => c.fullName).join('; ') || '',
                    (member.fatherId || member.fatherFullName) || '',
                    (member.motherId || member.motherFullName) || '',
                    member.alive ? 'نعم' : 'لا',
                    member.notes || ''
                ].map(value => `"${value}"`.replace(/"/g, '\"\"')); // Escape double quotes for CSV
                return values.join(',');
            });
            return [headers, ...rows].join('\n');
        }

        // Helper function to download files
        function downloadFile(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click(); // Trigger the download
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Start initialization immediately
        initializeFirebase();
    </script>
</body>
</html>
