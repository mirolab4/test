<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إحصائيات العائلة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Note: auth_guard.js is no longer needed as all logic is in this file -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right; /* Align text to the right */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative; /* Needed for absolute positioning of loading overlay */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded corners */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Light gray */
            color: #374151; /* Dark gray text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Darker light gray */
        }
        .stat-box {
            background-color: #e0f2fe; /* Light blue */
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer; /* Indicate clickable */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .stat-box .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2563eb; /* Blue */
        }
        .stat-box .label {
            font-size: 1rem;
            color: #374151;
            margin-top: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: left; /* Align to left for RTL */
            font-size: 28px;
            font-weight: bold;
            cursor: pointer; /* Add cursor pointer for better UX */
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }

        /* Modal for Chart Details */
        #chartDetailsModal .modal-content {
            max-width: 600px;
            text-align: right;
        }
        #chartDetailsList li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        #chartDetailsList li:last-child {
            border-bottom: none;
        }
        .person-link {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 500;
        }
        .person-link:hover {
            text-decoration: underline;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .filter-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .filter-group select {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: white;
            cursor: pointer;
        }

        /* Print specific styles */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            .btn-primary, .btn-secondary, nav, .flex.flex-wrap.justify-end.gap-4.mt-6.mb-6, .filter-group {
                display: none; /* Hide buttons, navigation, and filter when printing */
            }
            .card {
                box-shadow: none;
                border: 1px solid #eee;
                margin-bottom: 1rem;
                page-break-inside: avoid; /* Avoid breaking cards across pages */
            }
            .chart-container {
                height: auto; /* Allow charts to scale naturally */
                width: 100%;
            }
            canvas {
                max-width: 100%;
                height: auto !important; /* Override Chart.js inline styles */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span id="closeMessageModalBtn" class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="confirmMessageModalBtn" class="btn-primary">حسناً</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="spinner"></div>
            <p class="text-lg font-semibold text-gray-800">جارٍ تحميل الإحصائيات...</p>
        </div>
    </div>

    <!-- Modal for Chart Details (Drill-down) -->
    <div id="chartDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeChartDetailsModalBtn" class="close-button">&times;</span>
            <h3 id="chartDetailsTitle" class="text-2xl font-semibold text-gray-700 mb-4">تفاصيل الفئة</h3>
            <ul id="chartDetailsList" class="list-disc pr-6 text-gray-700">
                <!-- Details will be loaded here -->
            </ul>
        </div>
    </div>

    <div class="container">
        <!-- Header, simplified by removing navigation as login is disabled -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
            <h1 class="text-3xl font-bold text-gray-800">لوحة إحصائيات العائلة</h1>
        </div>

        <!-- General Statistics -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">إحصائيات عامة</h2>
            <div class="filter-group">
                <label for="familyFilter">تحديد العائلة:</label>
                <select id="familyFilter" class="input-field w-auto">
                    <option value="All">الكل</option>
                    <!-- Family names will be populated here by JavaScript -->
                </select>
            </div>
            <div id="statisticsContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <div class="stat-box" id="statTotalMembers">
                    <div id="totalMembers" class="value">0</div>
                    <div class="label">إجمالي أفراد العائلة</div>
                </div>
                <div class="stat-box" id="statAliveMembers">
                    <div id="aliveMembers" class="value">0</div>
                    <div class="label">أفراد على قيد الحياة</div>
                </div>
                <div class="stat-box" id="statDeceasedMembers">
                    <div id="deceasedMembers" class="value">0</div>
                    <div class="label">أفراد متوفون</div>
                </div>
                <div class="stat-box"> <!-- Average age is not a list of people -->
                    <div id="averageAge" class="value">0</div>
                    <div class="label">متوسط العمر (الأحياء)</div>
                </div>
                <div class="stat-box"> <!-- Average age at death is not a list of people -->
                    <div id="averageAgeAtDeath" class="value">0</div>
                    <div class="label">متوسط العمر عند الوفاة</div>
                </div>
                <div class="stat-box" id="statUniqueFamilyNames">
                    <div id="uniqueFamilyNames" class="value">0</div>
                    <div class="label">عدد أسماء العائلات الفريدة</div>
                </div>
                <div class="stat-box" id="statLivingMales">
                    <div id="livingMales" class="value">0</div>
                    <div class="label">ذكور أحياء</div>
                </div>
                <div class="stat-box" id="statLivingFemales">
                    <div id="livingFemales" class="value">0</div>
                    <div class="label">إناث أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarried">
                    <div id="livingMarried" class="value">0</div>
                    <div class="label">متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingEngaged">
                    <div id="livingEngaged" class="value">0</div>
                    <div class="label">مخطوبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedMales">
                    <div id="livingMarriedMales" class="value">0</div>
                    <div class="label">ذكور متزوجون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingMarriedFemales">
                    <div id="livingMarriedFemales" class="value">0</div>
                    <div class="label">إناث متزوجات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleMales">
                    <div id="livingSingleMales" class="value">0</div>
                    <div class="label">ذكور عازبون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedMales">
                    <div id="livingDivorcedMales" class="value">0</div>
                    <div class="label">ذكور مطلقون أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedMales">
                    <div id="livingWidowedMales" class="value">0</div>
                    <div class="label">ذكور أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statLivingSingleFemales">
                    <div id="livingSingleFemales" class="value">0</div>
                    <div class="label">إناث عازبات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingDivorcedFemales">
                    <div id="livingDivorcedFemales" class="value">0</div>
                    <div class="label">إناث مطلقات أحياء</div>
                </div>
                <div class="stat-box" id="statLivingWidowedFemales">
                    <div id="livingWidowedFemales" class="value">0</div>
                    <div class="label">إناث أرامل أحياء</div>
                </div>
                <div class="stat-box" id="statMalesOver16">
                    <div id="malesOver16" class="value">0</div>
                    <div class="label">ذكور فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesOver16">
                    <div id="femalesOver16" class="value">0</div>
                    <div class="label">إناث فوق 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statMalesUnder16">
                    <div id="malesUnder16" class="value">0</div>
                    <div class="label">ذكور أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box" id="statFemalesUnder16">
                    <div id="femalesUnder16" class="value">0</div>
                    <div class="label">إناث أقل من 16 سنة (أحياء)</div>
                </div>
                <div class="stat-box"> <!-- Average children per parent is not a list of people -->
                    <div id="avgChildrenPerParent" class="value">0</div>
                    <div class="label">متوسط الأبناء لكل والد</div>
                </div>
                <div class="stat-box" id="statMembersWithoutChildren">
                    <div id="membersWithoutChildren" class="value">0</div>
                    <div class="label">أفراد بدون أبناء</div>
                </div>
                <div class="stat-box"> <!-- Profile completion is a percentage, not a list of people -->
                    <div id="profileCompletion" class="value">0%</div>
                    <div class="label">اكتمال الملفات الشخصية</div>
                </div>
                <div class="stat-box" id="statMissingBirthDate">
                    <div id="missingBirthDate" class="value">0</div>
                    <div class="label">أفراد بدون تاريخ ميلاد</div>
                </div>
                <div class="stat-box" id="statMissingGender">
                    <div id="missingGender" class="value">0</div>
                    <div class="label">أفراد بدون جنس</div>
                </div>
                <div class="stat-box" id="statMissingFamilyName">
                    <div id="missingFamilyName" class="value">0</div>
                    <div class="label">أفراد بدون اسم عائلة</div>
                </div>
                <div class="stat-box"> <!-- Average age is not a list of people -->
                    <div id="avgMaleMarriageAge" class="value">0</div>
                    <div class="label">متوسط عمر الزواج (ذكور)</div>
                </div>
                <div class="stat-box"> <!-- Average age is not a list of people -->
                    <div id="avgFemaleMarriageAge" class="value">0</div>
                    <div class="label">متوسط عمر الزواج (إناث)</div>
                </div>
                <div class="stat-box"> <!-- Average age is not a list of people -->
                    <div id="avgMaleEngagementAge" class="value">0</div>
                    <div class="label">متوسط عمر الخطوبة (ذكور)</div>
                </div>
                <div class="stat-box"> <!-- Average age is not a list of people -->
                    <div id="avgFemaleEngagementAge" class="value">0</div>
                    <div class="label">متوسط عمر الخطوبة (إناث)</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-end gap-4 mt-6 mb-6">
            <button id="exportCsvBtn" class="btn-primary">تصدير البيانات (CSV)</button>
            <button id="exportChartsBtn" class="btn-primary">تصدير المخططات (PNG)</button>
            <button id="printPageBtn" class="btn-secondary">طباعة الصفحة</button>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الجنس</h2>
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الحالة الاجتماعية (جميع الأفراد)</h2>
                <div class="chart-container">
                    <canvas id="maritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع الحالة الاجتماعية (الأفراد الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="maritalStatusAliveChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع العمر (الأفراد الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">توزيع شهر الميلاد (الأفراد الأحياء)</h2>
                <div class="chart-container">
                    <canvas id="birthMonthChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">أكثر أسماء العائلات شيوعًا</h2>
                <div class="chart-container">
                    <canvas id="familyNameChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الحالة الاجتماعية للذكور الأحياء</h2>
                <div class="chart-container">
                    <canvas id="maleMaritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الحالة الاجتماعية للإناث الأحياء</h2>
                <div class="chart-container">
                    <canvas id="femaleMaritalStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">المواليد حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="birthsPerYearChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الوفيات حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="deathsPerYearChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">الزواج والخطوبة حسب السنة</h2>
                <div class="chart-container">
                    <canvas id="marriagesEngagementsPerYearChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration - As requested by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBOXGJek0FHS1VqXhkgORMq-VrPoN1db3w",
            authDomain: "family-9b0b8.firebaseapp.com",
            databaseURL: "https://family-9b0b8-default-rtdb.firebaseio.com",
            projectId: "family-9b0b8",
            storageBucket: "family-9b0b8.firebasestorage.app",
            messagingSenderId: "409089079475",
            appId: "1:409089079475:web:93f8be81e247ecfe2758c6",
            measurementId: "G-X5LDQB1WC9"
        };
        const appId = firebaseConfig.projectId;

        // Initialize Firebase App and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Chart instances
        let genderChartInstance, maritalStatusChartInstance, maritalStatusAliveChartInstance,
            ageDistributionChartInstance, birthMonthChartInstance, familyNameChartInstance,
            maleMaritalStatusChartInstance, femaleMaritalStatusChartInstance,
            birthsPerYearChartInstance, deathsPerYearChartInstance, marriagesEngagementsPerYearChartInstance;

        // Data cache and elements
        let allFamilyMembers = [];
        let filteredMembers = [];
        const loadingModal = document.getElementById('loadingModal');
        const familyFilterSelect = document.getElementById('familyFilter');

        // Show/hide loading modal
        function showLoading() {
            loadingModal.style.display = 'flex';
        }

        function hideLoading() {
            loadingModal.style.display = 'none';
        }

        // Helper function to show a custom message modal
        function showMessageModal(message, callback) {
            const modal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmMessageModalBtn');

            modalMessage.textContent = message;
            modal.style.display = 'flex';

            const confirmHandler = () => {
                modal.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmHandler);
                if (callback) callback();
            };

            confirmBtn.addEventListener('click', confirmHandler);
            document.getElementById('closeMessageModalBtn').onclick = confirmHandler;
        }

        // Helper function to create a Chart.js instance
        function createChart(canvasId, config) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            // Destroy existing chart to prevent duplicates
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                existingChart.destroy();
            }
            return new Chart(ctx, config);
        }

        // Function to calculate age from birth date
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // Function to calculate age at death
        function calculateAgeAtDeath(birthDate, deathDate) {
            if (!birthDate || !deathDate) return null;
            const birth = new Date(birthDate);
            const death = new Date(deathDate);
            let age = death.getFullYear() - birth.getFullYear();
            const m = death.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && death.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // Function to get event year
        function getEventYear(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.getFullYear();
        }

        // Function to process data and render statistics
        async function loadAndRenderStats(familyMembers) {
            if (familyMembers.length === 0) {
                showMessageModal('لا توجد بيانات متاحة لعرضها. يرجى التأكد من أن المسار صحيح أو إضافة أفراد إلى العائلة أولاً.');
                return;
            }

            // Get selected family name from filter
            const selectedFamilyName = familyFilterSelect.value;
            filteredMembers = familyMembers.filter(member => selectedFamilyName === 'All' || member.familyName === selectedFamilyName);

            // General Statistics Calculations
            const totalMembers = filteredMembers.length;
            const aliveMembers = filteredMembers.filter(m => m.alive === true);
            const deceasedMembers = filteredMembers.filter(m => m.alive === false);
            const aliveMales = aliveMembers.filter(m => m.gender === 'male');
            const aliveFemales = aliveMembers.filter(m => m.gender === 'female');
            const uniqueFamilyNames = [...new Set(filteredMembers.map(m => m.familyName))].length;

            const ages = aliveMembers.map(m => calculateAge(m.birthDate)).filter(age => age !== null);
            const totalAges = ages.reduce((sum, age) => sum + age, 0);
            const averageAge = ages.length > 0 ? (totalAges / ages.length).toFixed(1) : 0;

            const agesAtDeath = deceasedMembers.map(m => calculateAgeAtDeath(m.birthDate, m.deathDate)).filter(age => age !== null);
            const totalAgesAtDeath = agesAtDeath.reduce((sum, age) => sum + age, 0);
            const averageAgeAtDeath = agesAtDeath.length > 0 ? (totalAgesAtDeath / agesAtDeath.length).toFixed(1) : 0;

            const maritalStatuses = aliveMembers.map(m => m.maritalStatus);
            const marriedMembers = maritalStatuses.filter(s => s === 'married').length;
            const engagedMembers = maritalStatuses.filter(s => s === 'engaged').length;

            const aliveMarriedMales = aliveMales.filter(m => m.maritalStatus === 'married').length;
            const aliveMarriedFemales = aliveFemales.filter(m => m.maritalStatus === 'married').length;
            const aliveSingleMales = aliveMales.filter(m => m.maritalStatus === 'single').length;
            const aliveDivorcedMales = aliveMales.filter(m => m.maritalStatus === 'divorced').length;
            const aliveWidowedMales = aliveMales.filter(m => m.maritalStatus === 'widowed').length;
            const aliveSingleFemales = aliveFemales.filter(m => m.maritalStatus === 'single').length;
            const aliveDivorcedFemales = aliveFemales.filter(m => m.maritalStatus === 'divorced').length;
            const aliveWidowedFemales = aliveFemales.filter(m => m.maritalStatus === 'widowed').length;

            const malesOver16 = aliveMales.filter(m => calculateAge(m.birthDate) >= 16).length;
            const femalesOver16 = aliveFemales.filter(m => calculateAge(m.birthDate) >= 16).length;
            const malesUnder16 = aliveMales.filter(m => calculateAge(m.birthDate) < 16).length;
            const femalesUnder16 = aliveFemales.filter(m => calculateAge(m.birthDate) < 16).length;

            const parents = filteredMembers.filter(m => m.children && m.children.length > 0);
            const totalChildrenCount = parents.reduce((sum, p) => sum + p.children.length, 0);
            const avgChildrenPerParent = parents.length > 0 ? (totalChildrenCount / parents.length).toFixed(1) : 0;
            const membersWithoutChildren = filteredMembers.filter(m => !m.children || m.children.length === 0).length;

            // Profile completion calculation
            const fieldsToCheck = ['fullName', 'gender', 'birthDate', 'familyName', 'maritalStatus'];
            let totalPossibleFields = filteredMembers.length * fieldsToCheck.length;
            let completedFields = 0;
            filteredMembers.forEach(member => {
                fieldsToCheck.forEach(field => {
                    if (member[field]) {
                        completedFields++;
                    }
                });
            });
            const profileCompletion = totalPossibleFields > 0 ? ((completedFields / totalPossibleFields) * 100).toFixed(1) : 0;

            const missingBirthDate = filteredMembers.filter(m => !m.birthDate).length;
            const missingGender = filteredMembers.filter(m => !m.gender).length;
            const missingFamilyName = filteredMembers.filter(m => !m.familyName).length;

            const maleMarriages = filteredMembers.filter(m => m.gender === 'male' && m.maritalStatus === 'married' && m.marriageDate);
            const maleMarriageAges = maleMarriages.map(m => calculateAgeAtDeath(m.birthDate, m.marriageDate)).filter(age => age !== null);
            const avgMaleMarriageAge = maleMarriageAges.length > 0 ? (maleMarriageAges.reduce((a, b) => a + b, 0) / maleMarriageAges.length).toFixed(1) : 0;

            const femaleMarriages = filteredMembers.filter(m => m.gender === 'female' && m.maritalStatus === 'married' && m.marriageDate);
            const femaleMarriageAges = femaleMarriages.map(m => calculateAgeAtDeath(m.birthDate, m.marriageDate)).filter(age => age !== null);
            const avgFemaleMarriageAge = femaleMarriageAges.length > 0 ? (femaleMarriageAges.reduce((a, b) => a + b, 0) / femaleMarriageAges.length).toFixed(1) : 0;

            const maleEngagements = filteredMembers.filter(m => m.gender === 'male' && m.maritalStatus === 'engaged' && m.engagementDate);
            const maleEngagementAges = maleEngagements.map(m => calculateAgeAtDeath(m.birthDate, m.engagementDate)).filter(age => age !== null);
            const avgMaleEngagementAge = maleEngagementAges.length > 0 ? (maleEngagementAges.reduce((a, b) => a + b, 0) / maleEngagementAges.length).toFixed(1) : 0;

            const femaleEngagements = filteredMembers.filter(m => m.gender === 'female' && m.maritalStatus === 'engaged' && m.engagementDate);
            const femaleEngagementAges = femaleEngagements.map(m => calculateAgeAtDeath(m.birthDate, m.engagementDate)).filter(age => age !== null);
            const avgFemaleEngagementAge = femaleEngagementAges.length > 0 ? (femaleEngagementAges.reduce((a, b) => a + b, 0) / femaleEngagementAges.length).toFixed(1) : 0;

            // Update DOM with calculated statistics
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('aliveMembers').textContent = aliveMembers.length;
            document.getElementById('deceasedMembers').textContent = deceasedMembers.length;
            document.getElementById('averageAge').textContent = averageAge;
            document.getElementById('averageAgeAtDeath').textContent = averageAgeAtDeath;
            document.getElementById('uniqueFamilyNames').textContent = uniqueFamilyNames;
            document.getElementById('livingMales').textContent = aliveMales.length;
            document.getElementById('livingFemales').textContent = aliveFemales.length;
            document.getElementById('livingMarried').textContent = marriedMembers;
            document.getElementById('livingEngaged').textContent = engagedMembers;
            document.getElementById('livingMarriedMales').textContent = aliveMarriedMales;
            document.getElementById('livingMarriedFemales').textContent = aliveMarriedFemales;
            document.getElementById('livingSingleMales').textContent = aliveSingleMales;
            document.getElementById('livingDivorcedMales').textContent = aliveDivorcedMales;
            document.getElementById('livingWidowedMales').textContent = aliveWidowedMales;
            document.getElementById('livingSingleFemales').textContent = aliveSingleFemales;
            document.getElementById('livingDivorcedFemales').textContent = aliveDivorcedFemales;
            document.getElementById('livingWidowedFemales').textContent = aliveWidowedFemales;
            document.getElementById('malesOver16').textContent = malesOver16;
            document.getElementById('femalesOver16').textContent = femalesOver16;
            document.getElementById('malesUnder16').textContent = malesUnder16;
            document.getElementById('femalesUnder16').textContent = femalesUnder16;
            document.getElementById('avgChildrenPerParent').textContent = avgChildrenPerParent;
            document.getElementById('membersWithoutChildren').textContent = membersWithoutChildren;
            document.getElementById('profileCompletion').textContent = `${profileCompletion}%`;
            document.getElementById('missingBirthDate').textContent = missingBirthDate;
            document.getElementById('missingGender').textContent = missingGender;
            document.getElementById('missingFamilyName').textContent = missingFamilyName;
            document.getElementById('avgMaleMarriageAge').textContent = avgMaleMarriageAge;
            document.getElementById('avgFemaleMarriageAge').textContent = avgFemaleMarriageAge;
            document.getElementById('avgMaleEngagementAge').textContent = avgMaleEngagementAge;
            document.getElementById('avgFemaleEngagementAge').textContent = avgFemaleEngagementAge;

            // Chart Data Calculations
            const genderData = {
                labels: ['ذكور', 'إناث'],
                datasets: [{
                    data: [filteredMembers.filter(m => m.gender === 'male').length, filteredMembers.filter(m => m.gender === 'female').length],
                    backgroundColor: ['#2563eb', '#f472b6'],
                }]
            };

            const maritalStatusLabels = {
                'single': 'أعزب/عزباء',
                'married': 'متزوج/متزوجة',
                'divorced': 'مطلق/مطلقة',
                'widowed': 'أرمل/أرملة',
                'engaged': 'مخطوب/مخطوبة',
            };

            const allMaritalStatuses = {};
            filteredMembers.forEach(m => {
                const status = maritalStatusLabels[m.maritalStatus] || 'غير محدد';
                allMaritalStatuses[status] = (allMaritalStatuses[status] || 0) + 1;
            });
            const maritalStatusData = {
                labels: Object.keys(allMaritalStatuses),
                datasets: [{
                    data: Object.values(allMaritalStatuses),
                    backgroundColor: ['#f472b6', '#2563eb', '#6ee7b7', '#fcd34d', '#93c5fd'],
                }]
            };

            const aliveMaritalStatuses = {};
            aliveMembers.forEach(m => {
                const status = maritalStatusLabels[m.maritalStatus] || 'غير محدد';
                aliveMaritalStatuses[status] = (aliveMaritalStatuses[status] || 0) + 1;
            });
            const maritalStatusAliveData = {
                labels: Object.keys(aliveMaritalStatuses),
                datasets: [{
                    data: Object.values(aliveMaritalStatuses),
                    backgroundColor: ['#f472b6', '#2563eb', '#6ee7b7', '#fcd34d', '#93c5fd'],
                }]
            };

            const ageGroups = {
                '0-15': 0, '16-25': 0, '26-35': 0, '36-50': 0, '51-65': 0, '66+': 0
            };
            aliveMembers.forEach(m => {
                const age = calculateAge(m.birthDate);
                if (age !== null) {
                    if (age >= 0 && age <= 15) ageGroups['0-15']++;
                    else if (age >= 16 && age <= 25) ageGroups['16-25']++;
                    else if (age >= 26 && age <= 35) ageGroups['26-35']++;
                    else if (age >= 36 && age <= 50) ageGroups['36-50']++;
                    else if (age >= 51 && age <= 65) ageGroups['51-65']++;
                    else if (age >= 66) ageGroups['66+']++;
                }
            });
            const ageDistributionData = {
                labels: Object.keys(ageGroups),
                datasets: [{
                    label: 'عدد الأفراد',
                    data: Object.values(ageGroups),
                    backgroundColor: '#60a5fa',
                }]
            };

            const birthMonths = {
                'يناير': 0, 'فبراير': 0, 'مارس': 0, 'أبريل': 0, 'مايو': 0, 'يونيو': 0,
                'يوليو': 0, 'أغسطس': 0, 'سبتمبر': 0, 'أكتوبر': 0, 'نوفمبر': 0, 'ديسمبر': 0
            };
            const monthNames = Object.keys(birthMonths);
            aliveMembers.forEach(m => {
                const month = new Date(m.birthDate).getMonth();
                if (!isNaN(month)) {
                    birthMonths[monthNames[month]]++;
                }
            });
            const birthMonthData = {
                labels: monthNames,
                datasets: [{
                    label: 'عدد المواليد',
                    data: Object.values(birthMonths),
                    backgroundColor: '#38bdf8',
                }]
            };

            const familyNameCounts = {};
            filteredMembers.forEach(m => {
                if (m.familyName) {
                    familyNameCounts[m.familyName] = (familyNameCounts[m.familyName] || 0) + 1;
                }
            });
            const sortedFamilyNames = Object.entries(familyNameCounts).sort(([, a], [, b]) => b - a).slice(0, 10);
            const familyNameData = {
                labels: sortedFamilyNames.map(e => e[0]),
                datasets: [{
                    label: 'عدد الأفراد',
                    data: sortedFamilyNames.map(e => e[1]),
                    backgroundColor: '#a5b4fc',
                }]
            };

            const maleMaritalStatusCounts = {};
            aliveMales.forEach(m => {
                const status = maritalStatusLabels[m.maritalStatus] || 'غير محدد';
                maleMaritalStatusCounts[status] = (maleMaritalStatusCounts[status] || 0) + 1;
            });
            const maleMaritalStatusData = {
                labels: Object.keys(maleMaritalStatusCounts),
                datasets: [{
                    data: Object.values(maleMaritalStatusCounts),
                    backgroundColor: ['#f472b6', '#2563eb', '#6ee7b7', '#fcd34d', '#93c5fd'],
                }]
            };

            const femaleMaritalStatusCounts = {};
            aliveFemales.forEach(m => {
                const status = maritalStatusLabels[m.maritalStatus] || 'غير محدد';
                femaleMaritalStatusCounts[status] = (femaleMaritalStatusCounts[status] || 0) + 1;
            });
            const femaleMaritalStatusData = {
                labels: Object.keys(femaleMaritalStatusCounts),
                datasets: [{
                    data: Object.values(femaleMaritalStatusCounts),
                    backgroundColor: ['#f472b6', '#2563eb', '#6ee7b7', '#fcd34d', '#93c5fd'],
                }]
            };

            // Events by year charts
            const birthsByYear = {};
            const deathsByYear = {};
            const marriagesEngagementsByYear = {};

            filteredMembers.forEach(m => {
                const birthYear = getEventYear(m.birthDate);
                if (birthYear) {
                    birthsByYear[birthYear] = (birthsByYear[birthYear] || 0) + 1;
                }
                const deathYear = getEventYear(m.deathDate);
                if (deathYear) {
                    deathsByYear[deathYear] = (deathsByYear[deathYear] || 0) + 1;
                }
                const marriageYear = getEventYear(m.marriageDate);
                if (marriageYear) {
                    marriagesEngagementsByYear[marriageYear] = (marriagesEngagementsByYear[marriageYear] || 0) + 1;
                }
                const engagementYear = getEventYear(m.engagementDate);
                if (engagementYear) {
                    marriagesEngagementsByYear[engagementYear] = (marriagesEngagementsByYear[engagementYear] || 0) + 1;
                }
            });

            const allYears = new Set([...Object.keys(birthsByYear), ...Object.keys(deathsByYear), ...Object.keys(marriagesEngagementsByYear)]);
            const sortedYears = Array.from(allYears).sort();

            const birthsPerYearData = {
                labels: sortedYears,
                datasets: [{
                    label: 'عدد المواليد',
                    data: sortedYears.map(year => birthsByYear[year] || 0),
                    backgroundColor: '#60a5fa',
                    borderColor: '#2563eb',
                    borderWidth: 2
                }]
            };

            const deathsPerYearData = {
                labels: sortedYears,
                datasets: [{
                    label: 'عدد الوفيات',
                    data: sortedYears.map(year => deathsByYear[year] || 0),
                    backgroundColor: '#ef4444',
                    borderColor: '#b91c1c',
                    borderWidth: 2
                }]
            };

            const marriagesEngagementsPerYearData = {
                labels: sortedYears,
                datasets: [{
                    label: 'عدد الزواجات/الخطوبات',
                    data: sortedYears.map(year => marriagesEngagementsByYear[year] || 0),
                    backgroundColor: '#fcd34d',
                    borderColor: '#fbbf24',
                    borderWidth: 2
                }]
            };


            // Render charts
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                family: 'Inter'
                            }
                        }
                    },
                    tooltip: {
                        titleFont: { family: 'Inter' },
                        bodyFont: { family: 'Inter' }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chart = elements[0].element.$context.chart;
                        const labelIndex = elements[0].index;
                        const datasetIndex = elements[0].datasetIndex;
                        const label = chart.data.labels[labelIndex];
                        const count = chart.data.datasets[datasetIndex].data[labelIndex];
                        let membersList = [];
                        let modalTitle = 'تفاصيل';

                        if (chart.canvas.id === 'genderChart') {
                            modalTitle = `تفاصيل ${label}`;
                            membersList = filteredMembers.filter(m => m.gender === (label === 'ذكور' ? 'male' : 'female'));
                        } else if (chart.canvas.id === 'maritalStatusChart' || chart.canvas.id === 'maritalStatusAliveChart') {
                            modalTitle = `تفاصيل ${label}`;
                            const statusKey = Object.keys(maritalStatusLabels).find(key => maritalStatusLabels[key] === label);
                            const targetList = chart.canvas.id === 'maritalStatusChart' ? filteredMembers : aliveMembers;
                            membersList = targetList.filter(m => m.maritalStatus === statusKey);
                        } else if (chart.canvas.id === 'birthMonthChart') {
                            modalTitle = `مواليد شهر ${label}`;
                            const monthIndex = monthNames.indexOf(label);
                            membersList = aliveMembers.filter(m => new Date(m.birthDate).getMonth() === monthIndex);
                        } else if (chart.canvas.id === 'familyNameChart') {
                            modalTitle = `أفراد عائلة ${label}`;
                            membersList = filteredMembers.filter(m => m.familyName === label);
                        } else if (chart.canvas.id === 'ageDistributionChart') {
                            modalTitle = `الأفراد في الفئة العمرية ${label}`;
                            const ageRange = label.split('-');
                            if (ageRange.length > 1) {
                                const minAge = parseInt(ageRange[0]);
                                const maxAge = parseInt(ageRange[1]);
                                membersList = aliveMembers.filter(m => {
                                    const age = calculateAge(m.birthDate);
                                    return age >= minAge && age <= maxAge;
                                });
                            } else {
                                membersList = aliveMembers.filter(m => calculateAge(m.birthDate) >= 66);
                            }
                        } else if (chart.canvas.id === 'maleMaritalStatusChart') {
                            modalTitle = `ذكور ${label}`;
                            const statusKey = Object.keys(maritalStatusLabels).find(key => maritalStatusLabels[key] === label);
                            membersList = aliveMales.filter(m => m.maritalStatus === statusKey);
                        } else if (chart.canvas.id === 'femaleMaritalStatusChart') {
                            modalTitle = `إناث ${label}`;
                            const statusKey = Object.keys(maritalStatusLabels).find(key => maritalStatusLabels[key] === label);
                            membersList = aliveFemales.filter(m => m.maritalStatus === statusKey);
                        } else if (chart.canvas.id === 'birthsPerYearChart') {
                            modalTitle = `مواليد عام ${label}`;
                            membersList = filteredMembers.filter(m => getEventYear(m.birthDate) == label);
                        } else if (chart.canvas.id === 'deathsPerYearChart') {
                            modalTitle = `وفيات عام ${label}`;
                            membersList = filteredMembers.filter(m => getEventYear(m.deathDate) == label);
                        } else if (chart.canvas.id === 'marriagesEngagementsPerYearChart') {
                            modalTitle = `زواج وخطوبة عام ${label}`;
                            membersList = filteredMembers.filter(m => getEventYear(m.marriageDate) == label || getEventYear(m.engagementDate) == label);
                        }

                        if (membersList.length > 0) {
                            showChartDetailsModal(modalTitle, membersList);
                        }
                    }
                }
            };

            genderChartInstance = createChart('genderChart', {
                type: 'pie', data: genderData, options: chartOptions
            });

            maritalStatusChartInstance = createChart('maritalStatusChart', {
                type: 'pie', data: maritalStatusData, options: chartOptions
            });

            maritalStatusAliveChartInstance = createChart('maritalStatusAliveChart', {
                type: 'pie', data: maritalStatusAliveData, options: chartOptions
            });

            ageDistributionChartInstance = createChart('ageDistributionChart', {
                type: 'bar', data: ageDistributionData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });

            birthMonthChartInstance = createChart('birthMonthChart', {
                type: 'bar', data: birthMonthData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });

            familyNameChartInstance = createChart('familyNameChart', {
                type: 'bar', data: familyNameData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });

            maleMaritalStatusChartInstance = createChart('maleMaritalStatusChart', {
                type: 'pie', data: maleMaritalStatusData, options: chartOptions
            });

            femaleMaritalStatusChartInstance = createChart('femaleMaritalStatusChart', {
                type: 'pie', data: femaleMaritalStatusData, options: chartOptions
            });

            birthsPerYearChartInstance = createChart('birthsPerYearChart', {
                type: 'bar', data: birthsPerYearData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });

            deathsPerYearChartInstance = createChart('deathsPerYearChart', {
                type: 'bar', data: deathsPerYearData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });

            marriagesEngagementsPerYearChartInstance = createChart('marriagesEngagementsPerYearChart', {
                type: 'bar', data: marriagesEngagementsPerYearData, options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        // Function to handle Stat-box clicks (Drill-down)
        function showStatDetails(id, members) {
            const statBox = document.getElementById(id);
            if (statBox) {
                const title = statBox.querySelector('.label').textContent;
                showChartDetailsModal(title, members);
            }
        }

        // Function to show the modal for chart/stat details
        function showChartDetailsModal(title, membersList) {
            const modal = document.getElementById('chartDetailsModal');
            const modalTitle = document.getElementById('chartDetailsTitle');
            const detailsList = document.getElementById('chartDetailsList');

            modalTitle.textContent = title;
            detailsList.innerHTML = ''; // Clear previous content

            if (membersList && membersList.length > 0) {
                membersList.forEach(member => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="person_details.html?id=${member.id}" class="person-link" target="_blank">${member.fullName}</a>`;
                    detailsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'لا توجد بيانات متاحة.';
                detailsList.appendChild(li);
            }
            modal.style.display = 'flex';
        }

        // Close details modal
        document.getElementById('closeChartDetailsModalBtn').addEventListener('click', () => {
            document.getElementById('chartDetailsModal').style.display = 'none';
        });

        // Event listener for the filter dropdown
        familyFilterSelect.addEventListener('change', () => {
            loadAndRenderStats(allFamilyMembers);
        });

        // Function to populate family names in the filter dropdown
        function populateFamilyFilter(members) {
            const familyNames = [...new Set(members.map(m => m.familyName).filter(Boolean))].sort();
            familyFilterSelect.innerHTML = '<option value="All">الكل</option>';
            familyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                familyFilterSelect.appendChild(option);
            });
        }

        // Fetch data from Firestore
        async function fetchData() {
            showLoading();
            try {
                // IMPORTANT: Replace 'PLACEHOLDER_USER_ID' with your actual Firebase User ID (UID)
                // This is a temporary solution since login was removed.
                // For a truly public page, move your data to the public path: artifacts/${appId}/public/data/family-members
                const uid = 'PLACEHOLDER_USER_ID';
                const collectionPath = `artifacts/${appId}/users/${uid}/family-members`;

                const snapshot = await getDocs(collection(db, collectionPath));
                allFamilyMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Listen for real-time updates
                const q = query(collection(db, collectionPath));
                onSnapshot(q, (querySnapshot) => {
                    allFamilyMembers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateFamilyFilter(allFamilyMembers);
                    loadAndRenderStats(allFamilyMembers);
                    hideLoading();
                });

                // Initial load
                populateFamilyFilter(allFamilyMembers);
                loadAndRenderStats(allFamilyMembers);

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessageModal('حدث خطأ أثناء تحميل البيانات. يرجى التحقق من اتصالك، والتأكد من أن معرف المستخدم (User ID) صحيح، وأن صلاحيات الوصول للقاعدة مسموح بها.');
                hideLoading();
            }
        }

        // Event listeners for stat boxes to trigger drill-down
        document.querySelectorAll('.stat-box').forEach(box => {
            box.addEventListener('click', (e) => {
                const id = e.currentTarget.id;
                let membersToShow = [];
                switch(id) {
                    case 'statTotalMembers':
                        membersToShow = filteredMembers; break;
                    case 'statAliveMembers':
                        membersToShow = filteredMembers.filter(m => m.alive === true); break;
                    case 'statDeceasedMembers':
                        membersToShow = filteredMembers.filter(m => m.alive === false); break;
                    case 'statLivingMales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male'); break;
                    case 'statLivingFemales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female'); break;
                    case 'statLivingMarried':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.maritalStatus === 'married'); break;
                    case 'statLivingEngaged':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.maritalStatus === 'engaged'); break;
                    case 'statLivingMarriedMales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && m.maritalStatus === 'married'); break;
                    case 'statLivingMarriedFemales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && m.maritalStatus === 'married'); break;
                    case 'statLivingSingleMales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && m.maritalStatus === 'single'); break;
                    case 'statLivingDivorcedMales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && m.maritalStatus === 'divorced'); break;
                    case 'statLivingWidowedMales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && m.maritalStatus === 'widowed'); break;
                    case 'statLivingSingleFemales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && m.maritalStatus === 'single'); break;
                    case 'statLivingDivorcedFemales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && m.maritalStatus === 'divorced'); break;
                    case 'statLivingWidowedFemales':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && m.maritalStatus === 'widowed'); break;
                    case 'statMalesOver16':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && calculateAge(m.birthDate) >= 16); break;
                    case 'statFemalesOver16':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && calculateAge(m.birthDate) >= 16); break;
                    case 'statMalesUnder16':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'male' && calculateAge(m.birthDate) < 16); break;
                    case 'statFemalesUnder16':
                        membersToShow = filteredMembers.filter(m => m.alive === true && m.gender === 'female' && calculateAge(m.birthDate) < 16); break;
                    case 'statMembersWithoutChildren':
                        membersToShow = filteredMembers.filter(m => !m.children || m.children.length === 0); break;
                    case 'statMissingBirthDate':
                        membersToShow = filteredMembers.filter(m => !m.birthDate); break;
                    case 'statMissingGender':
                        membersToShow = filteredMembers.filter(m => !m.gender); break;
                    case 'statMissingFamilyName':
                        membersToShow = filteredMembers.filter(m => !m.familyName); break;
                    case 'statUniqueFamilyNames':
                        const familyNameCounts = {};
                        filteredMembers.forEach(m => {
                            if (m.familyName) {
                                familyNameCounts[m.familyName] = (familyNameCounts[m.familyName] || 0) + 1;
                            }
                        });
                        const uniqueFamilies = Object.keys(familyNameCounts);
                        const listItems = uniqueFamilies.map(name => ({ fullName: name, children: [] })); // Mock list for display
                        showChartDetailsModal('أسماء العائلات الفريدة', listItems);
                        return;
                    default:
                        // For stats that are averages or percentages, do nothing
                        return;
                }
                showStatDetails(id, membersToShow);
            });
        });


        // Event listeners for export/print buttons
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const csv = convertToCsv(filteredMembers);
            downloadFile(csv, 'family_statistics.csv', 'text/csv');
        });

        document.getElementById('exportChartsBtn').addEventListener('click', () => {
            const chartCanvases = [
                document.getElementById('genderChart'),
                document.getElementById('maritalStatusChart'),
                document.getElementById('maritalStatusAliveChart'),
                document.getElementById('ageDistributionChart'),
                document.getElementById('birthMonthChart'),
                document.getElementById('familyNameChart'),
                document.getElementById('maleMaritalStatusChart'),
                document.getElementById('femaleMaritalStatusChart'),
                document.getElementById('birthsPerYearChart'),
                document.getElementById('deathsPerYearChart'),
                document.getElementById('marriagesEngagementsPerYearChart'),
            ];

            const zip = new JSZip();
            chartCanvases.forEach((canvas, index) => {
                if (Chart.getChart(canvas.id)) {
                    const dataUrl = canvas.toDataURL('image/png');
                    const base64Data = dataUrl.split(',')[1];
                    zip.file(`chart_${index + 1}.png`, base64Data, { base64: true });
                }
            });

            zip.generateAsync({ type: 'blob' }).then(blob => {
                downloadFile(blob, 'family_charts.zip', 'application/zip');
            });
        });

        document.getElementById('printPageBtn').addEventListener('click', () => {
            window.print();
        });


        // Helper function for CSV conversion
        function convertToCsv(data) {
            const headers = [
                "ID", "الاسم الكامل", "الجنس", "تاريخ الميلاد", "تاريخ الوفاة",
                "اسم العائلة", "الحالة الاجتماعية", "تاريخ الزواج", "تاريخ الخطوبة",
                "المواليد", "الآباء", "الأمهات", "على قيد الحياة", "ملاحظات"
            ].join(',');
            const rows = data.map(member => {
                const values = [
                    member.id || '',
                    member.fullName || '',
                    member.gender || '',
                    member.birthDate || '',
                    member.deathDate || '',
                    member.familyName || '',
                    member.maritalStatus || '',
                    member.marriageDate || '',
                    member.engagementDate || '',
                    (member.children || []).map(c => c.fullName).join('; ') || '',
                    (member.fatherId || member.fatherFullName) || '',
                    (member.motherId || member.motherFullName) || '',
                    member.alive ? 'نعم' : 'لا',
                    member.notes || ''
                ].map(value => `"${value}"`).join(',');
                return values;
            });
            return [headers, ...rows].join('\n');
        }

        // Helper function to download files
        function downloadFile(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // JSZip CDN for zipping charts. This is needed for the export function.
        const jszipScript = document.createElement('script');
        jszipScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js";
        jszipScript.onload = fetchData; // Start fetching data after JSZip is loaded
        document.head.appendChild(jszipScript);
        
    </script>
</body>
</html>
